<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.hubspot.singularity.resources</span><span class="p">;</span><span class="w"></span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">com.hubspot.singularity.WebExceptions.checkBadRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import static</span><span class="w"> </span><span class="nn">com.hubspot.singularity.WebExceptions.checkConflict</span><span class="p">;</span><span class="w"></span>
<span class="kn">import static</span><span class="w"> </span><span class="nn">com.hubspot.singularity.WebExceptions.checkNotNullBadRequest</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.collect.ImmutableMap</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.collect.Lists</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.inject.Inject</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.jackson.jaxrs.PropertyFiltering</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.AgentPlacement</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.CrashLoopInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.MachineState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.RequestCleanupType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.RequestState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.RequestType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.Singularity</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityAction</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityAuthorizationScope</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityCreateResult</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityDeleteResult</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityDeploy</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityPendingDeploy</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityPendingRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityPendingRequest.PendingType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityPendingRequestParent</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityRequestBatch</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityRequestBuilder</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityRequestCleanup</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityRequestDeployState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityRequestHistory.RequestHistoryType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityRequestParent</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityRequestWithState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityShellCommand</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityTaskCleanup</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityTaskHealthcheckResult</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityTaskId</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityTransformHelpers</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityUser</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.SingularityUserFacingAction</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.TaskCleanupType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.WebExceptions</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularityBounceRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularityDeleteRequestRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularityExitCooldownRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularityPauseRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularityPriorityRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularityRunNowRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularityScaleRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularitySkipHealthchecksRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularityUnpauseRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.api.SingularityUpdateGroupsRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.auth.SingularityAuthorizer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.config.ApiPaths</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.config.SingularityConfiguration</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.data.AgentManager</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.data.DeployManager</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.data.RequestManager</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.data.SingularityValidator</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.data.TaskManager</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.expiring.SingularityExpiringBounce</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.expiring.SingularityExpiringPause</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.expiring.SingularityExpiringPriority</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.expiring.SingularityExpiringRequestActionParent</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.expiring.SingularityExpiringScale</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.expiring.SingularityExpiringSkipHealthchecks</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.helpers.RebalancingHelper</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.helpers.RequestHelper</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.mesos.SingularityAgentAndRackManager</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.sentry.SingularityExceptionNotifier</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.hubspot.singularity.smtp.SingularityMailer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.ning.http.client.AsyncHttpClient</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">edu.umd.cs.findbugs.annotations.SuppressFBWarnings</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.dropwizard.auth.Auth</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.swagger.v3.oas.annotations.Operation</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.swagger.v3.oas.annotations.Parameter</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.swagger.v3.oas.annotations.media.Schema</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.swagger.v3.oas.annotations.parameters.RequestBody</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.swagger.v3.oas.annotations.responses.ApiResponse</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.swagger.v3.oas.annotations.tags.Tag</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.swagger.v3.oas.annotations.tags.Tags</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashSet</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Set</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.UUID</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.Consumes</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.DELETE</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.GET</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.HEAD</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.POST</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.PUT</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.Path</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.PathParam</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.Produces</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.QueryParam</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.core.Context</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.core.MediaType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.ws.rs.core.Response</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.curator.framework.recipes.leader.LeaderLatch</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.Logger</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span><span class="w"></span>

<span class="nd">@Path</span><span class="p">(</span><span class="n">ApiPaths</span><span class="p">.</span><span class="na">REQUEST_RESOURCE_PATH</span><span class="p">)</span><span class="w"></span>
<span class="nd">@Produces</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="nd">@Schema</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Manages Singularity Requests, the parent object for any deployed task&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nd">@Tags</span><span class="p">({</span><span class="w"> </span><span class="nd">@Tag</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Requests&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RequestResource</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractRequestResource</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">RequestResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SingularityMailer</span><span class="w"> </span><span class="n">mailer</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TaskManager</span><span class="w"> </span><span class="n">taskManager</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RebalancingHelper</span><span class="w"> </span><span class="n">rebalancingHelper</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RequestHelper</span><span class="w"> </span><span class="n">requestHelper</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AgentManager</span><span class="w"> </span><span class="n">agentManager</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SingularityConfiguration</span><span class="w"> </span><span class="n">configuration</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SingularityExceptionNotifier</span><span class="w"> </span><span class="n">exceptionNotifier</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SingularityAgentAndRackManager</span><span class="w"> </span><span class="n">agentAndRackManager</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Inject</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">RequestResource</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityValidator</span><span class="w"> </span><span class="n">validator</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">DeployManager</span><span class="w"> </span><span class="n">deployManager</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">TaskManager</span><span class="w"> </span><span class="n">taskManager</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">RebalancingHelper</span><span class="w"> </span><span class="n">rebalancingHelper</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">RequestManager</span><span class="w"> </span><span class="n">requestManager</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityMailer</span><span class="w"> </span><span class="n">mailer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityAuthorizer</span><span class="w"> </span><span class="n">authorizationHelper</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">RequestHelper</span><span class="w"> </span><span class="n">requestHelper</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LeaderLatch</span><span class="w"> </span><span class="n">leaderLatch</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AgentManager</span><span class="w"> </span><span class="n">agentManager</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AsyncHttpClient</span><span class="w"> </span><span class="n">httpClient</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Singularity</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityConfiguration</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityExceptionNotifier</span><span class="w"> </span><span class="n">exceptionNotifier</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityAgentAndRackManager</span><span class="w"> </span><span class="n">agentAndRackManager</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">super</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">deployManager</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">validator</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">authorizationHelper</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">httpClient</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">leaderLatch</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">objectMapper</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestHelper</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">mailer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mailer</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">taskManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskManager</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">rebalancingHelper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rebalancingHelper</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">requestHelper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestHelper</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">agentManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agentManager</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">exceptionNotifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exceptionNotifier</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">agentAndRackManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agentAndRackManager</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">submitRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityRequestWithState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">RequestHistoryType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">historyType</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">skipHealthchecks</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityBounceRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeBounceRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">largeScaleDownAcknowledged</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">checkNotNullBadRequest</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Request must have an id&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">requestManager</span><span class="p">.</span><span class="na">cleanupRequestExists</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">()),</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Request %s is currently cleaning. Try again after a few moments&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityPendingDeploy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybePendingDeploy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deployManager</span><span class="p">.</span><span class="na">getPendingDeploy</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">maybePendingDeploy</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">maybePendingDeploy</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getUpdatedRequest</span><span class="p">().</span><span class="na">isPresent</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Request %s has a pending deploy that may change the request data. Try again when the deploy has finished&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">oldRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getRequest</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">SingularityRequest</span><span class="o">&gt;</span><span class="n">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorizedChanges</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">oldRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">validator</span><span class="p">.</span><span class="na">checkActionEnabled</span><span class="p">(</span><span class="n">SingularityAction</span><span class="p">.</span><span class="na">UPDATE_REQUEST</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">validator</span><span class="p">.</span><span class="na">checkActionEnabled</span><span class="p">(</span><span class="n">SingularityAction</span><span class="p">.</span><span class="na">CREATE_REQUEST</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">.</span><span class="na">getAgentPlacement</span><span class="p">().</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">getAgentPlacement</span><span class="p">().</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AgentPlacement</span><span class="p">.</span><span class="na">SPREAD_ALL_SLAVES</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">getAgentPlacement</span><span class="p">().</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AgentPlacement</span><span class="p">.</span><span class="na">SPREAD_ALL_AGENTS</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">checkBadRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">validator</span><span class="p">.</span><span class="na">isSpreadAllAgentsEnabled</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;You must enabled spread to all agents in order to use the SPREAD_ALL_AGENTS request type&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">currentActiveAgentCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agentManager</span><span class="p">.</span><span class="na">getNumObjectsAtState</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">MachineState</span><span class="p">.</span><span class="na">ACTIVE</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">toBuilder</span><span class="p">().</span><span class="na">setInstances</span><span class="p">(</span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">currentActiveAgentCount</span><span class="p">)).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">oldRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">validator</span><span class="p">.</span><span class="na">checkScale</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"> </span><span class="n">largeScaleDownAcknowledged</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">oldRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getInstancesSafe</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getInstancesSafe</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">validator</span><span class="p">.</span><span class="na">checkScale</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">oldRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getInstancesSafe</span><span class="p">()),</span><span class="w"></span>
<span class="w">        </span><span class="n">largeScaleDownAcknowledged</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">RequestState</span><span class="w"> </span><span class="n">requestState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestState</span><span class="p">.</span><span class="na">ACTIVE</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">requestState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getState</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">.</span><span class="na">getInstancesSafe</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getInstancesSafe</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Trigger cleanups for scale down</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">newInstances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getInstancesSafe</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityRequestDeployState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeDeployState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deployManager</span><span class="p">.</span><span class="na">getRequestDeployState</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">maybeDeployState</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">maybeDeployState</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getActiveDeploy</span><span class="p">().</span><span class="na">isPresent</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityTaskId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">remainingActiveTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">taskManager</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">getActiveTaskIdsForDeploy</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">maybeDeployState</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getActiveDeploy</span><span class="p">().</span><span class="na">get</span><span class="p">().</span><span class="na">getDeployId</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">taskId</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">taskId</span><span class="p">.</span><span class="na">getInstanceNo</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">newInstances</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">taskManager</span><span class="p">.</span><span class="na">createTaskCleanup</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityTaskCleanup</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()),</span><span class="w"></span>
<span class="w">                    </span><span class="n">TaskCleanupType</span><span class="p">.</span><span class="na">SCALING_DOWN</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="n">taskId</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">message</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">()),</span><span class="w"></span>
<span class="w">                    </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">()</span><span class="w"></span>
<span class="w">                  </span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">remainingActiveTasks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">taskId</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">activeRacksWithCapacityCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agentAndRackManager</span><span class="p">.</span><span class="na">getActiveRacksWithCapacityCount</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getInstancesSafe</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">activeRacksWithCapacityCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">isRackSensitive</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">configuration</span><span class="p">.</span><span class="na">isRebalanceRacksOnScaleDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">rebalancingHelper</span><span class="p">.</span><span class="na">rebalanceRacks</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">remainingActiveTasks</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getAgentAttributeMinimums</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">SingularityTaskId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cleanedTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rebalancingHelper</span><span class="p">.</span><span class="na">rebalanceAttributeDistribution</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">remainingActiveTasks</span><span class="w"></span>
<span class="w">          </span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">remainingActiveTasks</span><span class="p">.</span><span class="na">removeAll</span><span class="p">(</span><span class="n">cleanedTasks</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">oldRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getSkipHealthchecks</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">.</span><span class="na">getSkipHealthchecks</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Marking pending tasks as healthy for skipHealthchecks on {}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">taskManager</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">getActiveTaskIdsForRequest</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Will only be saved if async healthchecks have not already finished</span><span class="w"></span>
<span class="w">            </span><span class="n">taskManager</span><span class="p">.</span><span class="na">saveHealthcheckResult</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityTaskHealthcheckResult</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;Healthchecks skipped by %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">())),</span><span class="w"></span>
<span class="w">                </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="n">t</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">()</span><span class="w"></span>
<span class="w">              </span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">requestHelper</span><span class="p">.</span><span class="na">updateRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestState</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">historyType</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">skipHealthchecks</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">maybeBounceRequest</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Create or update a Singularity Request&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;400&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request object is invalid&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;409&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request object is being cleaned. Try again shortly&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">postRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Singularity request to create or update&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">request</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">postRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">postRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">submitRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">()),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">user</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getAndCheckDeployId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeDeployId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deployManager</span><span class="p">.</span><span class="na">getInUseDeployId</span><span class="p">(</span><span class="n">requestId</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">maybeDeployId</span><span class="p">.</span><span class="na">isPresent</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Can not schedule/bounce a request (%s) with no deploy&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeDeployId</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/groups&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Update the group, readOnlyGroups, and readWriteGroups for a SingularityRequest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;400&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request object is invalid&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;401&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;User is not authorized to make these updates&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">updateAuthorizedGroups</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The id of the request to update&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&quot;requestId&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Updated group settings&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityUpdateGroupsRequest</span><span class="w"> </span><span class="n">updateGroupsRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">updateGroupsRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">updateAuthorizedGroups</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">updateGroupsRequest</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">updateAuthorizedGroups</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUpdateGroupsRequest</span><span class="w"> </span><span class="n">updateGroupsRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">newRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">getRequest</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">toBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setGroup</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getGroup</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setReadWriteGroups</span><span class="p">(</span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getReadWriteGroups</span><span class="p">()))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setReadOnlyGroups</span><span class="p">(</span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getReadOnlyGroups</span><span class="p">()))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setActionPermissions</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getActionPermissions</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">submitRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">newRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">oldRequestWithState</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RequestHistoryType</span><span class="p">.</span><span class="na">UPDATED</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/groups/auth-check&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Check authorization for updating the group, readOnlyGroups, and readWriteGroups for a SingularityRequest, without committing the change&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;400&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request object is invalid&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;401&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;User is not authorized to make these updates&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="nf">checkAuthForGroupsUpdate</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The id of the request to update&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&quot;requestId&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Updated group settings&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityUpdateGroupsRequest</span><span class="w"> </span><span class="n">updateGroupsRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityRequestWithState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeOldRequestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestManager</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">maybeOldRequestWithState</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// check against dummy request with same groups if none present in zk</span><span class="w"></span>
<span class="w">      </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityRequestBuilder</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">RequestType</span><span class="p">.</span><span class="na">WORKER</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">setGroup</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getGroup</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">setReadWriteGroups</span><span class="p">(</span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getReadWriteGroups</span><span class="p">()))</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">setReadOnlyGroups</span><span class="p">(</span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getReadOnlyGroups</span><span class="p">()))</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">setActionPermissions</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getActionPermissions</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">build</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">ok</span><span class="p">().</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maybeOldRequestWithState</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">newRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">getRequest</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">toBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setGroup</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getGroup</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setReadWriteGroups</span><span class="p">(</span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getReadWriteGroups</span><span class="p">()))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setReadOnlyGroups</span><span class="p">(</span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getReadOnlyGroups</span><span class="p">()))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setActionPermissions</span><span class="p">(</span><span class="n">updateGroupsRequest</span><span class="p">.</span><span class="na">getActionPermissions</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorizedChanges</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">newRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">ok</span><span class="p">().</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/bounce&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Trigger a bounce for a request&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@SuppressFBWarnings</span><span class="p">(</span><span class="s">&quot;NP_NULL_PARAM_DEREF_ALL_TARGETS_DANGEROUS&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">bounce</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The request to bounce&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bounce</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/bounce&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bounce a specific Singularity request. A bounce launches replacement task(s), and then kills the original task(s) if the replacement(s) are healthy&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">bounce</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The request ID to bounce&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bounce request options&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityBounceRequest</span><span class="w"> </span><span class="n">bounceRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityBounceRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeBounceRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">bounceRequest</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">maybeBounceRequest</span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">bounce</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">maybeBounceRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">bounce</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityBounceRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bounceRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityUserFacingAction</span><span class="p">.</span><span class="na">BOUNCE</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">validator</span><span class="p">.</span><span class="na">checkActionEnabled</span><span class="p">(</span><span class="n">SingularityAction</span><span class="p">.</span><span class="na">BOUNCE_REQUEST</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkBadRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">isLongRunning</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Can not bounce a %s request (%s)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getRequestType</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RequestState</span><span class="p">.</span><span class="na">PAUSED</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Request %s is paused. Unable to bounce (it must be manually unpaused first)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isIncrementalBounce</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getIncremental</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">validator</span><span class="p">.</span><span class="na">checkResourcesForBounce</span><span class="p">(</span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"> </span><span class="n">isIncrementalBounce</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">validator</span><span class="p">.</span><span class="na">checkRequestForPriorityFreeze</span><span class="p">(</span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">skipHealthchecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getSkipHealthchecks</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityShellCommand</span><span class="o">&gt;</span><span class="w"> </span><span class="n">runBeforeKill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getActionId</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getMessage</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getRunShellCommandBeforeKill</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">validator</span><span class="p">.</span><span class="na">checkValidShellCommand</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getRunShellCommandBeforeKill</span><span class="p">().</span><span class="na">get</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">runBeforeKill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getRunShellCommandBeforeKill</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">actionId</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deployId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getAndCheckDeployId</span><span class="p">(</span><span class="n">requestId</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="p">(</span><span class="n">requestManager</span><span class="p">.</span><span class="na">markAsBouncing</span><span class="p">(</span><span class="n">requestId</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SingularityCreateResult</span><span class="p">.</span><span class="na">EXISTED</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;%s is already bouncing&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">requestManager</span><span class="p">.</span><span class="na">createCleanupRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityRequestCleanup</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">isIncrementalBounce</span><span class="w"></span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="n">RequestCleanupType</span><span class="p">.</span><span class="na">INCREMENTAL_BOUNCE</span><span class="w"></span>
<span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="n">RequestCleanupType</span><span class="p">.</span><span class="na">BOUNCE</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">deployId</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">skipHealthchecks</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">message</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">actionId</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">runBeforeKill</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">requestManager</span><span class="p">.</span><span class="na">bounce</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()),</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">SingularityBounceRequest</span><span class="w"> </span><span class="n">validatedBounceRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validator</span><span class="p">.</span><span class="na">checkBounceRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">bounceRequest</span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="n">SingularityBounceRequest</span><span class="p">.</span><span class="na">defaultRequest</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">requestManager</span><span class="p">.</span><span class="na">saveExpiringObject</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityExpiringBounce</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">deployId</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()),</span><span class="w"></span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">validatedBounceRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">actionId</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">requestWithState</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/run&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Schedule a one-off or scheduled Singularity request for immediate or delayed execution&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;400&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Singularity Request is not scheduled or one-off&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityPendingRequestParent</span><span class="w"> </span><span class="nf">scheduleImmediately</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The request ID to run&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;minimal&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">minimalReturn</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Settings specific to this run of the request&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityRunNowRequest</span><span class="w"> </span><span class="n">runNowRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runNowRequest</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">runNowRequest</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">getEnvOverrides</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">checkBadRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">!</span><span class="n">k</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;STARTED_BY_USER&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">v</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;STARTED_BY_USER&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;Cannot override STARTED_BY_USER in env&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">checkBadRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">runNowRequest</span><span class="p">.</span><span class="na">getCommandLineArgs</span><span class="p">().</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">runNowRequest</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">getCommandLineArgs</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">arg</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;STARTED_BY_USER&quot;</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Cannot override STARTED_BY_USER&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runNowRequest</span><span class="p">.</span><span class="na">getResources</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeDeployId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deployManager</span><span class="p">.</span><span class="na">getActiveDeployId</span><span class="p">(</span><span class="n">requestId</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maybeDeployId</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityDeploy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeDeploy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deployManager</span><span class="p">.</span><span class="na">getDeploy</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">maybeDeployId</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maybeDeploy</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">maybeDeploy</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getResources</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">deployPorts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maybeDeploy</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getResources</span><span class="p">().</span><span class="na">get</span><span class="p">().</span><span class="na">getNumPorts</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">runNowPorts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runNowRequest</span><span class="p">.</span><span class="na">getResources</span><span class="p">().</span><span class="na">get</span><span class="p">().</span><span class="na">getNumPorts</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">checkBadRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">deployPorts</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">runNowPorts</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;Number of ports in resource overrides must be &gt;= the amount specified in the Singularity deploy (deploy: %d, runNowRequest: %d)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">deployPorts</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">runNowPorts</span><span class="w"></span>
<span class="w">            </span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityPendingRequestParent</span><span class="w"> </span><span class="n">response</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">configuration</span><span class="p">.</span><span class="na">isProxyRunNowToLeader</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">SingularityPendingRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">runNowRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"></span>
<span class="w">            </span><span class="n">scheduleImmediately</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">runNowRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">minimalReturn</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">scheduleImmediately</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">runNowRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">minimalReturn</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">LOG</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;Enqueue for {} took {}ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">15000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">exceptionNotifier</span><span class="p">.</span><span class="na">notify</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;Slow enqueue for %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ImmutableMap</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;leader&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">Boolean</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">isLeader</span><span class="p">()),</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;duration&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">Long</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityPendingRequestParent</span><span class="w"> </span><span class="nf">scheduleImmediately</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRunNowRequest</span><span class="w"> </span><span class="n">runNowRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">scheduleImmediately</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">runNowRequest</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityPendingRequestParent</span><span class="w"> </span><span class="nf">scheduleImmediately</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRunNowRequest</span><span class="w"> </span><span class="n">runNowRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">minimalReturn</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityRunNowRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeRunNowRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">runNowRequest</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityUserFacingAction</span><span class="p">.</span><span class="na">EXEC</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RequestState</span><span class="p">.</span><span class="na">PAUSED</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Request %s is paused. Unable to run now (it must be manually unpaused first)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Check these to avoid unnecessary calls to taskManager</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">activeTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pendingTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isOneoffWithInstances</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">isOneOff</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getInstances</span><span class="p">().</span><span class="na">isPresent</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">isScheduled</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isOneoffWithInstances</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">activeTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskManager</span><span class="p">.</span><span class="na">getActiveTaskIdsForRequest</span><span class="p">(</span><span class="n">requestId</span><span class="p">).</span><span class="na">size</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOneoffWithInstances</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">pendingTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskManager</span><span class="p">.</span><span class="na">getPendingTaskIdsForRequest</span><span class="p">(</span><span class="n">requestId</span><span class="p">).</span><span class="na">size</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">SingularityPendingRequest</span><span class="w"> </span><span class="n">pendingRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validator</span><span class="p">.</span><span class="na">checkRunNowRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">getAndCheckDeployId</span><span class="p">(</span><span class="n">requestId</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">maybeRunNowRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">activeTasks</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">pendingTasks</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityCreateResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestManager</span><span class="p">.</span><span class="na">addToPendingQueue</span><span class="p">(</span><span class="n">pendingRequest</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SingularityCreateResult</span><span class="p">.</span><span class="na">EXISTED</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;%s is already pending, please try again soon&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">minimalReturn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">SingularityPendingRequestParent</span><span class="p">.</span><span class="na">minimalFromRequestWithState</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">requestWithState</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">pendingRequest</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">SingularityPendingRequestParent</span><span class="p">.</span><span class="na">fromSingularityRequestParent</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">requestWithState</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">pendingRequest</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/run/{runId}&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve an active task by runId&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;A task with the specified runID was not found&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityTaskId</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getTaskByRunId</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Id of the request&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Run id to search for&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;runId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">runId</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">taskManager</span><span class="p">.</span><span class="na">getTaskByRunId</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">runId</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/pause&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Pause a Singularity request, future tasks will not run until it is manually unpaused. API can optionally choose to kill existing tasks&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;409&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request is already paused or being cleaned&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@SuppressFBWarnings</span><span class="p">(</span><span class="s">&quot;NP_NULL_PARAM_DEREF_ALL_TARGETS_DANGEROUS&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">pause</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The request ID to pause&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pause</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/pause&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Pause a Singularity request, future tasks will not run until it is manually unpaused. API can optionally choose to kill existing tasks&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;409&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request is already paused or being cleaned&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">pause</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The request ID to pause&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Pause Request Options&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityPauseRequest</span><span class="w"> </span><span class="n">pauseRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityPauseRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybePauseRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">pauseRequest</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">maybePauseRequest</span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">pause</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">maybePauseRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">pause</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityPauseRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pauseRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityUserFacingAction</span><span class="p">.</span><span class="na">PAUSE</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RequestState</span><span class="p">.</span><span class="na">PAUSED</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Request %s is paused. Unable to pause (it must be manually unpaused first)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">killTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityShellCommand</span><span class="o">&gt;</span><span class="w"> </span><span class="n">runBeforeKill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">killTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getKillTasks</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getMessage</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getRunShellCommandBeforeKill</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">validator</span><span class="p">.</span><span class="na">checkValidShellCommand</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getRunShellCommandBeforeKill</span><span class="p">().</span><span class="na">get</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">runBeforeKill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getRunShellCommandBeforeKill</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getDurationMillis</span><span class="p">().</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">actionId</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">removeFromLoadBalancer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityCreateResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestManager</span><span class="p">.</span><span class="na">createCleanupRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityRequestCleanup</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">RequestCleanupType</span><span class="p">.</span><span class="na">PAUSING</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">now</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">killTasks</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">removeFromLoadBalancer</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="n">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">message</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">actionId</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">runBeforeKill</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SingularityCreateResult</span><span class="p">.</span><span class="na">CREATED</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;%s is already pausing - try again soon&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">result</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">mailer</span><span class="p">.</span><span class="na">sendRequestPausedMail</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">pauseRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">requestManager</span><span class="p">.</span><span class="na">pause</span><span class="p">(</span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"> </span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getDurationMillis</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">saveExpiringObject</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityExpiringPause</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">pauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">actionId</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityRequestWithState</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">RequestState</span><span class="p">.</span><span class="na">PAUSED</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">now</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/unpause&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@SuppressFBWarnings</span><span class="p">(</span><span class="s">&quot;NP_NULL_PARAM_DEREF_ALL_TARGETS_DANGEROUS&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">unpauseNoBody</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&quot;requestId&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">unpause</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/unpause&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Unpause a Singularity Request, scheduling new tasks immediately&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;409&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request is not paused&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">unpause</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The request ID to unpause&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Settings for how the unpause should behave&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityUnpauseRequest</span><span class="w"> </span><span class="n">unpauseRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityUnpauseRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeUnpauseRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">unpauseRequest</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">maybeUnpauseRequest</span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">unpause</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">maybeUnpauseRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">unpause</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityUnpauseRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">unpauseRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityUserFacingAction</span><span class="p">.</span><span class="na">PAUSE</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RequestState</span><span class="p">.</span><span class="na">PAUSED</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Request %s is not in PAUSED state, it is in %s&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">skipHealthchecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unpauseRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unpauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getMessage</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">skipHealthchecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unpauseRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getSkipHealthchecks</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">requestManager</span><span class="p">.</span><span class="na">deleteExpiringObject</span><span class="p">(</span><span class="n">SingularityExpiringPause</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestHelper</span><span class="p">.</span><span class="na">unpause</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()),</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">skipHealthchecks</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityRequestWithState</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">RequestState</span><span class="p">.</span><span class="na">ACTIVE</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">now</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/exit-cooldown&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Immediately exits cooldown, scheduling new tasks immediately&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@SuppressFBWarnings</span><span class="p">(</span><span class="s">&quot;NP_NULL_PARAM_DEREF_ALL_TARGETS_DANGEROUS&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">exitCooldown</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The request to operate on&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">exitCooldown</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@POST</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/exit-cooldown&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Immediately exits cooldown, scheduling new tasks immediately&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;409&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request is not in cooldown&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">exitCooldown</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The request to operate on&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Settings related to how an exit cooldown should behave&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityExitCooldownRequest</span><span class="w"> </span><span class="n">exitCooldownRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityExitCooldownRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeExitCooldownRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">exitCooldownRequest</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">maybeExitCooldownRequest</span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">exitCooldown</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">maybeExitCooldownRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">exitCooldown</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityExitCooldownRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">exitCooldownRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RequestState</span><span class="p">.</span><span class="na">SYSTEM_COOLDOWN</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Request %s is not in SYSTEM_COOLDOWN state, it is in %s&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeDeployId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deployManager</span><span class="p">.</span><span class="na">getInUseDeployId</span><span class="p">(</span><span class="n">requestId</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">skipHealthchecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCooldownRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exitCooldownRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getMessage</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">skipHealthchecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exitCooldownRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getSkipHealthchecks</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">requestManager</span><span class="p">.</span><span class="na">exitCooldown</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">now</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()),</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maybeDeployId</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">isOneOff</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">addToPendingQueue</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityPendingRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">maybeDeployId</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">now</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()),</span><span class="w"></span>
<span class="w">          </span><span class="n">PendingType</span><span class="p">.</span><span class="na">IMMEDIATE</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">skipHealthchecks</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">requestWithState</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/batch&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve a specific batch of requests&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestBatch</span><span class="w"> </span><span class="nf">getRequestsBatch</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;List of request ids to fetch&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;id&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ids</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityRequestParent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filterAutorized</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">requestManager</span><span class="p">.</span><span class="na">getRequests</span><span class="p">(</span><span class="n">ids</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">fillEntireRequest</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">notFound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">ids</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">found</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">notFound</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getId</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityRequestBatch</span><span class="p">(</span><span class="n">found</span><span class="p">,</span><span class="w"> </span><span class="n">notFound</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@PropertyFiltering</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/active&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve the list of active requests&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityRequestParent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getActiveRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only include requests that the user has operated on or is in a group for&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;filterRelevantForUser&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">filterRelevantForUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Return full data, including deploy data and active task ids&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;includeFullRequestData&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">includeFullRequestData</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The maximum number of results to return&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;limit&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only return requests of these types&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestType&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">RequestType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestTypes</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">requestHelper</span><span class="p">.</span><span class="na">fillDataForRequestsAndFilter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">filterAutorized</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">requestManager</span><span class="p">.</span><span class="na">getActiveRequests</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">))),</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">filterRelevantForUser</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">includeFullRequestData</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">limit</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">requestTypes</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/ids&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve the list of all request ids&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllRequestIds</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Filter to request ids that match this string (case insensitive)&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;requestIdLike&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestIdLike</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Filter by request state&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;state&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">RequestState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">states</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filterAutorized</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">requestManager</span><span class="p">.</span><span class="na">getRequests</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">))),</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">states</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">states</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">states</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">getState</span><span class="p">()))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getId</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requestIdLike</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">allIds</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">lowerCase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestIdLike</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">allIds</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">id</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">().</span><span class="na">startsWith</span><span class="p">(</span><span class="n">lowerCase</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/ids/active&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve the list of active request ids&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getActiveRequestIds</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">filterAutorized</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">requestManager</span><span class="p">.</span><span class="na">getActiveRequests</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">))),</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getId</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@PropertyFiltering</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/paused&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve the list of paused requests&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityRequestParent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPausedRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only include requests that the user has operated on or is in a group for&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;filterRelevantForUser&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">filterRelevantForUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Return full data, including deploy data and active task ids&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;includeFullRequestData&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">includeFullRequestData</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The maximum number of results to return&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;limit&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only return requests of these types&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestType&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">RequestType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestTypes</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">requestHelper</span><span class="p">.</span><span class="na">fillDataForRequestsAndFilter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">filterAutorized</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">requestManager</span><span class="p">.</span><span class="na">getPausedRequests</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">))),</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">filterRelevantForUser</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">includeFullRequestData</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">limit</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">requestTypes</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@PropertyFiltering</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/cooldown&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve the list of requests in system cooldown&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityRequestParent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getCooldownRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only include requests that the user has operated on or is in a group for&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;filterRelevantForUser&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">filterRelevantForUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Return full data, including deploy data and active task ids&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;includeFullRequestData&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">includeFullRequestData</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The maximum number of results to return&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;limit&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only return requests of these types&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestType&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">RequestType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestTypes</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">requestHelper</span><span class="p">.</span><span class="na">fillDataForRequestsAndFilter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">filterAutorized</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">requestManager</span><span class="p">.</span><span class="na">getCooldownRequests</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">))),</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">filterRelevantForUser</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">includeFullRequestData</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">limit</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">requestTypes</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@PropertyFiltering</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/finished&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retreive the list of finished requests (Scheduled requests which have exhausted their schedules)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityRequestParent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getFinishedRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;filterRelevantForUser&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">filterRelevantForUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;includeFullRequestData&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">includeFullRequestData</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;limit&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;requestType&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">RequestType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestTypes</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">requestHelper</span><span class="p">.</span><span class="na">fillDataForRequestsAndFilter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">filterAutorized</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">requestManager</span><span class="p">.</span><span class="na">getFinishedRequests</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">))),</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">filterRelevantForUser</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">includeFullRequestData</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">limit</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">requestTypes</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@PropertyFiltering</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve the list of all requests&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityRequestParent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only include requests that the user has operated on or is in a group for&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;filterRelevantForUser&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">filterRelevantForUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Return full data, including deploy data and active task ids&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;includeFullRequestData&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">includeFullRequestData</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The maximum number of results to return&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;limit&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only return requests of these types&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestType&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">RequestType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestTypes</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Skip the cache sitting in front of this request&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;skipCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">skipCache</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">requestHelper</span><span class="p">.</span><span class="na">fillDataForRequestsAndFilter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">filterAutorized</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">requestManager</span><span class="p">.</span><span class="na">getRequests</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">),</span><span class="w"> </span><span class="n">skipCache</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">filterRelevantForUser</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">valueOrFalse</span><span class="p">(</span><span class="n">includeFullRequestData</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">limit</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">requestTypes</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">skipCache</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">valueOrFalse</span><span class="p">(</span><span class="n">Boolean</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityRequestWithState</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">filterAutorized</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityRequestWithState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requests</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">SingularityAuthorizationScope</span><span class="w"> </span><span class="n">scope</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">hasAdminAuthorization</span><span class="p">(</span><span class="n">user</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">requests</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">parent</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"></span>
<span class="w">            </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">isAuthorizedForRequest</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">scope</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">requests</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@PropertyFiltering</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/queued/pending&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve the list of pending requests&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityPendingRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPendingRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">filterByAuthorizedRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">getPendingRequests</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityTransformHelpers</span><span class="p">.</span><span class="na">PENDING_REQUEST_TO_REQUEST_ID</span><span class="p">::</span><span class="n">apply</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@PropertyFiltering</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/queued/cleanup&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve the list of requests being cleaned up&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SingularityRequestCleanup</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getCleanupRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">filterByAuthorizedRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">getCleanupRequests</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityTransformHelpers</span><span class="p">.</span><span class="na">REQUEST_CLEANUP_TO_REQUEST_ID</span><span class="p">::</span><span class="n">apply</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve a specific Request by ID&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request with that ID&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">getRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request ID&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Skip the cache sitting in front of this request&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;skipCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">skipCache</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">),</span><span class="w"> </span><span class="n">skipCache</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">getRequest</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/simple&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve a specific Request by ID without additional deploy/task information&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request with that ID&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="nf">getRequestSimple</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request ID&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">),</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@DELETE</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Delete a specific Request by ID and return the deleted Request&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request with that ID&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="nf">deleteRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The request ID to delete&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Delete options&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityDeleteRequestRequest</span><span class="w"> </span><span class="n">deleteRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityDeleteRequestRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">maybeDeleteRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">deleteRequest</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequest</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">maybeDeleteRequest</span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">deleteRequest</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">maybeDeleteRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="nf">deleteRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityDeleteRequestRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deleteRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">).</span><span class="na">getRequest</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">validator</span><span class="p">.</span><span class="na">checkActionEnabled</span><span class="p">(</span><span class="n">SingularityAction</span><span class="p">.</span><span class="na">REMOVE_REQUEST</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deleteFromLoadBalancer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deleteRequest</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deleteRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getActionId</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deleteRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getMessage</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">deleteFromLoadBalancer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deleteRequest</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getDeleteFromLoadBalancer</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">requestManager</span><span class="p">.</span><span class="na">startDeletingRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">deleteFromLoadBalancer</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">actionId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">mailer</span><span class="p">.</span><span class="na">sendRequestRemovedMail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()),</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">request</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@PUT</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/priority&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Set the task scheduling priority for the request&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request with that ID&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">setPriority</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID to modify priority for&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&quot;requestId&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Request priority (0.0 to 1.0)&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityPriorityRequest</span><span class="w"> </span><span class="n">priorityRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">priorityRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">setPriority</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">priorityRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@DELETE</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/priority&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Delete/cancel the expiring request priority change. This makes the request priority change permanent&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request or expiring priority change for that ID&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">deleteExpiringPriority</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">deleteExpiringObject</span><span class="p">(</span><span class="n">SingularityExpiringPriority</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">setPriority</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityPriorityRequest</span><span class="w"> </span><span class="n">priorityRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">oldRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkAdminAuthorization</span><span class="p">(</span><span class="n">user</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">validator</span><span class="p">.</span><span class="na">checkActionEnabled</span><span class="p">(</span><span class="n">SingularityAction</span><span class="p">.</span><span class="na">PRIORITY_REQUEST</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">newRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequest</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">toBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setTaskPriorityLevel</span><span class="p">(</span><span class="n">priorityRequest</span><span class="p">.</span><span class="na">getPriority</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Scaling from %s -&gt; %s&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">getTaskPriorityLevel</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">newRequest</span><span class="p">.</span><span class="na">getTaskPriorityLevel</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">priorityRequest</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s -- %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">priorityRequest</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">get</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">submitRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">newRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">oldRequestWithState</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RequestHistoryType</span><span class="p">.</span><span class="na">UPDATED</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">message</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">priorityRequest</span><span class="p">.</span><span class="na">getDurationMillis</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">saveExpiringObject</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityExpiringPriority</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">priorityRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">getTaskPriorityLevel</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">priorityRequest</span><span class="p">.</span><span class="na">getActionId</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">deleteExpiringObject</span><span class="p">(</span><span class="n">SingularityExpiringPriority</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// TODO - email</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@PUT</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/scale&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Scale the number of instances up or down for a specific Request&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request with that ID&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID to scale&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Object to hold number of instances to request&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularityScaleRequest</span><span class="w"> </span><span class="n">scaleRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;largeScaleDownAcknowledged&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">largeScaleDownAcknowledged</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">scaleRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">scale</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">scaleRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">largeScaleDownAcknowledged</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityScaleRequest</span><span class="w"> </span><span class="n">scaleRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">scale</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">scaleRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityScaleRequest</span><span class="w"> </span><span class="n">scaleRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">largeScaleDownAcknowledged</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">oldRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">WRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityUserFacingAction</span><span class="p">.</span><span class="na">SCALE</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">validator</span><span class="p">.</span><span class="na">checkActionEnabled</span><span class="p">(</span><span class="n">SingularityAction</span><span class="p">.</span><span class="na">SCALE_REQUEST</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">newRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequest</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">toBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setInstances</span><span class="p">(</span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getInstances</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">validator</span><span class="p">.</span><span class="na">checkScale</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">newRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">getInstances</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">largeScaleDownAcknowledged</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">checkBadRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">getInstancesSafe</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">newRequest</span><span class="p">.</span><span class="na">getInstancesSafe</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Scale request has no affect on the # of instances (%s)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">newRequest</span><span class="p">.</span><span class="na">getInstancesSafe</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">scaleMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;Scaling from %d -&gt; %d&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">getInstancesSafe</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">newRequest</span><span class="p">.</span><span class="na">getInstancesSafe</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">scaleMessage</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s -- %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">get</span><span class="p">(),</span><span class="w"> </span><span class="n">scaleMessage</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">scaleMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">scaleMessage</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getBounce</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">newRequest</span><span class="p">.</span><span class="na">getBounceAfterScale</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="kc">false</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">validator</span><span class="p">.</span><span class="na">checkActionEnabled</span><span class="p">(</span><span class="n">SingularityAction</span><span class="p">.</span><span class="na">BOUNCE_REQUEST</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">checkBadRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">newRequest</span><span class="p">.</span><span class="na">isLongRunning</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Can not bounce a %s request (%s)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">newRequest</span><span class="p">.</span><span class="na">getRequestType</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">newRequest</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RequestState</span><span class="p">.</span><span class="na">PAUSED</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Request %s is paused. Unable to bounce (it must be manually unpaused first)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">newRequest</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">checkConflict</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">requestManager</span><span class="p">.</span><span class="na">cleanupRequestExists</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">newRequest</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">RequestCleanupType</span><span class="p">.</span><span class="na">BOUNCE</span><span class="w"></span>
<span class="w">        </span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Request %s is already bouncing cannot bounce again&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">newRequest</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isIncrementalBounce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getIncremental</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">validator</span><span class="p">.</span><span class="na">checkResourcesForBounce</span><span class="p">(</span><span class="n">newRequest</span><span class="p">,</span><span class="w"> </span><span class="n">isIncrementalBounce</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">validator</span><span class="p">.</span><span class="na">checkRequestForPriorityFreeze</span><span class="p">(</span><span class="n">newRequest</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">SingularityBounceRequest</span><span class="w"> </span><span class="n">bounceRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityBounceRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">isIncrementalBounce</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getSkipHealthchecks</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="n">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">()),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="n">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">SingularityShellCommand</span><span class="o">&gt;</span><span class="n">empty</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">submitRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">newRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">oldRequestWithState</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RequestHistoryType</span><span class="p">.</span><span class="na">SCALED</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getSkipHealthchecks</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">scaleMessage</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">bounceRequest</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">largeScaleDownAcknowledged</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">submitRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">newRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">oldRequestWithState</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RequestHistoryType</span><span class="p">.</span><span class="na">SCALED</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getSkipHealthchecks</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">scaleMessage</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">largeScaleDownAcknowledged</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getDurationMillis</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">saveExpiringObject</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityExpiringScale</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">scaleRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">getInstances</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getActionId</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">()),</span><span class="w"></span>
<span class="w">          </span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getBounce</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">deleteExpiringObject</span><span class="p">(</span><span class="n">SingularityExpiringScale</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getSkipEmailNotification</span><span class="p">().</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">scaleRequest</span><span class="p">.</span><span class="na">getSkipEmailNotification</span><span class="p">().</span><span class="na">get</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">mailer</span><span class="p">.</span><span class="na">sendRequestScaledMail</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">newRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">scaleRequest</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">getInstances</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">SingularityExpiringRequestActionParent</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">deleteExpiringObject</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityDeleteResult</span><span class="w"> </span><span class="n">deleteResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestManager</span><span class="p">.</span><span class="na">deleteExpiringObject</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">clazz</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">WebExceptions</span><span class="p">.</span><span class="na">checkNotFound</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">deleteResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SingularityDeleteResult</span><span class="p">.</span><span class="na">DELETED</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;%s didn&#39;t have an expiring %s request&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">clazz</span><span class="p">.</span><span class="na">getSimpleName</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">requestWithState</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@DELETE</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/scale&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Delete/cancel the expiring scale. This makes the scale request permanent&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request or expiring scale request for that ID&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">deleteExpiringScale</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">deleteExpiringObject</span><span class="p">(</span><span class="n">SingularityExpiringScale</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Deprecated</span><span class="w"></span>
<span class="w">  </span><span class="nd">@DELETE</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/skipHealthchecks&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Delete/cancel the expiring skipHealthchecks. This makes the skipHealthchecks request permanent&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request or expiring skipHealthchecks request for that ID&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">deleteExpiringSkipHealthchecksDeprecated</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">deleteExpiringSkipHealthchecks</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@DELETE</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/skip-healthchecks&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Delete/cancel the expiring skipHealthchecks. This makes the skipHealthchecks request permanent&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request or expiring skipHealthchecks request for that ID&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">deleteExpiringSkipHealthchecks</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">deleteExpiringObject</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityExpiringSkipHealthchecks</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@DELETE</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/pause&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Delete/cancel the expiring pause. This makes the pause request permanent&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request or expiring pause request for that ID&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">deleteExpiringPause</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">deleteExpiringObject</span><span class="p">(</span><span class="n">SingularityExpiringPause</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@DELETE</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/bounce&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Delete/cancel the expiring bounce. This makes the bounce request permanent&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request or expiring bounce request for that ID&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">deleteExpiringBounce</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">deleteExpiringObject</span><span class="p">(</span><span class="n">SingularityExpiringBounce</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Deprecated</span><span class="w"></span>
<span class="w">  </span><span class="nd">@PUT</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/skipHealthchecks&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Update the skipHealthchecks field for the request, possibly temporarily&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request with that ID&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">skipHealthchecksDeprecated</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID to scale&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SkipHealtchecks options&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularitySkipHealthchecksRequest</span><span class="w"> </span><span class="n">skipHealthchecksRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">skipHealthchecks</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"> </span><span class="n">skipHealthchecksRequest</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@PUT</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/skip-healthchecks&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">({</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Update the skipHealthchecks field for the request, possibly temporarily&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">responses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@ApiResponse</span><span class="p">(</span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Request with that ID&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">skipHealthchecks</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID to skip healthchecks for&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&quot;requestId&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@RequestBody</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SkipHealtchecks options&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">SingularitySkipHealthchecksRequest</span><span class="w"> </span><span class="n">skipHealthchecksRequest</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">maybeProxyToLeader</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestContext</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityRequestParent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">skipHealthchecksRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">skipHealthchecks</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">skipHealthchecksRequest</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SingularityRequestParent</span><span class="w"> </span><span class="nf">skipHealthchecks</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularitySkipHealthchecksRequest</span><span class="w"> </span><span class="n">skipHealthchecksRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">oldRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">SingularityRequest</span><span class="w"> </span><span class="n">newRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldRequest</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">toBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setSkipHealthchecks</span><span class="p">(</span><span class="n">skipHealthchecksRequest</span><span class="p">.</span><span class="na">getSkipHealthchecks</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">submitRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">newRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">oldRequestWithState</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">skipHealthchecksRequest</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skipHealthchecksRequest</span><span class="p">.</span><span class="na">getDurationMillis</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">saveExpiringObject</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">SingularityExpiringSkipHealthchecks</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">skipHealthchecksRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">oldRequest</span><span class="p">.</span><span class="na">getSkipHealthchecks</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">skipHealthchecksRequest</span><span class="p">.</span><span class="na">getActionId</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fillEntireRequest</span><span class="p">(</span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@PropertyFiltering</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/lbcleanup&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve the list of tasks being cleaned from load balancers.&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getLbCleanupRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">filterAuthorizedRequestIds</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">requestManager</span><span class="p">.</span><span class="na">getLbCleanupRequestIds</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">useWebCache</span><span class="p">(</span><span class="n">useWebCache</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/crashloops&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve a map of all open crash loop details for all requests&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CrashLoopInfo</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getAllCrashLoops</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">authorizationHelper</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">filterByAuthorizedRequests</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">requestManager</span><span class="p">.</span><span class="na">getAllCrashLoops</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">CrashLoopInfo</span><span class="p">::</span><span class="n">getRequestId</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">groupingBy</span><span class="p">(</span><span class="n">CrashLoopInfo</span><span class="p">::</span><span class="n">getRequestId</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@GET</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}/crashloops&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Retrieve a map of all open crash loop details for all requests&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CrashLoopInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getCrashLoopsForRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID to fetch crash loops for&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&quot;requestId&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">SingularityRequestWithState</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRequestWithState</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">authorizationHelper</span><span class="p">.</span><span class="na">checkForAuthorization</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestWithState</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">SingularityAuthorizationScope</span><span class="p">.</span><span class="na">READ</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">requestManager</span><span class="p">.</span><span class="na">getCrashLoopsForRequest</span><span class="p">(</span><span class="n">requestId</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@HEAD</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/request/{requestId}&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nd">@Operation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Check if a request of specific ID exists and get the hash code of the SingularityRequest object&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="nf">headRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">hidden</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="nd">@Auth</span><span class="w"> </span><span class="n">SingularityUser</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The Request ID to check&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;requestId&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Parameter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Fetched a cached version of this data to limit expensive operations&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&quot;useWebCache&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">useWebCache</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">SingularityRequestWithState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestManager</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">requestId</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">useWebCache</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">requestWithState</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">ok</span><span class="p">().</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;ETag&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">hashCode</span><span class="p">()).</span><span class="na">build</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</body>
</html>
