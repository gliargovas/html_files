<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span class="cm"> * or more contributor license agreements.  See the NOTICE file</span>
<span class="cm"> * distributed with this work for additional information</span>
<span class="cm"> * regarding copyright ownership.  The ASF licenses this file</span>
<span class="cm"> * to you under the Apache License, Version 2.0 (the</span>
<span class="cm"> * &quot;License&quot;); you may not use this file except in compliance</span>
<span class="cm"> * with the License.  You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *   https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing,</span>
<span class="cm"> * software distributed under the License is distributed on an</span>
<span class="cm"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span class="cm"> * KIND, either express or implied.  See the License for the</span>
<span class="cm"> * specific language governing permissions and limitations</span>
<span class="cm"> * under the License.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kn">package</span><span class="w"> </span><span class="nn">org.apache.accumulo.manager</span><span class="p">;</span><span class="w"></span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">java.nio.charset.StandardCharsets.UTF_8</span><span class="p">;</span><span class="w"></span>
<span class="kn">import static</span><span class="w"> </span><span class="nn">java.util.Collections.emptySortedMap</span><span class="p">;</span><span class="w"></span>
<span class="kn">import static</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.util.UtilWaitThread.sleepUninterruptibly</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationTargetException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.net.UnknownHostException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collections</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashSet</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Iterator</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map.Entry</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Set</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.SortedMap</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.TreeMap</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.UUID</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentSkipListMap</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CountDownLatch</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ExecutionException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ExecutorService</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.Future</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ScheduledFuture</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicBoolean</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicReference</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.Constants</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.client.AccumuloClient</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.client.Scanner</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.client.TableNotFoundException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.clientImpl.thrift.TableOperation</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.clientImpl.thrift.TableOperationExceptionType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.clientImpl.thrift.ThriftTableOperationException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.conf.AccumuloConfiguration</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.conf.Property</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.data.InstanceId</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.data.Key</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.data.TableId</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.data.Value</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.dataImpl.KeyExtent</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.fate.AgeOffStore</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.fate.Fate</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.fate.zookeeper.ServiceLock</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.fate.zookeeper.ServiceLock.LockLossReason</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.fate.zookeeper.ServiceLock.ServiceLockPath</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.fate.zookeeper.ZooReaderWriter</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.fate.zookeeper.ZooUtil</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.fate.zookeeper.ZooUtil.NodeExistsPolicy</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.fate.zookeeper.ZooUtil.NodeMissingPolicy</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.manager.balancer.AssignmentParamsImpl</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.manager.balancer.BalanceParamsImpl</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.manager.balancer.TServerStatusImpl</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.manager.balancer.TabletServerIdImpl</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.manager.state.tables.TableState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.manager.thrift.ManagerClientService</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.manager.thrift.ManagerGoalState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.manager.thrift.ManagerMonitorInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.manager.thrift.ManagerState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.master.thrift.BulkImportState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.master.thrift.TableInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.master.thrift.TabletServerStatus</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.metadata.MetadataTable</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.metadata.RootTable</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.metadata.TServerInstance</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.metadata.TabletLocationState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.metadata.TabletState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.metadata.schema.Ample.DataLevel</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.TabletColumnFamily</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.metrics.MetricsUtil</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.replication.thrift.ReplicationCoordinator</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.security.Authorizations</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.spi.balancer.BalancerEnvironment</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.spi.balancer.SimpleLoadBalancer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.spi.balancer.TabletBalancer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.spi.balancer.data.TServerStatus</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.spi.balancer.data.TabletMigration</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.spi.balancer.data.TabletServerId</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.tabletserver.thrift.TUnloadTabletGoal</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.trace.TraceUtil</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.util.Halt</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.util.Retry</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.util.threads.ThreadPools</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.core.util.threads.Threads</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.manager.metrics.ManagerMetrics</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.manager.recovery.RecoveryManager</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.manager.state.TableCounts</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.manager.tableOps.TraceRepo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.manager.upgrade.UpgradeCoordinator</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.AbstractServer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.HighlyAvailableService</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.ServerContext</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.ServerOpts</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.fs.VolumeManager</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.manager.LiveTServerSet</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.manager.LiveTServerSet.TServerConnection</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.manager.balancer.BalancerEnvironmentImpl</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.manager.state.CurrentState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.manager.state.DeadServerList</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.manager.state.MergeInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.manager.state.MergeState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.manager.state.TabletServerState</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.manager.state.TabletStateStore</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.rpc.HighlyAvailableServiceWrapper</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.rpc.ServerAddress</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.rpc.TServerUtils</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.rpc.ThriftProcessorTypes</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.security.SecurityOperation</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.security.delegation.AuthenticationTokenKeyManager</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.security.delegation.ZooAuthenticationKeyDistributor</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.tables.TableManager</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.tables.TableObserver</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.util.ScanServerMetadataEntries</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.util.ServerBulkImportStatus</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.accumulo.server.util.TableInfoUtil</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hadoop.io.DataInputBuffer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.hadoop.io.DataOutputBuffer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.thrift.TException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.thrift.server.TServer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.thrift.transport.TTransportException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.zookeeper.KeeperException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.zookeeper.KeeperException.NoAuthException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.zookeeper.WatchedEvent</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.zookeeper.Watcher</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.Logger</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.collect.ImmutableSortedMap</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.util.concurrent.RateLimiter</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">edu.umd.cs.findbugs.annotations.SuppressFBWarnings</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.opentelemetry.api.trace.Span</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.opentelemetry.context.Scope</span><span class="p">;</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * The Manager is responsible for assigning and balancing tablets to tablet servers.</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The manager will also coordinate log recoveries and reports general status.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Manager</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractServer</span><span class="w"></span>
<span class="w">    </span><span class="kd">implements</span><span class="w"> </span><span class="n">LiveTServerSet</span><span class="p">.</span><span class="na">Listener</span><span class="p">,</span><span class="w"> </span><span class="n">TableObserver</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentState</span><span class="p">,</span><span class="w"> </span><span class="n">HighlyAvailableService</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">Manager</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ONE_SECOND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">TIME_TO_WAIT_BETWEEN_SCANS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ONE_SECOND</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// made this less than TIME_TO_WAIT_BETWEEN_SCANS, so that the cache is cleared between cycles</span><span class="w"></span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">TIME_TO_CACHE_RECOVERY_WAL_EXISTENCE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIME_TO_WAIT_BETWEEN_SCANS</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">TIME_BETWEEN_MIGRATION_CLEANUPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ONE_SECOND</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">WAIT_BETWEEN_ERRORS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ONE_SECOND</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">DEFAULT_WAIT_FOR_WATCHER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ONE_SECOND</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_CLEANUP_WAIT_TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ONE_SECOND</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TIME_TO_WAIT_BETWEEN_LOCK_CHECKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ONE_SECOND</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_TSERVER_WORK_CHUNK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_BAD_STATUS_COUNT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">MAX_SHUTDOWNS_PER_SEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="n">D</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">balancedNotifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">LiveTServerSet</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TabletGroupWatcher</span><span class="o">&gt;</span><span class="w"> </span><span class="n">watchers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">SecurityOperation</span><span class="w"> </span><span class="n">security</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="p">,</span><span class="n">AtomicInteger</span><span class="o">&gt;</span><span class="w"> </span><span class="n">badServers</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">Collections</span><span class="p">.</span><span class="na">synchronizedMap</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">serversToShutdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">synchronizedSet</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">KeyExtent</span><span class="p">,</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">migrations</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">Collections</span><span class="p">.</span><span class="na">synchronizedSortedMap</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TreeMap</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">EventCoordinator</span><span class="w"> </span><span class="n">nextEvent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">EventCoordinator</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">mergeLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="n">replicationWorkThread</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="n">replicationAssignerThread</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">RecoveryManager</span><span class="w"> </span><span class="n">recoveryManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ManagerTime</span><span class="w"> </span><span class="n">timeKeeper</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Delegation Token classes</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">delegationTokensAvailable</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">ZooAuthenticationKeyDistributor</span><span class="w"> </span><span class="n">keyDistributor</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">AuthenticationTokenKeyManager</span><span class="w"> </span><span class="n">authenticationTokenKeyManager</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">ServiceLock</span><span class="w"> </span><span class="n">managerLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">TServer</span><span class="w"> </span><span class="n">clientService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="n">TabletBalancer</span><span class="w"> </span><span class="n">tabletBalancer</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BalancerEnvironment</span><span class="w"> </span><span class="n">balancerEnvironment</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">ManagerState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">INITIAL</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// fateReadyLatch and fateRef go together; when this latch is ready, then the fate reference</span><span class="w"></span>
<span class="w">  </span><span class="c1">// should already have been set; still need to use atomic reference or volatile for fateRef, so no</span><span class="w"></span>
<span class="w">  </span><span class="c1">// thread&#39;s cached view shows that fateRef is still null after the latch is ready</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CountDownLatch</span><span class="w"> </span><span class="n">fateReadyLatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CountDownLatch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">Fate</span><span class="o">&lt;</span><span class="n">Manager</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">fateRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicReference</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kd">volatile</span><span class="w"> </span><span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="p">,</span><span class="n">TabletServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tserverStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emptySortedMap</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kd">volatile</span><span class="w"> </span><span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">TabletServerId</span><span class="p">,</span><span class="n">TServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tserverStatusForBalancer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emptySortedMap</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">ServerBulkImportStatus</span><span class="w"> </span><span class="n">bulkImportStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServerBulkImportStatus</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="w"> </span><span class="n">managerInitialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="w"> </span><span class="n">managerUpgrading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">ManagerState</span><span class="w"> </span><span class="nf">getManagerState</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">stillManager</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getManagerState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">STOP</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Retrieve the Fate object, blocking until it is ready. This could cause problems if Fate</span>
<span class="cm">   * operations are attempted to be used prior to the Manager being ready for them. If these</span>
<span class="cm">   * operations are triggered by a client side request from a tserver or client, it should be safe</span>
<span class="cm">   * to wait to handle those until Fate is ready, but if it occurs during an upgrade, or some other</span>
<span class="cm">   * time in the Manager before Fate is started, that may result in a deadlock and will need to be</span>
<span class="cm">   * fixed.</span>
<span class="cm">   *</span>
<span class="cm">   * @return the Fate object, only after the fate components are running and ready</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="n">Fate</span><span class="o">&lt;</span><span class="n">Manager</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">fate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// block up to 30 seconds until it&#39;s ready; if it&#39;s still not ready, introduce some logging</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fateReadyLatch</span><span class="p">.</span><span class="na">await</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">msgPrefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Unexpected use of fate in thread &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; at time &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="c1">// include stack trace so we know where it&#39;s coming from, in case we need to troubleshoot it</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;{} blocked until fate starts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msgPrefix</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Attempted fate action before manager finished starting up; &quot;</span><span class="w"></span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;if this doesn&#39;t make progress, please report it as a bug to the developers&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fateReadyLatch</span><span class="p">.</span><span class="na">await</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">minutes</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;{} still blocked after {} minutes; this is getting weird&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msgPrefix</span><span class="p">,</span><span class="w"> </span><span class="n">minutes</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;{} no longer blocked&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msgPrefix</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Thread was interrupted; cannot proceed&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fateRef</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// @formatter:off</span><span class="w"></span>
<span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="o">[][]</span><span class="w"> </span><span class="n">transitionOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">//                            INITIAL HAVE_LOCK SAFE_MODE NORMAL UNLOAD_META UNLOAD_ROOT STOP</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* INITIAL */</span><span class="w">                 </span><span class="p">{</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* HAVE_LOCK */</span><span class="w">               </span><span class="p">{</span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* SAFE_MODE */</span><span class="w">               </span><span class="p">{</span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* NORMAL */</span><span class="w">                  </span><span class="p">{</span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* UNLOAD_METADATA_TABLETS */</span><span class="w"> </span><span class="p">{</span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* UNLOAD_ROOT_TABLET */</span><span class="w">      </span><span class="p">{</span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* STOP */</span><span class="w">                    </span><span class="p">{</span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">}};</span><span class="w"></span>
<span class="w">  </span><span class="c1">//@formatter:on</span><span class="w"></span>
<span class="w">  </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="w"> </span><span class="n">newState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">newState</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">transitionOK</span><span class="o">[</span><span class="n">state</span><span class="p">.</span><span class="na">ordinal</span><span class="p">()</span><span class="o">][</span><span class="n">newState</span><span class="p">.</span><span class="na">ordinal</span><span class="p">()</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Programmer error: manager should not transition from {} to {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">newState</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">ManagerState</span><span class="w"> </span><span class="n">oldState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newState</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">event</span><span class="p">(</span><span class="s">&quot;State changed from %s to %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">oldState</span><span class="p">,</span><span class="w"> </span><span class="n">newState</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">STOP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Give the server a little time before shutdown so the client</span><span class="w"></span>
<span class="w">      </span><span class="c1">// thread requesting the stop can return</span><span class="w"></span>
<span class="w">      </span><span class="n">ScheduledFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getScheduledExecutor</span><span class="p">().</span><span class="na">scheduleWithFixedDelay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// This frees the main thread and will cause the manager to exit</span><span class="w"></span>
<span class="w">        </span><span class="n">clientService</span><span class="p">.</span><span class="na">stop</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Manager</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">nextEvent</span><span class="p">.</span><span class="na">event</span><span class="p">(</span><span class="s">&quot;stopped event loop&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mi">100L</span><span class="p">,</span><span class="w"> </span><span class="mi">1000L</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">ThreadPools</span><span class="p">.</span><span class="na">watchNonCriticalScheduledTask</span><span class="p">(</span><span class="n">future</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">newState</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">newState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">HAVE_LOCK</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">upgradeCoordinator</span><span class="p">.</span><span class="na">upgradeZookeeper</span><span class="p">(</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">nextEvent</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">newState</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">newState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">NORMAL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fateRef</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Access to Fate should not have been&quot;</span><span class="w"></span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; initialized prior to the Manager finishing upgrades. Please save&quot;</span><span class="w"></span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; all logs and file a bug.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">upgradeMetadataFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upgradeCoordinator</span><span class="p">.</span><span class="na">upgradeMetadata</span><span class="p">(</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">nextEvent</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">UpgradeCoordinator</span><span class="w"> </span><span class="n">upgradeCoordinator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UpgradeCoordinator</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">upgradeMetadataFuture</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">FateServiceHandler</span><span class="w"> </span><span class="n">fateServiceHandler</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">ManagerClientServiceHandler</span><span class="w"> </span><span class="n">managerClientHandler</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">assignedOrHosted</span><span class="p">(</span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">TableCounts</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">watcher</span><span class="p">.</span><span class="na">getStats</span><span class="p">(</span><span class="n">tableId</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">count</span><span class="p">.</span><span class="na">hosted</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="p">.</span><span class="na">assigned</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">totalAssignedOrHosted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TableCounts</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watcher</span><span class="p">.</span><span class="na">getStats</span><span class="p">().</span><span class="na">values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">assigned</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">hosted</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">nonMetaDataTabletsAssignedOrHosted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">totalAssignedOrHosted</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">assignedOrHosted</span><span class="p">(</span><span class="n">MetadataTable</span><span class="p">.</span><span class="na">ID</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">assignedOrHosted</span><span class="p">(</span><span class="n">RootTable</span><span class="p">.</span><span class="na">ID</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">notHosted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TableCounts</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watcher</span><span class="p">.</span><span class="na">getStats</span><span class="p">().</span><span class="na">values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">assigned</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">assignedToDeadServers</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">suspended</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// The number of unassigned tablets that should be assigned: displayed on the monitor page</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">displayUnassigned</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerState</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">NORMAL</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Count offline tablets for online tables</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">TableManager</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getTableManager</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">TableId</span><span class="p">,</span><span class="n">TableCounts</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watcher</span><span class="p">.</span><span class="na">getStats</span><span class="p">().</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">TableCounts</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">getTableState</span><span class="p">(</span><span class="n">tableId</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TableState</span><span class="p">.</span><span class="na">ONLINE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">unassigned</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">assignedToDeadServers</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">assigned</span><span class="p">()</span><span class="w"></span>
<span class="w">                  </span><span class="o">+</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">suspended</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">SAFE_MODE</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Count offline tablets for the metadata table</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">TableCounts</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">watcher</span><span class="p">.</span><span class="na">getStats</span><span class="p">(</span><span class="n">MetadataTable</span><span class="p">.</span><span class="na">ID</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">unassigned</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">suspended</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">UNLOAD_METADATA_TABLETS</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">UNLOAD_ROOT_TABLET</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">TableCounts</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">watcher</span><span class="p">.</span><span class="na">getStats</span><span class="p">(</span><span class="n">MetadataTable</span><span class="p">.</span><span class="na">ID</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">unassigned</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">suspended</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">mustBeOnline</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ThriftTableOperationException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ServerContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">context</span><span class="p">.</span><span class="na">clearTableListCache</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getTableState</span><span class="p">(</span><span class="n">tableId</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TableState</span><span class="p">.</span><span class="na">ONLINE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThriftTableOperationException</span><span class="p">(</span><span class="n">tableId</span><span class="p">.</span><span class="na">canonical</span><span class="p">(),</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">TableOperation</span><span class="p">.</span><span class="na">MERGE</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">TableOperationExceptionType</span><span class="p">.</span><span class="na">OFFLINE</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;table is not online&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">TableManager</span><span class="w"> </span><span class="nf">getTableManager</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getTableManager</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">Manager</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Manager</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ServerOpts</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">manager</span><span class="p">.</span><span class="na">runServer</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">Manager</span><span class="p">(</span><span class="n">ServerOpts</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">super</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ServerContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">balancerEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BalancerEnvironmentImpl</span><span class="p">(</span><span class="n">context</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">AccumuloConfiguration</span><span class="w"> </span><span class="n">aconf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getConfiguration</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Version {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">VERSION</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Instance {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getInstanceID</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">timeKeeper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ManagerTime</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">aconf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">tserverSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LiveTServerSet</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">initializeBalancer</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">security</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSecurityOperation</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">tokenLifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aconf</span><span class="p">.</span><span class="na">getTimeInMillis</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">GENERAL_DELEGATION_TOKEN_LIFETIME</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">authenticationTokenKeyManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">keyDistributor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getConfiguration</span><span class="p">().</span><span class="na">getBoolean</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">INSTANCE_RPC_SASL_ENABLED</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// SASL is enabled, create the key distributor (ZooKeeper) and manager (generates/rolls secret</span><span class="w"></span>
<span class="w">      </span><span class="c1">// keys)</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;SASL is enabled, creating delegation token key manager and distributor&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">tokenUpdateInterval</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">aconf</span><span class="p">.</span><span class="na">getTimeInMillis</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">GENERAL_DELEGATION_TOKEN_UPDATE_INTERVAL</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">keyDistributor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZooAuthenticationKeyDistributor</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getZooReaderWriter</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">getZooKeeperRoot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZDELEGATION_TOKEN_KEYS</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">authenticationTokenKeyManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AuthenticationTokenKeyManager</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getSecretManager</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">keyDistributor</span><span class="p">,</span><span class="w"> </span><span class="n">tokenUpdateInterval</span><span class="p">,</span><span class="w"> </span><span class="n">tokenLifetime</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">delegationTokensAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;SASL is not enabled, delegation tokens will not be available&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">delegationTokensAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">InstanceId</span><span class="w"> </span><span class="nf">getInstanceID</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getInstanceID</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getZooKeeperRoot</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getZooKeeperRoot</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">TServerConnection</span><span class="w"> </span><span class="nf">getConnection</span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">MergeInfo</span><span class="w"> </span><span class="nf">getMergeInfo</span><span class="p">(</span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ServerContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mergeLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getZooKeeperRoot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZTABLES</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tableId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/merge&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">.</span><span class="na">getZooReaderWriter</span><span class="p">().</span><span class="na">exists</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MergeInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getZooReaderWriter</span><span class="p">().</span><span class="na">getData</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">DataInputBuffer</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DataInputBuffer</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">in</span><span class="p">.</span><span class="na">reset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">MergeInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MergeInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">readFields</span><span class="p">(</span><span class="n">in</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">KeeperException</span><span class="p">.</span><span class="na">NoNodeException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Error reading merge state, it probably just finished&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MergeInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Unexpected error reading merge state&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MergeInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setMergeState</span><span class="p">(</span><span class="n">MergeInfo</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">MergeState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">throws</span><span class="w"> </span><span class="n">KeeperException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ServerContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mergeLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">getZooKeeperRoot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZTABLES</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">getExtent</span><span class="p">().</span><span class="na">tableId</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/merge&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">info</span><span class="p">.</span><span class="na">setState</span><span class="p">(</span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">MergeState</span><span class="p">.</span><span class="na">NONE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="na">getZooReaderWriter</span><span class="p">().</span><span class="na">recursiveDelete</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">NodeMissingPolicy</span><span class="p">.</span><span class="na">SKIP</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DataOutputBuffer</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DataOutputBuffer</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">info</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">out</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AssertionError</span><span class="p">(</span><span class="s">&quot;Unlikely&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="na">getZooReaderWriter</span><span class="p">().</span><span class="na">putPersistentData</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="na">getData</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">MergeState</span><span class="p">.</span><span class="na">STARTED</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ZooUtil</span><span class="p">.</span><span class="na">NodeExistsPolicy</span><span class="p">.</span><span class="na">FAIL</span><span class="w"></span>
<span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">ZooUtil</span><span class="p">.</span><span class="na">NodeExistsPolicy</span><span class="p">.</span><span class="na">OVERWRITE</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">mergeLock</span><span class="p">.</span><span class="na">notifyAll</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">event</span><span class="p">(</span><span class="s">&quot;Merge state of %s set to %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">getExtent</span><span class="p">(),</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">clearMergeState</span><span class="p">(</span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">KeeperException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mergeLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getZooKeeperRoot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZTABLES</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tableId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/merge&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">getContext</span><span class="p">().</span><span class="na">getZooReaderWriter</span><span class="p">().</span><span class="na">recursiveDelete</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">NodeMissingPolicy</span><span class="p">.</span><span class="na">SKIP</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">mergeLock</span><span class="p">.</span><span class="na">notifyAll</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">event</span><span class="p">(</span><span class="s">&quot;Merge state of %s cleared&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tableId</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">setManagerGoalState</span><span class="p">(</span><span class="n">ManagerGoalState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">getContext</span><span class="p">().</span><span class="na">getZooReaderWriter</span><span class="p">().</span><span class="na">putPersistentData</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">getZooKeeperRoot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZMANAGER_GOAL_STATE</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">name</span><span class="p">().</span><span class="na">getBytes</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">NodeExistsPolicy</span><span class="p">.</span><span class="na">OVERWRITE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Unable to set manager goal state in zookeeper&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">ManagerGoalState</span><span class="w"> </span><span class="nf">getManagerGoalState</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getZooReaderWriter</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="na">getData</span><span class="p">(</span><span class="n">getZooKeeperRoot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZMANAGER_GOAL_STATE</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ManagerGoalState</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">data</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Problem getting real goal state from zookeeper: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">sleepUninterruptibly</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">hasCycled</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">watcher</span><span class="p">.</span><span class="na">stats</span><span class="p">.</span><span class="na">lastScanFinished</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">clearMigrations</span><span class="p">(</span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">migrations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">migrations</span><span class="p">.</span><span class="na">keySet</span><span class="p">().</span><span class="na">removeIf</span><span class="p">(</span><span class="n">extent</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">extent</span><span class="p">.</span><span class="na">tableId</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">tableId</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">enum</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">HOSTED</span><span class="p">(</span><span class="n">TUnloadTabletGoal</span><span class="p">.</span><span class="na">UNKNOWN</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">UNASSIGNED</span><span class="p">(</span><span class="n">TUnloadTabletGoal</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">DELETED</span><span class="p">(</span><span class="n">TUnloadTabletGoal</span><span class="p">.</span><span class="na">DELETED</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">SUSPENDED</span><span class="p">(</span><span class="n">TUnloadTabletGoal</span><span class="p">.</span><span class="na">SUSPENDED</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TUnloadTabletGoal</span><span class="w"> </span><span class="n">unloadGoal</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">TabletGoalState</span><span class="p">(</span><span class="n">TUnloadTabletGoal</span><span class="w"> </span><span class="n">unloadGoal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">unloadGoal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unloadGoal</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** The purpose of unloading this tablet. */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TUnloadTabletGoal</span><span class="w"> </span><span class="nf">howUnload</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">unloadGoal</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">TabletGoalState</span><span class="w"> </span><span class="nf">getSystemGoalState</span><span class="p">(</span><span class="n">TabletLocationState</span><span class="w"> </span><span class="n">tls</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerState</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">NORMAL</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">HOSTED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">HAVE_LOCK</span><span class="p">:</span><span class="w"> </span><span class="c1">// fall-through intended</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">INITIAL</span><span class="p">:</span><span class="w"> </span><span class="c1">// fall-through intended</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">SAFE_MODE</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tls</span><span class="p">.</span><span class="na">extent</span><span class="p">.</span><span class="na">isMeta</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">HOSTED</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">UNLOAD_METADATA_TABLETS</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tls</span><span class="p">.</span><span class="na">extent</span><span class="p">.</span><span class="na">isRootTablet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">HOSTED</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">UNLOAD_ROOT_TABLET</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">STOP</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Unknown Manager State&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">TabletGoalState</span><span class="w"> </span><span class="nf">getTableGoalState</span><span class="p">(</span><span class="n">KeyExtent</span><span class="w"> </span><span class="n">extent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">TableState</span><span class="w"> </span><span class="n">tableState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getTableManager</span><span class="p">().</span><span class="na">getTableState</span><span class="p">(</span><span class="n">extent</span><span class="p">.</span><span class="na">tableId</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tableState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">DELETED</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">tableState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">DELETING</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">DELETED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">OFFLINE</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">NEW</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">HOSTED</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">TabletGoalState</span><span class="w"> </span><span class="nf">getGoalState</span><span class="p">(</span><span class="n">TabletLocationState</span><span class="w"> </span><span class="n">tls</span><span class="p">,</span><span class="w"> </span><span class="n">MergeInfo</span><span class="w"> </span><span class="n">mergeInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">KeyExtent</span><span class="w"> </span><span class="n">extent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls</span><span class="p">.</span><span class="na">extent</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Shutting down?</span><span class="w"></span>
<span class="w">    </span><span class="n">TabletGoalState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSystemGoalState</span><span class="p">(</span><span class="n">tls</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">HOSTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">upgradeCoordinator</span><span class="p">.</span><span class="na">getStatus</span><span class="p">().</span><span class="na">isParentLevelUpgraded</span><span class="p">(</span><span class="n">extent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// The place where this tablet stores its metadata was not upgraded, so do not assign this</span><span class="w"></span>
<span class="w">        </span><span class="c1">// tablet yet.</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tls</span><span class="p">.</span><span class="na">current</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">serversToShutdown</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">tls</span><span class="p">.</span><span class="na">current</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">SUSPENDED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Handle merge transitions</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mergeInfo</span><span class="p">.</span><span class="na">getExtent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">overlaps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mergeInfo</span><span class="p">.</span><span class="na">overlaps</span><span class="p">(</span><span class="n">extent</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overlaps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;mergeInfo overlaps: {} true&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">extent</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mergeInfo</span><span class="p">.</span><span class="na">getState</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">NONE</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">COMPLETE</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">STARTED</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">SPLITTING</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">HOSTED</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">WAITING_FOR_CHOPPED</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tls</span><span class="p">.</span><span class="na">getState</span><span class="p">(</span><span class="n">tserverSet</span><span class="p">.</span><span class="na">getCurrentServers</span><span class="p">()).</span><span class="na">equals</span><span class="p">(</span><span class="n">TabletState</span><span class="p">.</span><span class="na">HOSTED</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tls</span><span class="p">.</span><span class="na">chopped</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tls</span><span class="p">.</span><span class="na">chopped</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tls</span><span class="p">.</span><span class="na">walogs</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>

<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">HOSTED</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">WAITING_FOR_OFFLINE</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">MERGING</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;mergeInfo overlaps: {} false&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">extent</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// taking table offline?</span><span class="w"></span>
<span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTableGoalState</span><span class="p">(</span><span class="n">extent</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">HOSTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Maybe this tablet needs to be migrated</span><span class="w"></span>
<span class="w">        </span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">migrations</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">extent</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dest</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tls</span><span class="p">.</span><span class="na">current</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">dest</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">tls</span><span class="p">.</span><span class="na">current</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">TabletGoalState</span><span class="p">.</span><span class="na">UNASSIGNED</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MigrationCleanupThread</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">stillManager</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">migrations</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">cleanupOfflineMigrations</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">cleanupNonexistentMigrations</span><span class="p">(</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Error cleaning up migrations&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">sleepUninterruptibly</span><span class="p">(</span><span class="n">TIME_BETWEEN_MIGRATION_CLEANUPS</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * If a migrating tablet splits, and the tablet dies before sending the manager a message, the</span>
<span class="cm">     * migration will refer to a non-existing tablet, so it can never complete. Periodically scan</span>
<span class="cm">     * the metadata table and remove any migrating tablets that no longer exist.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cleanupNonexistentMigrations</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">AccumuloClient</span><span class="w"> </span><span class="n">accumuloClient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">TableNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Scanner</span><span class="w"> </span><span class="n">scanner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accumuloClient</span><span class="p">.</span><span class="na">createScanner</span><span class="p">(</span><span class="n">MetadataTable</span><span class="p">.</span><span class="na">NAME</span><span class="p">,</span><span class="w"> </span><span class="n">Authorizations</span><span class="p">.</span><span class="na">EMPTY</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">TabletColumnFamily</span><span class="p">.</span><span class="na">PREV_ROW_COLUMN</span><span class="p">.</span><span class="na">fetch</span><span class="p">(</span><span class="n">scanner</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">KeyExtent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">scanner</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">KeyExtent</span><span class="w"> </span><span class="n">extent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyExtent</span><span class="p">.</span><span class="na">fromMetaPrevRow</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">migrations</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">extent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">found</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">extent</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">migrations</span><span class="p">.</span><span class="na">keySet</span><span class="p">().</span><span class="na">retainAll</span><span class="p">(</span><span class="n">found</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * If migrating a tablet for a table that is offline, the migration can never succeed because no</span>
<span class="cm">     * tablet server will load the tablet. check for offline tables and remove their migrations.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cleanupOfflineMigrations</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ServerContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">TableManager</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getTableManager</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getTableIdToNameMap</span><span class="p">().</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">TableState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="na">getTableState</span><span class="p">(</span><span class="n">tableId</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TableState</span><span class="p">.</span><span class="na">OFFLINE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">clearMigrations</span><span class="p">(</span><span class="n">tableId</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StatusThread</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">goodStats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerState</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">UNLOAD_METADATA_TABLETS</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">UNLOAD_ROOT_TABLET</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">watchers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">watchers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">watcher</span><span class="p">.</span><span class="na">stats</span><span class="p">.</span><span class="na">getLastManagerState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">getManagerState</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;{}: {} != {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">watcher</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">watcher</span><span class="p">.</span><span class="na">stats</span><span class="p">.</span><span class="na">getLastManagerState</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">getManagerState</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">EventCoordinator</span><span class="p">.</span><span class="na">Listener</span><span class="w"> </span><span class="n">eventListener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">getListener</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">stillManager</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_WAIT_FOR_WATCHER</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerGoalState</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">NORMAL</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">NORMAL</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">SAFE_MODE</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerState</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">NORMAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">SAFE_MODE</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerState</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">HAVE_LOCK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">SAFE_MODE</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">CLEAN_STOP</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerState</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">NORMAL</span><span class="p">:</span><span class="w"></span>
<span class="w">                  </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">SAFE_MODE</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">SAFE_MODE</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nonMetaDataTabletsAssignedOrHosted</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;There are %d non-metadata tablets assigned or hosted&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">goodStats</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">UNLOAD_METADATA_TABLETS</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">UNLOAD_METADATA_TABLETS</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assignedOrHosted</span><span class="p">(</span><span class="n">MetadataTable</span><span class="p">.</span><span class="na">ID</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;There are %d metadata tablets assigned or hosted&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">goodStats</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">UNLOAD_ROOT_TABLET</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">UNLOAD_ROOT_TABLET</span><span class="p">:</span><span class="w"></span>
<span class="w">                  </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assignedOrHosted</span><span class="p">(</span><span class="n">MetadataTable</span><span class="p">.</span><span class="na">ID</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">goodStats</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%d metadata tablets online&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">));</span><span class="w"></span>
<span class="w">                    </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">UNLOAD_ROOT_TABLET</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="kt">int</span><span class="w"> </span><span class="n">root_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assignedOrHosted</span><span class="p">(</span><span class="n">RootTable</span><span class="p">.</span><span class="na">ID</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">root_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">goodStats</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;The root tablet is still assigned or hosted&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">root_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">goodStats</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">currentServers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">getCurrentServers</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;stopping {} tablet servers&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">currentServers</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">currentServers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">serversToShutdown</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">server</span><span class="p">).</span><span class="na">fastHalt</span><span class="p">(</span><span class="n">managerLock</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// its probably down, and we don&#39;t care</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">currentServers</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">STOP</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">default</span><span class="p">:</span><span class="w"></span>
<span class="w">                  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Error occurred reading / switching manager goal state. Will&quot;</span><span class="w"></span>
<span class="w">              </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; continue with attempt to update status&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Span</span><span class="w"> </span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TraceUtil</span><span class="p">.</span><span class="na">startSpan</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getClass</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;run::updateStatus&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">Scope</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">span</span><span class="p">.</span><span class="na">makeCurrent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">wait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateStatus</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">eventListener</span><span class="p">.</span><span class="na">waitForEvents</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">TraceUtil</span><span class="p">.</span><span class="na">setException</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Error balancing tablets, will wait for {} (seconds) and then retry &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">WAIT_BETWEEN_ERRORS</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ONE_SECOND</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">sleepUninterruptibly</span><span class="p">(</span><span class="n">WAIT_BETWEEN_ERRORS</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">span</span><span class="p">.</span><span class="na">end</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">updateStatus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">currentServers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">getCurrentServers</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">TreeMap</span><span class="o">&lt;</span><span class="n">TabletServerId</span><span class="p">,</span><span class="n">TServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">tserverStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gatherTableInformation</span><span class="p">(</span><span class="n">currentServers</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">tserverStatusForBalancer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">unmodifiableSortedMap</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">checkForHeldServer</span><span class="p">(</span><span class="n">tserverStatus</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">badServers</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;not balancing because the balance information is out-of-date {}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">badServers</span><span class="p">.</span><span class="na">keySet</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">notHosted</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;not balancing because there are unhosted tablets: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">notHosted</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerGoalState</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ManagerGoalState</span><span class="p">.</span><span class="na">CLEAN_STOP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;not balancing because the manager is attempting to stop cleanly&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">serversToShutdown</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;not balancing while shutting down servers {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">serversToShutdown</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">tgw</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tgw</span><span class="p">.</span><span class="na">isSameTserversAsLastScan</span><span class="p">(</span><span class="n">currentServers</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;not balancing just yet, as collection of live tservers is in flux&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">DEFAULT_WAIT_FOR_WATCHER</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">balanceTablets</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">DEFAULT_WAIT_FOR_WATCHER</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkForHeldServer</span><span class="p">(</span><span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="p">,</span><span class="n">TabletServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tserverStatus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">crazyHoldTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">someHoldTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">maxWait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getConfiguration</span><span class="p">().</span><span class="na">getTimeInMillis</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">TSERV_HOLD_TIME_SUICIDE</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="p">,</span><span class="n">TabletServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tserverStatus</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">getHoldTime</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">someHoldTime</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">getHoldTime</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxWait</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">crazyHoldTime</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">crazyHoldTime</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">someHoldTime</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tserverStatus</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Tablet server {} exceeded maximum hold time: attempting to kill it&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">TServerConnection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connection</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">connection</span><span class="p">.</span><span class="na">fastHalt</span><span class="p">(</span><span class="n">managerLock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">badServers</span><span class="p">.</span><span class="na">putIfAbsent</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">balanceTablets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">BalanceParamsImpl</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BalanceParamsImpl</span><span class="p">.</span><span class="na">fromThrift</span><span class="p">(</span><span class="n">tserverStatusForBalancer</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">tserverStatus</span><span class="p">,</span><span class="w"> </span><span class="n">migrationsSnapshot</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="kt">long</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tabletBalancer</span><span class="p">.</span><span class="na">balance</span><span class="p">(</span><span class="n">params</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletMigration</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">checkMigrationSanity</span><span class="p">(</span><span class="n">tserverStatusForBalancer</span><span class="p">.</span><span class="na">keySet</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">params</span><span class="p">.</span><span class="na">migrationsOut</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">KeyExtent</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyExtent</span><span class="p">.</span><span class="na">fromTabletId</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getTablet</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">migrations</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;balancer requested migration more than once, skipping {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">tserverInstance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TabletServerIdImpl</span><span class="p">.</span><span class="na">toThrift</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getNewTabletServer</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">migrations</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">tserverInstance</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;migration {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="na">migrationsOut</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">balancedNotifier</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">balancedNotifier</span><span class="p">.</span><span class="na">notifyAll</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">event</span><span class="p">(</span><span class="s">&quot;Migrating %d more tablets, %d total&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="na">migrationsOut</span><span class="p">().</span><span class="na">size</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">migrations</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">wait</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TabletMigration</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">checkMigrationSanity</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TabletServerId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TabletMigration</span><span class="o">&gt;</span><span class="w"> </span><span class="n">migrations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">migrations</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">filter</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">includeMigration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getTablet</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Balancer gave back a null tablet {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getNewTabletServer</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Balancer did not set the destination {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getOldTabletServer</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Balancer did not set the source {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getOldTabletServer</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Balancer wants to move a tablet from a server that is not current: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getNewTabletServer</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Balancer wants to move a tablet to a server that is not current: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">includeMigration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">includeMigration</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="p">,</span><span class="n">TabletServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">gatherTableInformation</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">currentServers</span><span class="p">,</span><span class="w"> </span><span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">TabletServerId</span><span class="p">,</span><span class="n">TServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">balancerMap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">rpcTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getConfiguration</span><span class="p">().</span><span class="na">getTimeInMillis</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">GENERAL_RPC_TIMEOUT</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getConfiguration</span><span class="p">().</span><span class="na">getCount</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_STATUS_THREAD_POOL_SIZE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ThreadPools</span><span class="p">.</span><span class="na">getServerThreadPools</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">createExecutorService</span><span class="p">(</span><span class="n">getConfiguration</span><span class="p">(),</span><span class="w"> </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_STATUS_THREAD_POOL_SIZE</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="p">,</span><span class="n">TabletServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentSkipListMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">RateLimiter</span><span class="w"> </span><span class="n">shutdownServerRateLimiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RateLimiter</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">MAX_SHUTDOWNS_PER_SEC</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">serverInstance</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">currentServers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serverInstance</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Since an unbounded thread pool is being used, rate limit how fast task are added to the</span><span class="w"></span>
<span class="w">        </span><span class="c1">// executor. This prevents the threads from growing large unless there are lots of</span><span class="w"></span>
<span class="w">        </span><span class="c1">// unresponsive tservers.</span><span class="w"></span>
<span class="w">        </span><span class="n">sleepUninterruptibly</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rpcTimeout</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">120_000</span><span class="p">),</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">tp</span><span class="p">.</span><span class="na">execute</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Thread</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">String</span><span class="w"> </span><span class="n">oldName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Getting status from &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">server</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">t</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">startForServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">TServerConnection</span><span class="w"> </span><span class="n">connection1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connection1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;No connection to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">TabletServerStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection1</span><span class="p">.</span><span class="na">getTableMap</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startForServer</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;Got status from {} in {} ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">t</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="n">oldName</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;unable to get tablet server status {} {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;unable to get tablet server status {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Attempt to shutdown server only if able to acquire. If unable, this tablet server</span><span class="w"></span>
<span class="w">          </span><span class="c1">// will be removed from the badServers set below and status will be reattempted again</span><span class="w"></span>
<span class="w">          </span><span class="c1">// MAX_BAD_STATUS_COUNT times</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">badServers</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="na">incrementAndGet</span><span class="p">()</span><span class="w"></span>
<span class="w">              </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_BAD_STATUS_COUNT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shutdownServerRateLimiter</span><span class="p">.</span><span class="na">tryAcquire</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;attempting to stop {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">TServerConnection</span><span class="w"> </span><span class="n">connection2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connection2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">connection2</span><span class="p">.</span><span class="na">halt</span><span class="p">(</span><span class="n">managerLock</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TTransportException</span><span class="w"> </span><span class="n">e1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// ignore: it&#39;s probably down</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;error talking to troublesome tablet server&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Unable to shutdown {} as over the shutdown limit of {} per minute&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">MAX_SHUTDOWNS_PER_SEC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">badServers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">tp</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">tp</span><span class="p">.</span><span class="na">awaitTermination</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="n">rpcTimeout</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Interrupted while fetching status&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">tp</span><span class="p">.</span><span class="na">shutdownNow</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Threads may still modify map after shutdownNow is called, so create an immutable snapshot.</span><span class="w"></span>
<span class="w">    </span><span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="p">,</span><span class="n">TabletServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableSortedMap</span><span class="p">.</span><span class="na">copyOf</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">tserverStatus</span><span class="p">.</span><span class="na">forEach</span><span class="p">((</span><span class="n">tsi</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">balancerMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TabletServerIdImpl</span><span class="p">(</span><span class="n">tsi</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">TServerStatusImpl</span><span class="p">.</span><span class="na">fromThrift</span><span class="p">(</span><span class="n">status</span><span class="p">)));</span><span class="w"></span>

<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">badServers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">badServers</span><span class="p">.</span><span class="na">keySet</span><span class="p">().</span><span class="na">retainAll</span><span class="p">(</span><span class="n">currentServers</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">badServers</span><span class="p">.</span><span class="na">keySet</span><span class="p">().</span><span class="na">removeAll</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">keySet</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;Finished gathering information from %d of %d servers in %.2f seconds&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="w"> </span><span class="n">currentServers</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000.</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ServerContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">zroot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getZooKeeperRoot</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// ACCUMULO-4424 Put up the Thrift servers before getting the lock as a sign of process health</span><span class="w"></span>
<span class="w">    </span><span class="c1">// when a hot-standby</span><span class="w"></span>
<span class="w">    </span><span class="c1">//</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Start the Manager&#39;s Fate Service</span><span class="w"></span>
<span class="w">    </span><span class="n">fateServiceHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FateServiceHandler</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">managerClientHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ManagerClientServiceHandler</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Start the Manager&#39;s Client service</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Ensure that calls before the manager gets the lock fail</span><span class="w"></span>
<span class="w">    </span><span class="n">ManagerClientService</span><span class="p">.</span><span class="na">Iface</span><span class="w"> </span><span class="n">haProxy</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">HighlyAvailableServiceWrapper</span><span class="p">.</span><span class="na">service</span><span class="p">(</span><span class="n">managerClientHandler</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">ServerAddress</span><span class="w"> </span><span class="n">sa</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">ThriftProcessorTypes</span><span class="p">.</span><span class="na">getManagerTProcessor</span><span class="p">(</span><span class="n">fateServiceHandler</span><span class="p">,</span><span class="w"> </span><span class="n">haProxy</span><span class="p">,</span><span class="w"> </span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TServerUtils</span><span class="p">.</span><span class="na">startServer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">getHostname</span><span class="p">(),</span><span class="w"> </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_CLIENTPORT</span><span class="p">,</span><span class="w"> </span><span class="n">processor</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;Manager&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Manager Client Service Handler&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_MINTHREADS</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_MINTHREADS_TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_THREADCHECK</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">Property</span><span class="p">.</span><span class="na">GENERAL_MAX_MESSAGE_SIZE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnknownHostException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Unable to start server on host &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">getHostname</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">clientService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="p">.</span><span class="na">server</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Started Manager client service at {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">.</span><span class="na">address</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// block until we can obtain the ZK lock for the manager</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">getManagerLock</span><span class="p">(</span><span class="n">ServiceLock</span><span class="p">.</span><span class="na">path</span><span class="p">(</span><span class="n">zroot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZMANAGER_LOCK</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">KeeperException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Exception getting manager lock&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// If UpgradeStatus is not at complete by this moment, then things are currently</span><span class="w"></span>
<span class="w">    </span><span class="c1">// upgrading.</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">upgradeCoordinator</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UpgradeCoordinator</span><span class="p">.</span><span class="na">UpgradeStatus</span><span class="p">.</span><span class="na">COMPLETE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">managerUpgrading</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">MetricsUtil</span><span class="p">.</span><span class="na">initializeMetrics</span><span class="p">(</span><span class="n">getContext</span><span class="p">().</span><span class="na">getConfiguration</span><span class="p">(),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">applicationName</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">sa</span><span class="p">.</span><span class="na">getAddress</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">ManagerMetrics</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">getConfiguration</span><span class="p">(),</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InstantiationException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="w"></span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InvocationTargetException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NoSuchMethodException</span><span class="w"></span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">SecurityException</span><span class="w"> </span><span class="n">e1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Error initializing metrics, metrics will not be emitted.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">recoveryManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RecoveryManager</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">TIME_TO_CACHE_RECOVERY_WAL_EXISTENCE</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">context</span><span class="p">.</span><span class="na">getTableManager</span><span class="p">().</span><span class="na">addObserver</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">statusThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Threads</span><span class="p">.</span><span class="na">createThread</span><span class="p">(</span><span class="s">&quot;Status Thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StatusThread</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">statusThread</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">Threads</span><span class="p">.</span><span class="na">createThread</span><span class="p">(</span><span class="s">&quot;Migration Cleanup Thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MigrationCleanupThread</span><span class="p">()).</span><span class="na">start</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">startListeningForTabletServerChanges</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">blockForTservers</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">ZooReaderWriter</span><span class="w"> </span><span class="n">zReaderWriter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getZooReaderWriter</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">zReaderWriter</span><span class="p">.</span><span class="na">getChildren</span><span class="p">(</span><span class="n">zroot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZRECOVERY</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Watcher</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">WatchedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">event</span><span class="p">(</span><span class="s">&quot;Noticed recovery changes %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// watcher only fires once, add it back</span><span class="w"></span>
<span class="w">            </span><span class="n">zReaderWriter</span><span class="p">.</span><span class="na">getChildren</span><span class="p">(</span><span class="n">zroot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZRECOVERY</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Failed to add log recovery watcher back&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">KeeperException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Unable to read &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">zroot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZRECOVERY</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">watchers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TabletGroupWatcher</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">TabletStateStore</span><span class="p">.</span><span class="na">getStoreForLevel</span><span class="p">(</span><span class="n">DataLevel</span><span class="p">.</span><span class="na">USER</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">      </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canSuspendTablets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Always allow user data tablets to enter suspended state.</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="n">watchers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TabletGroupWatcher</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">TabletStateStore</span><span class="p">.</span><span class="na">getStoreForLevel</span><span class="p">(</span><span class="n">DataLevel</span><span class="p">.</span><span class="na">METADATA</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="n">watchers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">      </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canSuspendTablets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Allow metadata tablets to enter suspended state only if so configured. Generally</span><span class="w"></span>
<span class="w">        </span><span class="c1">// we&#39;ll want metadata tablets to</span><span class="w"></span>
<span class="w">        </span><span class="c1">// be immediately reassigned, even if there&#39;s a global table.suspension.duration</span><span class="w"></span>
<span class="w">        </span><span class="c1">// setting.</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getConfiguration</span><span class="p">().</span><span class="na">getBoolean</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_METADATA_SUSPENDABLE</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="n">watchers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TabletGroupWatcher</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">TabletStateStore</span><span class="p">.</span><span class="na">getStoreForLevel</span><span class="p">(</span><span class="n">DataLevel</span><span class="p">.</span><span class="na">ROOT</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">),</span><span class="w"> </span><span class="n">watchers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">      </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canSuspendTablets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Never allow root tablet to enter suspended state.</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">watcher</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Once we are sure the upgrade is complete, we can safely allow fate use.</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// wait for metadata upgrade running in background to complete</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">upgradeMetadataFuture</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">upgradeMetadataFuture</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Everything is fully upgraded by this point.</span><span class="w"></span>
<span class="w">      </span><span class="n">managerUpgrading</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExecutionException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Metadata upgrade failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">AgeOffStore</span><span class="o">&lt;</span><span class="n">Manager</span><span class="o">&gt;</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="k">new</span><span class="w"> </span><span class="n">AgeOffStore</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="k">new</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">accumulo</span><span class="p">.</span><span class="na">core</span><span class="p">.</span><span class="na">fate</span><span class="p">.</span><span class="na">ZooStore</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">getZooKeeperRoot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZFATE</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">context</span><span class="p">.</span><span class="na">getZooReaderWriter</span><span class="p">()),</span><span class="w"></span>
<span class="w">              </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">HOURS</span><span class="p">.</span><span class="na">toMillis</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">System</span><span class="p">::</span><span class="n">currentTimeMillis</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Fate</span><span class="o">&lt;</span><span class="n">Manager</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Fate</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">TraceRepo</span><span class="p">::</span><span class="n">toLogString</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">f</span><span class="p">.</span><span class="na">startTransactionRunners</span><span class="p">(</span><span class="n">getConfiguration</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">fateRef</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">f</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">fateReadyLatch</span><span class="p">.</span><span class="na">countDown</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="n">ThreadPools</span><span class="p">.</span><span class="na">watchCriticalScheduledTask</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getScheduledExecutor</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">scheduleWithFixedDelay</span><span class="p">(</span><span class="n">store</span><span class="p">::</span><span class="n">ageOff</span><span class="p">,</span><span class="w"> </span><span class="mi">63000</span><span class="p">,</span><span class="w"> </span><span class="mi">63000</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">KeeperException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Exception setting up FaTE cleanup thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">ThreadPools</span><span class="p">.</span><span class="na">watchCriticalScheduledTask</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getScheduledExecutor</span><span class="p">().</span><span class="na">scheduleWithFixedDelay</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ScanServerMetadataEntries</span><span class="p">.</span><span class="na">clean</span><span class="p">(</span><span class="n">context</span><span class="p">),</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="n">initializeZkForReplication</span><span class="p">(</span><span class="n">zReaderWriter</span><span class="p">,</span><span class="w"> </span><span class="n">zroot</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Make sure that we have a secret key (either a new one or an old one from ZK) before we start</span><span class="w"></span>
<span class="w">    </span><span class="c1">// the manager client service.</span><span class="w"></span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">authenticationTokenKeyManagerThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authenticationTokenKeyManager</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">keyDistributor</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Starting delegation-token key manager&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">keyDistributor</span><span class="p">.</span><span class="na">initialize</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">KeeperException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Exception setting up delegation-token key manager&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">authenticationTokenKeyManagerThread</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">Threads</span><span class="p">.</span><span class="na">createThread</span><span class="p">(</span><span class="s">&quot;Delegation Token Key Manager&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">authenticationTokenKeyManager</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">authenticationTokenKeyManagerThread</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="kt">boolean</span><span class="w"> </span><span class="n">logged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authenticationTokenKeyManager</span><span class="p">.</span><span class="na">isInitialized</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Print out a status message when we start waiting for the key manager to get initialized</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">logged</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Waiting for AuthenticationTokenKeyManager to be initialized&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">logged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">sleepUninterruptibly</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="c1">// And log when we are initialized</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;AuthenticationTokenSecretManager is initialized&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="p">.</span><span class="na">address</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Setting manager lock data to {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">managerLock</span><span class="p">.</span><span class="na">replaceLockData</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">KeeperException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Exception updating manager lock&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">clientService</span><span class="p">.</span><span class="na">isServing</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">sleepUninterruptibly</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// if the replication name is ever set, then start replication services</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">TServer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">replServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicReference</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ScheduledFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getScheduledExecutor</span><span class="p">().</span><span class="na">scheduleWithFixedDelay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;deprecation&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">Property</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Property</span><span class="p">.</span><span class="na">REPLICATION_NAME</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">replServer</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">getConfiguration</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">p</span><span class="p">).</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;{} was set, starting repl services.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">replServer</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">setupReplication</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnknownHostException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">KeeperException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Error occurred starting replication services. &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ThreadPools</span><span class="p">.</span><span class="na">watchNonCriticalScheduledTask</span><span class="p">(</span><span class="n">future</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// checking stored user hashes if any of them uses an outdated algorithm</span><span class="w"></span>
<span class="w">    </span><span class="n">security</span><span class="p">.</span><span class="na">validateStoredUserCreditentials</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// The manager is fully initialized. Clients are allowed to connect now.</span><span class="w"></span>
<span class="w">    </span><span class="n">managerInitialized</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">clientService</span><span class="p">.</span><span class="na">isServing</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">sleepUninterruptibly</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Shutting down fate.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">fate</span><span class="p">().</span><span class="na">shutdown</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">deadline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MAX_CLEANUP_WAIT_TIME</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">statusThread</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="n">remaining</span><span class="p">(</span><span class="n">deadline</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">replicationAssignerThread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">replicationAssignerThread</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="n">remaining</span><span class="p">(</span><span class="n">deadline</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">replicationWorkThread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">replicationWorkThread</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="n">remaining</span><span class="p">(</span><span class="n">deadline</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Exception stopping replication workers&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">nullableReplServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replServer</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nullableReplServer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">nullableReplServer</span><span class="p">.</span><span class="na">stop</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Signal that we want it to stop, and wait for it to do so.</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authenticationTokenKeyManager</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">authenticationTokenKeyManager</span><span class="p">.</span><span class="na">gracefulStop</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">authenticationTokenKeyManagerThread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">authenticationTokenKeyManagerThread</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="n">remaining</span><span class="p">(</span><span class="n">deadline</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Exception waiting on delegation-token key manager&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// quit, even if the tablet servers somehow jam up and the watchers</span><span class="w"></span>
<span class="w">    </span><span class="c1">// don&#39;t stop</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TabletGroupWatcher</span><span class="w"> </span><span class="n">watcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">watchers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">watcher</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="n">remaining</span><span class="p">(</span><span class="n">deadline</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Exception waiting on watcher&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;exiting&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Deprecated</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeZkForReplication</span><span class="p">(</span><span class="n">ZooReaderWriter</span><span class="w"> </span><span class="n">zReaderWriter</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">zroot</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">accumulo</span><span class="p">.</span><span class="na">server</span><span class="p">.</span><span class="na">replication</span><span class="p">.</span><span class="na">ZooKeeperInitialization</span><span class="w"></span>
<span class="w">          </span><span class="p">.</span><span class="na">ensureZooKeeperInitialized</span><span class="p">(</span><span class="n">zReaderWriter</span><span class="p">,</span><span class="w"> </span><span class="n">zroot</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">KeeperException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Exception while ensuring ZooKeeper is initialized&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Allows property configuration to block manager start-up waiting for a minimum number of</span>
<span class="cm">   * tservers to register in zookeeper. It also accepts a maximum time to wait - if the time</span>
<span class="cm">   * expires, the start-up will continue with any tservers available. This check is only performed</span>
<span class="cm">   * at manager initialization, when the manager acquires the lock. The following properties are</span>
<span class="cm">   * used to control the behaviour:</span>
<span class="cm">   * &lt;ul&gt;</span>
<span class="cm">   * &lt;li&gt;MANAGER_STARTUP_TSERVER_AVAIL_MIN_COUNT - when set to 0 or less, no blocking occurs</span>
<span class="cm">   * (default behaviour) otherwise will block until the number of tservers are available.&lt;/li&gt;</span>
<span class="cm">   * &lt;li&gt;MANAGER_STARTUP_TSERVER_AVAIL_MAX_WAIT - time to wait in milliseconds. When set to 0 or</span>
<span class="cm">   * less, will block indefinitely.&lt;/li&gt;</span>
<span class="cm">   * &lt;/ul&gt;</span>
<span class="cm">   *</span>
<span class="cm">   * @throws InterruptedException</span>
<span class="cm">   *           if interrupted while blocking, propagated for caller to handle.</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">blockForTservers</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">waitStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">minTserverCount</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">getConfiguration</span><span class="p">().</span><span class="na">getCount</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_STARTUP_TSERVER_AVAIL_MIN_COUNT</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">minTserverCount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;tserver availability check disabled, continuing with-{} servers. To enable, set {}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="w"> </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_STARTUP_TSERVER_AVAIL_MIN_COUNT</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">maxWait</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">getConfiguration</span><span class="p">().</span><span class="na">getTimeInMillis</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_STARTUP_TSERVER_AVAIL_MAX_WAIT</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maxWait</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;tserver availability check set to block indefinitely, To change, set {} &gt; 0.&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_STARTUP_TSERVER_AVAIL_MAX_WAIT</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">maxWait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// honor Retry condition that initial wait &lt; max wait, otherwise use small value to allow thread</span><span class="w"></span>
<span class="w">    </span><span class="c1">// yield to happen</span><span class="w"></span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">initialWait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="n">maxWait</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Retry</span><span class="w"> </span><span class="n">tserverRetry</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">Retry</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">infiniteRetries</span><span class="p">().</span><span class="na">retryAfter</span><span class="p">(</span><span class="n">initialWait</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="na">incrementBy</span><span class="p">(</span><span class="mi">15_000</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">).</span><span class="na">maxWait</span><span class="p">(</span><span class="n">maxWait</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="na">backOffFactor</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="na">logInterval</span><span class="p">(</span><span class="mi">30_000</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">).</span><span class="na">createRetry</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Checking for tserver availability - need to reach {} servers. Have {}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">minTserverCount</span><span class="p">,</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">needTservers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minTserverCount</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">needTservers</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tserverRetry</span><span class="p">.</span><span class="na">canRetry</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="n">tserverRetry</span><span class="p">.</span><span class="na">waitForNextAttempt</span><span class="p">(</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;block until minimum tservers reached&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">needTservers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minTserverCount</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// suppress last message once threshold reached.</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needTservers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;Blocking for tserver availability - need to reach {} servers. Have {}&quot;</span><span class="w"></span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; Time spent blocking {} sec.&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">minTserverCount</span><span class="p">,</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toSeconds</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">waitStart</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tserverSet</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minTserverCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;tserver availability check time expired - continuing. Requested {}, have {} tservers on line. &quot;</span><span class="w"></span>
<span class="w">              </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; Time waiting {} ms&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="w"> </span><span class="n">minTserverCount</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toSeconds</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">waitStart</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;tserver availability check completed. Requested {}, have {} tservers on line. &quot;</span><span class="w"></span>
<span class="w">              </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; Time waiting {} ms&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="w"> </span><span class="n">minTserverCount</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toSeconds</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">waitStart</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Deprecated</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">TServer</span><span class="w"> </span><span class="nf">setupReplication</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">throws</span><span class="w"> </span><span class="n">UnknownHostException</span><span class="p">,</span><span class="w"> </span><span class="n">KeeperException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ServerContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Start the replication coordinator which assigns tservers to service replication requests</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">impl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">accumulo</span><span class="p">.</span><span class="na">manager</span><span class="p">.</span><span class="na">replication</span><span class="p">.</span><span class="na">ManagerReplicationCoordinator</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ReplicationCoordinator</span><span class="p">.</span><span class="na">Iface</span><span class="w"> </span><span class="n">haReplicationProxy</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">HighlyAvailableServiceWrapper</span><span class="p">.</span><span class="na">service</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">ThriftProcessorTypes</span><span class="p">.</span><span class="na">getReplicationCoordinatorTProcessor</span><span class="p">(</span><span class="n">haReplicationProxy</span><span class="p">,</span><span class="w"> </span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="n">ServerAddress</span><span class="w"> </span><span class="n">replAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TServerUtils</span><span class="p">.</span><span class="na">startServer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">getHostname</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_REPLICATION_COORDINATOR_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">processor</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Manager Replication Coordinator&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;Replication Coordinator&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_REPLICATION_COORDINATOR_MINTHREADS</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_REPLICATION_COORDINATOR_THREADCHECK</span><span class="p">,</span><span class="w"> </span><span class="n">Property</span><span class="p">.</span><span class="na">GENERAL_MAX_MESSAGE_SIZE</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Started replication coordinator service at &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">replAddress</span><span class="p">.</span><span class="na">address</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Start the daemon to scan the replication table and make units of work</span><span class="w"></span>
<span class="w">    </span><span class="n">replicationWorkThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Threads</span><span class="p">.</span><span class="na">createThread</span><span class="p">(</span><span class="s">&quot;Replication Driver&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">accumulo</span><span class="p">.</span><span class="na">manager</span><span class="p">.</span><span class="na">replication</span><span class="p">.</span><span class="na">ReplicationDriver</span><span class="p">(</span><span class="k">this</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">replicationWorkThread</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Start the daemon to assign work to tservers to replicate to our peers</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">wd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">accumulo</span><span class="p">.</span><span class="na">manager</span><span class="p">.</span><span class="na">replication</span><span class="p">.</span><span class="na">WorkDriver</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">replicationAssignerThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Threads</span><span class="p">.</span><span class="na">createThread</span><span class="p">(</span><span class="n">wd</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">wd</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">replicationAssignerThread</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Advertise that port we used so peers don&#39;t have to be told what it is</span><span class="w"></span>
<span class="w">    </span><span class="n">context</span><span class="p">.</span><span class="na">getZooReaderWriter</span><span class="p">().</span><span class="na">putPersistentData</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">getZooKeeperRoot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">ZMANAGER_REPLICATION_COORDINATOR_ADDR</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">replAddress</span><span class="p">.</span><span class="na">address</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">getBytes</span><span class="p">(</span><span class="n">UTF_8</span><span class="p">),</span><span class="w"> </span><span class="n">NodeExistsPolicy</span><span class="p">.</span><span class="na">OVERWRITE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">replAddress</span><span class="p">.</span><span class="na">server</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">remaining</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">deadline</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">deadline</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">ServiceLock</span><span class="w"> </span><span class="nf">getManagerLock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">managerLock</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ManagerLockWatcher</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ServiceLock</span><span class="p">.</span><span class="na">AccumuloLockWatcher</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">acquiredLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">failedToAcquireLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">lostLock</span><span class="p">(</span><span class="n">LockLossReason</span><span class="w"> </span><span class="n">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Halt</span><span class="p">.</span><span class="na">halt</span><span class="p">(</span><span class="s">&quot;Manager lock in zookeeper lost (reason = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;), exiting!&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">unableToMonitorLockNode</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// ACCUMULO-3651 Changed level to error and added FATAL to message for slf4j compatibility</span><span class="w"></span>
<span class="w">      </span><span class="n">Halt</span><span class="p">.</span><span class="na">halt</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;FATAL: No longer able to monitor manager lock node&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">acquiredLock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Acquired manager lock&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">acquiredLock</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">failedToAcquireLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Halt</span><span class="p">.</span><span class="na">halt</span><span class="p">(</span><span class="s">&quot;Zoolock in unexpected state AL &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">acquiredLock</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">failedToAcquireLock</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">acquiredLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">notifyAll</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">failedToAcquireLock</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Failed to get manager lock&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">NoAuthException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Failed to acquire manager lock due to incorrect ZooKeeper authentication.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;{} Ensure instance.secret is consistent across Accumulo configuration&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Halt</span><span class="p">.</span><span class="na">halt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">acquiredLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Halt</span><span class="p">.</span><span class="na">halt</span><span class="p">(</span><span class="s">&quot;Zoolock in unexpected state FAL &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">acquiredLock</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">failedToAcquireLock</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">failedToAcquireLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">notifyAll</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">waitForChange</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">acquiredLock</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">failedToAcquireLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">wait</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getManagerLock</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">ServiceLockPath</span><span class="w"> </span><span class="n">zManagerLoc</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">throws</span><span class="w"> </span><span class="n">KeeperException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">zooKeeper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getZooReaderWriter</span><span class="p">().</span><span class="na">getZooKeeper</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;trying to get manager lock&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">managerClientAddress</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">getHostname</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">getConfiguration</span><span class="p">().</span><span class="na">getPort</span><span class="p">(</span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_CLIENTPORT</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">UUID</span><span class="w"> </span><span class="n">zooLockUUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="n">ManagerLockWatcher</span><span class="w"> </span><span class="n">managerLockWatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ManagerLockWatcher</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">managerLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceLock</span><span class="p">(</span><span class="n">zooKeeper</span><span class="p">,</span><span class="w"> </span><span class="n">zManagerLoc</span><span class="p">,</span><span class="w"> </span><span class="n">zooLockUUID</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">managerLock</span><span class="p">.</span><span class="na">lock</span><span class="p">(</span><span class="n">managerLockWatcher</span><span class="p">,</span><span class="w"> </span><span class="n">managerClientAddress</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">managerLockWatcher</span><span class="p">.</span><span class="na">waitForChange</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">managerLockWatcher</span><span class="p">.</span><span class="na">acquiredLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">managerLockWatcher</span><span class="p">.</span><span class="na">failedToAcquireLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;manager lock in unknown state&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">managerLock</span><span class="p">.</span><span class="na">tryToCancelAsyncLockOrUnlock</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="n">sleepUninterruptibly</span><span class="p">(</span><span class="n">TIME_TO_WAIT_BETWEEN_LOCK_CHECKS</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">HAVE_LOCK</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">LiveTServerSet</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deleted</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">added</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// if we have deleted or added tservers, then adjust our dead server list</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">deleted</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">added</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">DeadServerList</span><span class="w"> </span><span class="n">obit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DeadServerList</span><span class="p">(</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">added</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;New servers: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">added</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">added</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">obit</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">up</span><span class="p">.</span><span class="na">getHostPort</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">dead</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">deleted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;unexpected failure&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serversToShutdown</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">dead</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;clean shutdown&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// maybe an incorrect assumption</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">getManagerGoalState</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">ManagerGoalState</span><span class="p">.</span><span class="na">CLEAN_STOP</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">obit</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">dead</span><span class="p">.</span><span class="na">getHostPort</span><span class="p">(),</span><span class="w"> </span><span class="n">cause</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">unexpected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">deleted</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unexpected</span><span class="p">.</span><span class="na">removeAll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">serversToShutdown</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">unexpected</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">stillManager</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">getManagerGoalState</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">ManagerGoalState</span><span class="p">.</span><span class="na">CLEAN_STOP</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Lost servers {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">unexpected</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">serversToShutdown</span><span class="p">.</span><span class="na">removeAll</span><span class="p">(</span><span class="n">deleted</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">badServers</span><span class="p">.</span><span class="na">keySet</span><span class="p">().</span><span class="na">removeAll</span><span class="p">(</span><span class="n">deleted</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">// clear out any bad server with the same host/port as a new server</span><span class="w"></span>
<span class="w">      </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">badServers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">cleanListByHostAndPort</span><span class="p">(</span><span class="n">badServers</span><span class="p">.</span><span class="na">keySet</span><span class="p">(),</span><span class="w"> </span><span class="n">deleted</span><span class="p">,</span><span class="w"> </span><span class="n">added</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">serversToShutdown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">cleanListByHostAndPort</span><span class="p">(</span><span class="n">serversToShutdown</span><span class="p">,</span><span class="w"> </span><span class="n">deleted</span><span class="p">,</span><span class="w"> </span><span class="n">added</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">migrations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">KeyExtent</span><span class="p">,</span><span class="n">TServerInstance</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">migrations</span><span class="p">.</span><span class="na">entrySet</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">KeyExtent</span><span class="p">,</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deleted</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Canceling migration of {} to {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">iter</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">event</span><span class="p">(</span><span class="s">&quot;There are now %d tablet servers&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// clear out any servers that are no longer current</span><span class="w"></span>
<span class="w">    </span><span class="c1">// this is needed when we are using a fate operation to shutdown a tserver as it</span><span class="w"></span>
<span class="w">    </span><span class="c1">// will continue to add the server to the serversToShutdown (ACCUMULO-4410)</span><span class="w"></span>
<span class="w">    </span><span class="n">serversToShutdown</span><span class="p">.</span><span class="na">retainAll</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="na">getCurrentServers</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cleanListByHostAndPort</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">badServers</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deleted</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">added</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">badIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">badServers</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">badIter</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">bad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">badIter</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">added</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bad</span><span class="p">.</span><span class="na">getHostPort</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">add</span><span class="p">.</span><span class="na">getHostPort</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">badIter</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">del</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">deleted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bad</span><span class="p">.</span><span class="na">getHostPort</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="na">getHostPort</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">badIter</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stateChanged</span><span class="p">(</span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="p">,</span><span class="w"> </span><span class="n">TableState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">event</span><span class="p">(</span><span class="s">&quot;Table state in zookeeper changed for %s to %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tableId</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TableState</span><span class="p">.</span><span class="na">OFFLINE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">clearMigrations</span><span class="p">(</span><span class="n">tableId</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sessionExpired</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TableId</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">onlineTables</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TableId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">NORMAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">UNLOAD_METADATA_TABLETS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">MetadataTable</span><span class="p">.</span><span class="na">ID</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getManagerState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ManagerState</span><span class="p">.</span><span class="na">UNLOAD_ROOT_TABLET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">RootTable</span><span class="p">.</span><span class="na">ID</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">ServerContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">TableManager</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getTableManager</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getTableIdToNameMap</span><span class="p">().</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">TableState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="na">getTableState</span><span class="p">(</span><span class="n">tableId</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TableState</span><span class="p">.</span><span class="na">ONLINE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">tableId</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">onlineTabletServers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tserverSet</span><span class="p">.</span><span class="na">getCurrentServers</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">MergeInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">merges</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">MergeInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TableId</span><span class="w"> </span><span class="n">tableId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getTableIdToNameMap</span><span class="p">().</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">getMergeInfo</span><span class="p">(</span><span class="n">tableId</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// recovers state from the persistent transaction to shutdown a server</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">shutdownTServer</span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">event</span><span class="p">(</span><span class="s">&quot;Tablet Server shutdown requested for %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">serversToShutdown</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">EventCoordinator</span><span class="w"> </span><span class="nf">getEventCoordinator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nextEvent</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">VolumeManager</span><span class="w"> </span><span class="nf">getVolumeManager</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getContext</span><span class="p">().</span><span class="na">getVolumeManager</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">assignedTablet</span><span class="p">(</span><span class="n">KeyExtent</span><span class="w"> </span><span class="n">extent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">extent</span><span class="p">.</span><span class="na">isMeta</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">getManagerState</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">UNLOAD_ROOT_TABLET</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">UNLOAD_METADATA_TABLETS</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// probably too late, but try anyhow</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">extent</span><span class="p">.</span><span class="na">isRootTablet</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">getManagerState</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">STOP</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">setManagerState</span><span class="p">(</span><span class="n">ManagerState</span><span class="p">.</span><span class="na">UNLOAD_ROOT_TABLET</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@SuppressFBWarnings</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;UW_UNCOND_WAIT&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">justification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;TODO needs triage&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">waitForBalance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">balancedNotifier</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">long</span><span class="w"> </span><span class="n">eventCounter</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eventCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">waitForEvents</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">balancedNotifier</span><span class="p">.</span><span class="na">wait</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">displayUnassigned</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">migrations</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="o">||</span><span class="w"> </span><span class="n">eventCounter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nextEvent</span><span class="p">.</span><span class="na">waitForEvents</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">ManagerMonitorInfo</span><span class="w"> </span><span class="nf">getManagerMonitorInfo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ManagerMonitorInfo</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ManagerMonitorInfo</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">tServerInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">tableMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="p">,</span><span class="n">TabletServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">serverEntry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tserverStatus</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">TabletServerStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serverEntry</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">result</span><span class="p">.</span><span class="na">tServerInfo</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">status</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">TableInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">status</span><span class="p">.</span><span class="na">tableMap</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">TableInfoUtil</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">tableMap</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TableInfo</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">badTServers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">badServers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">bad</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">badServers</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">badTServers</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">bad</span><span class="p">.</span><span class="na">getHostPort</span><span class="p">(),</span><span class="w"> </span><span class="n">TabletServerState</span><span class="p">.</span><span class="na">UNRESPONSIVE</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getManagerState</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">goalState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getManagerGoalState</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">unassignedTablets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">displayUnassigned</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">serversShuttingDown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">serversToShutdown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TServerInstance</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">serversToShutdown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">serversShuttingDown</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="na">getHostPort</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">DeadServerList</span><span class="w"> </span><span class="n">obit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DeadServerList</span><span class="p">(</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">deadTabletServers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obit</span><span class="p">.</span><span class="na">getList</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">bulkImports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bulkImportStatus</span><span class="p">.</span><span class="na">getBulkLoadStatus</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Can delegation tokens be generated for users</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">delegationTokensAvailable</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">delegationTokensAvailable</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">KeyExtent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">migrationsSnapshot</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">KeyExtent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">migrationKeys</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">migrations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">migrationKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">migrations</span><span class="p">.</span><span class="na">keySet</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">unmodifiableSet</span><span class="p">(</span><span class="n">migrationKeys</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">shutdownServers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">serversToShutdown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">serversToShutdown</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateBulkImportStatus</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">directory</span><span class="p">,</span><span class="w"> </span><span class="n">BulkImportState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">bulkImportStatus</span><span class="p">.</span><span class="na">updateBulkImportStatus</span><span class="p">(</span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeBulkImportStatus</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">directory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">bulkImportStatus</span><span class="p">.</span><span class="na">removeBulkImportStatus</span><span class="p">(</span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="n">directory</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Return how long (in milliseconds) there has been a manager overseeing this cluster. This is an</span>
<span class="cm">   * approximately monotonic clock, which will be approximately consistent between different</span>
<span class="cm">   * managers or different runs of the same manager.</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">getSteadyTime</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">timeKeeper</span><span class="p">.</span><span class="na">getTime</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isActiveService</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">managerInitialized</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isUpgrading</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">managerUpgrading</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeBalancer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">localTabletBalancer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Property</span><span class="p">.</span><span class="na">createInstanceFromPropertyName</span><span class="p">(</span><span class="n">getConfiguration</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">Property</span><span class="p">.</span><span class="na">MANAGER_TABLET_BALANCER</span><span class="p">,</span><span class="w"> </span><span class="n">TabletBalancer</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleLoadBalancer</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">localTabletBalancer</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">balancerEnvironment</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">tabletBalancer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localTabletBalancer</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">getBalancerClass</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tabletBalancer</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">getAssignments</span><span class="p">(</span><span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">TServerInstance</span><span class="p">,</span><span class="n">TabletServerStatus</span><span class="o">&gt;</span><span class="w"> </span><span class="n">currentStatus</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">KeyExtent</span><span class="p">,</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">unassigned</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">KeyExtent</span><span class="p">,</span><span class="n">TServerInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">assignedOut</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AssignmentParamsImpl</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">AssignmentParamsImpl</span><span class="p">.</span><span class="na">fromThrift</span><span class="p">(</span><span class="n">currentStatus</span><span class="p">,</span><span class="w"> </span><span class="n">unassigned</span><span class="p">,</span><span class="w"> </span><span class="n">assignedOut</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">tabletBalancer</span><span class="p">.</span><span class="na">getAssignments</span><span class="p">(</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</body>
</html>
