<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/* (c) 2014 - 2016 Open Source Geospatial Foundation - all rights reserved</span>
<span class="cm"> * (c) 2001 - 2014 OpenPlans</span>
<span class="cm"> * This code is licensed under the GPL 2.0 license, available at the root</span>
<span class="cm"> * application directory.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kn">package</span><span class="w"> </span><span class="nn">org.geoserver.wms</span><span class="p">;</span><span class="w"></span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">org.geoserver.util.HTTPWarningAppender.addWarning</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.awt.geom.AffineTransform</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.awt.geom.NoninvertibleTransformException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.awt.geom.Point2D</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.charset.Charset</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Arrays</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collections</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Date</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashSet</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Set</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.TreeSet</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.logging.Level</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.logging.Logger</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.AttributeTypeInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.Catalog</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.CoverageInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.DimensionInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.DimensionPresentation</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.FeatureTypeInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.LayerGroupHelper</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.LayerGroupInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.LayerInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.MetadataMap</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.NamespaceInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.PublishedInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.PublishedType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.ResourceInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.StyleInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.WMSLayerInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.WMTSLayerInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.impl.AdvertisedCatalog</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.catalog.util.ReaderDimensionsAccessor</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.config.GeoServer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.config.GeoServerInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.config.JAIInfo</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.data.DimensionFilterBuilder</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.data.util.CoverageUtils</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.platform.GeoServerExtensions</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.platform.ServiceException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.util.DimensionWarning</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.util.NearestMatchFinder</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.wms.WMSInfo.WMSInterpolation</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.wms.WatermarkInfo.Position</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.wms.dimension.DimensionDefaultValueSelectionStrategy</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.wms.dimension.DimensionDefaultValueSelectionStrategyFactory</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.wms.featureinfo.GetFeatureInfoOutputFormat</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.wms.map.RenderedImageMapOutputFormat</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geoserver.wms.map.RenderedImageMapResponse</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.coverage.grid.io.GridCoverage2DReader</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.data.FeatureSource</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.data.Query</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.data.ows.OperationType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.factory.CommonFactoryFinder</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.feature.FeatureCollection</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.feature.visitor.CalcResult</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.feature.visitor.MaxVisitor</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.feature.visitor.MinVisitor</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.feature.visitor.UniqueVisitor</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.geometry.jts.ReferencedEnvelope</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.ows.wms.Layer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.ows.wms.WMSCapabilities</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.referencing.CRS</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.referencing.CRS.AxisOrder</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.styling.Style</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.util.Converters</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.util.DateRange</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.util.NumberRange</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.util.Range</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.util.SuppressFBWarnings</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.util.Version</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.util.decorate.Wrapper</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.util.factory.GeoTools</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.geotools.util.logging.Logging</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.locationtech.jts.geom.Coordinate</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.locationtech.jts.geom.Geometry</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.feature.type.Name</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.filter.Filter</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.filter.FilterFactory</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.filter.PropertyIsBetween</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.filter.expression.PropertyName</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.filter.sort.SortBy</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.parameter.GeneralParameterDescriptor</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.parameter.GeneralParameterValue</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.parameter.ParameterDescriptor</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.parameter.ParameterValue</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.parameter.ParameterValueGroup</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.opengis.referencing.crs.CoordinateReferenceSystem</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.BeansException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.ApplicationContext</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.ApplicationContextAware</span><span class="p">;</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * A facade providing access to the WMS configuration details</span>
<span class="cm"> *</span>
<span class="cm"> * @author Gabriel Roldan</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WMS</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ApplicationContextAware</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="n">VERSION_1_1_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Version</span><span class="p">(</span><span class="s">&quot;1.1.1&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="n">VERSION_1_3_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Version</span><span class="p">(</span><span class="s">&quot;1.3.0&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">JPEG_COMPRESSION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;jpegCompression&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">JPEG_COMPRESSION_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">PNG_COMPRESSION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pngCompression&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">PNG_COMPRESSION_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">SCALEHINT_MAPUNITS_PIXEL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;scalehintMapunitsPixel&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">SCALEHINT_MAPUNITS_PIXEL_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">FALSE</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">DYNAMIC_STYLING_DISABLED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dynamicStylingDisabled&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">FEATURES_REPROJECTION_DISABLED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;featuresReprojectionDisabled&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logging</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">WMS</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">WEB_CONTAINER_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;WMS&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** SVG renderers. */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">SVG_SIMPLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Simple&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">SVG_BATIK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Batik&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** KML reflector mode */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_REFLECTOR_MODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;kmlReflectorMode&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** KML reflector mode values */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_REFLECTOR_MODE_REFRESH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;refresh&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_REFLECTOR_MODE_SUPEROVERLAY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;superoverlay&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_REFLECTOR_MODE_DOWNLOAD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;download&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_REFLECTOR_MODE_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KML_REFLECTOR_MODE_REFRESH</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** KML superoverlay sub-mode */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_SUPEROVERLAY_MODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;kmlSuperoverlayMode&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_SUPEROVERLAY_MODE_AUTO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;auto&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_SUPEROVERLAY_MODE_RASTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;raster&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_SUPEROVERLAY_MODE_OVERVIEW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;overview&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_SUPEROVERLAY_MODE_HYBRID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hybrid&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_SUPEROVERLAY_MODE_CACHED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;cached&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_SUPEROVERLAY_MODE_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KML_SUPEROVERLAY_MODE_AUTO</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_KMLATTR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;kmlAttr&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">KML_KMLATTR_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_KMLPLACEMARK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;kmlPlacemark&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">KML_KMLPLACEMARK_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KML_KMSCORE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;kmlKmscore&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">KML_KMSCORE_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Enable continuous map wrapping (global sys var) */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">ENABLE_MAP_WRAPPING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Continuous map wrapping key */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">MAP_WRAPPING_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mapWrapping&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Enable advanced projection handling */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">ENABLE_ADVANCED_PROJECTION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Advanced projection key */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ADVANCED_PROJECTION_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;advancedProjectionHandling&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Enable advanced projection handling */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">ENABLE_ADVANCED_PROJECTION_DENSIFICATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Advanced projection densification key */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ADVANCED_PROJECTION_DENSIFICATION_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;advancedProjectionDensification&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Disable DateLine Wrapping Heuristic. */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">DISABLE_DATELINE_WRAPPING_HEURISTIC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** DateLine Wrapping Heuristic key */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">DATELINE_WRAPPING_HEURISTIC_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;disableDatelineWrappingHeuristic&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Capabilities will be produced with a root Layer element, only when needed (there is no single</span>
<span class="cm">     * top layer element) *</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">ROOT_LAYER_IN_CAPABILITIES_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Root Layer in Capabilities key * */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ROOT_LAYER_IN_CAPABILITIES_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rootLayerInCapabilities&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** GIF disposal methods */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">DISPOSAL_METHOD_NONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;none&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">DISPOSAL_METHOD_NOT_DISPOSE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;doNotDispose&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">DISPOSAL_METHOD_BACKGROUND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;backgroundColor&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">DISPOSAL_METHOD_PREVIOUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;previous&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">DISPOSAL_METHOD_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DISPOSAL_METHOD_NONE</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">DISPOSAL_METHODS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DISPOSAL_METHOD_NONE</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DISPOSAL_METHOD_NOT_DISPOSE</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DISPOSAL_METHOD_BACKGROUND</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DISPOSAL_METHOD_PREVIOUS</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FilterFactory</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CommonFactoryFinder</span><span class="p">.</span><span class="na">getFilterFactory</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">GeoServer</span><span class="w"> </span><span class="n">geoserver</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">DimensionDefaultValueSelectionStrategyFactory</span><span class="w"> </span><span class="n">defaultDimensionValueFactory</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">WMS</span><span class="p">(</span><span class="n">GeoServer</span><span class="w"> </span><span class="n">geoserver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">geoserver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">geoserver</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Catalog</span><span class="w"> </span><span class="nf">getCatalog</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">geoserver</span><span class="p">.</span><span class="na">getCatalog</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">WMSInfo</span><span class="w"> </span><span class="nf">getServiceInfo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">geoserver</span><span class="p">.</span><span class="na">getService</span><span class="p">(</span><span class="n">WMSInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Style</span><span class="w"> </span><span class="nf">getStyleByName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">styleName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">StyleInfo</span><span class="w"> </span><span class="n">styleInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">().</span><span class="na">getStyleByName</span><span class="p">(</span><span class="n">styleName</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">styleInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">styleInfo</span><span class="p">.</span><span class="na">getStyle</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">LayerInfo</span><span class="w"> </span><span class="nf">getLayerByName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">layerName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">().</span><span class="na">getLayerByName</span><span class="p">(</span><span class="n">layerName</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">LayerGroupInfo</span><span class="w"> </span><span class="nf">getLayerGroupByName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">layerGroupName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">().</span><span class="na">getLayerGroupByName</span><span class="p">(</span><span class="n">layerGroupName</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WMSInfo</span><span class="w"> </span><span class="n">serviceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">serviceInfo</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * /** Returns a supported version according to the version negotiation rules in section 6.2.4</span>
<span class="cm">     * of the WMS 1.3.0 spec.</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;p&gt;Calls through to {@link #negotiateVersion(Version)}.</span>
<span class="cm">     *</span>
<span class="cm">     * @param requestedVersion The version, may be bull.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="nf">negotiateVersion</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">requestedVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">negotiateVersion</span><span class="p">(</span><span class="n">requestedVersion</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Version</span><span class="p">(</span><span class="n">requestedVersion</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns a supported version according to the version negotiation rules in section 6.2.4 of</span>
<span class="cm">     * the WMS 1.3.0 spec.</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;p&gt;For instance: &lt;u&gt;</span>
<span class="cm">     * &lt;li&gt;request version not provided? -&gt; higher version supported</span>
<span class="cm">     * &lt;li&gt;requested version supported? -&gt; that same version</span>
<span class="cm">     * &lt;li&gt;requested version &lt; lowest supported version? -&gt; lowest supported</span>
<span class="cm">     * &lt;li&gt;requested version &gt; lowest supported version? -&gt; higher supported version that&#39;s lower</span>
<span class="cm">     *     than the requested version &lt;/u&gt;</span>
<span class="cm">     *</span>
<span class="cm">     * @param requestedVersion the request version, or {@code null} if unspecified</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="nf">negotiateVersion</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="n">requestedVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">requestedVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">VERSION_1_3_0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VERSION_1_1_1</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">requestedVersion</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">VERSION_1_1_1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VERSION_1_3_0</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">requestedVersion</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">VERSION_1_3_0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requestedVersion</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">VERSION_1_3_0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">VERSION_1_1_1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">VERSION_1_3_0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WMSInfo</span><span class="w"> </span><span class="n">serviceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Version</span><span class="o">&gt;</span><span class="w"> </span><span class="n">versions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serviceInfo</span><span class="p">.</span><span class="na">getVersions</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">versions</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// shouldn&#39;t a version be set?</span><span class="w"></span>
<span class="w">            </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1.1.1&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">versions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">GeoServer</span><span class="w"> </span><span class="nf">getGeoServer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">geoserver</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">WMSInterpolation</span><span class="w"> </span><span class="nf">getInterpolation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getInterpolation</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDynamicStylingDisabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">isDynamicStylingDisabled</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * If TRUE is returned GetFeatureInfo results should NOT be reproject to the map coordinate</span>
<span class="cm">     * reference system.</span>
<span class="cm">     *</span>
<span class="cm">     * @return GetFeatureInfo results reprojection allowance</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isFeaturesReprojectionDisabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">isFeaturesReprojectionDisabled</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JAIInfo</span><span class="p">.</span><span class="na">PngEncoderType</span><span class="w"> </span><span class="nf">getPNGEncoderType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">JAIInfo</span><span class="w"> </span><span class="n">jaiInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getJaiInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">jaiInfo</span><span class="p">.</span><span class="na">getPngEncoderType</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">getJPEGNativeAcceleration</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">JAIInfo</span><span class="w"> </span><span class="n">jaiInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getJaiInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">jaiInfo</span><span class="p">.</span><span class="na">isJpegAcceleration</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">JAIInfo</span><span class="w"> </span><span class="nf">getJaiInfo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">GeoServer</span><span class="w"> </span><span class="n">geoServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getGeoServer</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">GeoServerInfo</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">geoServer</span><span class="p">.</span><span class="na">getGlobal</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">global</span><span class="p">.</span><span class="na">getJAI</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Charset</span><span class="w"> </span><span class="nf">getCharSet</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">GeoServer</span><span class="w"> </span><span class="n">geoServer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getGeoServer</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">geoServer2</span><span class="p">.</span><span class="na">getSettings</span><span class="p">().</span><span class="na">getCharset</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Charset</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">charset</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getProxyBaseUrl</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">GeoServer</span><span class="w"> </span><span class="n">geoServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getGeoServer</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">geoServer</span><span class="p">.</span><span class="na">getSettings</span><span class="p">().</span><span class="na">getProxyBaseUrl</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">getUpdateSequence</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">GeoServerInfo</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getGeoServer</span><span class="p">().</span><span class="na">getGlobal</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">global</span><span class="p">.</span><span class="na">getUpdateSequence</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getWatermarkTransparency</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WatermarkInfo</span><span class="w"> </span><span class="n">watermark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getWatermark</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">watermark</span><span class="p">.</span><span class="na">getTransparency</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getWatermarkPosition</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WatermarkInfo</span><span class="w"> </span><span class="n">watermark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getWatermark</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Position</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">watermark</span><span class="p">.</span><span class="na">getPosition</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isGlobalWatermarking</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WatermarkInfo</span><span class="w"> </span><span class="n">watermark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getWatermark</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">watermark</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getGlobalWatermarkingURL</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WatermarkInfo</span><span class="w"> </span><span class="n">watermark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getWatermark</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">watermark</span><span class="p">.</span><span class="na">getURL</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isRemoteStylesCacheEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">CacheConfiguration</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getCacheConfiguration</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CacheConfiguration</span><span class="w"> </span><span class="nf">getRemoteResourcesCacheConfiguration</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getCacheConfiguration</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setRemoteResourcesCacheConfiguration</span><span class="p">(</span><span class="n">CacheConfiguration</span><span class="w"> </span><span class="n">cacheCfg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">setCacheConfiguration</span><span class="p">(</span><span class="n">cacheCfg</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="nf">getFeatureTypeInfo</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Catalog</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">getResourceByName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">FeatureTypeInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">resource</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CoverageInfo</span><span class="w"> </span><span class="nf">getCoverageInfo</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Catalog</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">CoverageInfo</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">getResourceByName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">resource</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">WMSLayerInfo</span><span class="w"> </span><span class="nf">getWMSLayerInfo</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Catalog</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">WMSLayerInfo</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">getResourceByName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">WMSLayerInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">resource</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="w"> </span><span class="nf">getResourceInfo</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Catalog</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">ResourceInfo</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">getResourceByName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">resource</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">LayerInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getLayers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Catalog</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">getLayers</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getNamespaceByPrefix</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">prefix</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Catalog</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">NamespaceInfo</span><span class="w"> </span><span class="n">namespaceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">getNamespaceByPrefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">namespaceInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">namespaceInfo</span><span class="p">.</span><span class="na">getURI</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">LayerGroupInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getLayerGroups</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Catalog</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">LayerGroupInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">layerGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">getLayerGroups</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">layerGroups</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Informs the user that this WMS supports SLD. We don&#39;t currently handle sld, still needs to be</span>
<span class="cm">     * rolled in from geotools, so this now must be false.</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;p&gt;//djb: we support it now</span>
<span class="cm">     *</span>
<span class="cm">     * @return false</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">supportsSLD</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// djb: we support it now</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Informs the user that this WMS supports User Layers</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;p&gt;We support this both remote wfs and inlineFeature</span>
<span class="cm">     *</span>
<span class="cm">     * @return true</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">supportsUserLayer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Informs the user that this WMS supports User Styles</span>
<span class="cm">     *</span>
<span class="cm">     * @return true</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">supportsUserStyle</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Informs the user that this WMS supports Remote WFS.</span>
<span class="cm">     *</span>
<span class="cm">     * @return true</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">supportsRemoteWFS</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSvgRenderer</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">svgRendererHint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WMSInfo</span><span class="w"> </span><span class="n">serviceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">serviceInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;svgRenderer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">svgRendererHint</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">getGeoServer</span><span class="p">().</span><span class="na">save</span><span class="p">(</span><span class="n">serviceInfo</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getSvgRenderer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WMSInfo</span><span class="w"> </span><span class="n">serviceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">svgRendererHint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">serviceInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;svgRenderer&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">svgRendererHint</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isSvgAntiAlias</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WMSInfo</span><span class="w"> </span><span class="n">serviceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">svgAntiAlias</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">Converters</span><span class="p">.</span><span class="na">convert</span><span class="p">(</span><span class="n">serviceInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;svgAntiAlias&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">svgAntiAlias</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">svgAntiAlias</span><span class="p">.</span><span class="na">booleanValue</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getPngCompression</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WMSInfo</span><span class="w"> </span><span class="n">serviceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getMetadataPercentage</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">serviceInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(),</span><span class="w"> </span><span class="n">PNG_COMPRESSION</span><span class="p">,</span><span class="w"> </span><span class="n">PNG_COMPRESSION_DEFAULT</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getJpegCompression</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">WMSInfo</span><span class="w"> </span><span class="n">serviceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getMetadataPercentage</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">serviceInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(),</span><span class="w"> </span><span class="n">JPEG_COMPRESSION</span><span class="p">,</span><span class="w"> </span><span class="n">JPEG_COMPRESSION_DEFAULT</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Checks if continuous map wrapping is enabled or not */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isContinuousMapWrappingEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// for backwards compatibility we set the config value to the sys variable one if set, but</span><span class="w"></span>
<span class="w">        </span><span class="c1">// once set, the config wins</span><span class="w"></span>
<span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMetadataValue</span><span class="p">(</span><span class="n">MAP_WRAPPING_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE_MAP_WRAPPING</span><span class="p">,</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">enabled</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Checks if advanced projection handling is enabled or not */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAdvancedProjectionHandlingEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// for backwards compatibility we set the config value to the sys variable one if set, but</span><span class="w"></span>
<span class="w">        </span><span class="c1">// once set, the config wins</span><span class="w"></span>
<span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">getMetadataValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">ADVANCED_PROJECTION_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE_ADVANCED_PROJECTION</span><span class="p">,</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">enabled</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAdvancedProjectionDensificationEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">getMetadataValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">ADVANCED_PROJECTION_DENSIFICATION_KEY</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">ENABLE_ADVANCED_PROJECTION_DENSIFICATION</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">enabled</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDateLineWrappingHeuristicDisabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">getMetadataValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">DATELINE_WRAPPING_HEURISTIC_KEY</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">DISABLE_DATELINE_WRAPPING_HEURISTIC</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">disabled</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isRootLayerInCapabilitesEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getMetadataValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">ROOT_LAYER_IN_CAPABILITIES_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">ROOT_LAYER_IN_CAPABILITIES_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">getScalehintUnitPixel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getMetadataValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">SCALEHINT_MAPUNITS_PIXEL</span><span class="p">,</span><span class="w"> </span><span class="n">SCALEHINT_MAPUNITS_PIXEL_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">getMetadataPercentage</span><span class="p">(</span><span class="n">MetadataMap</span><span class="w"> </span><span class="n">metadata</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">parsedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converters</span><span class="p">.</span><span class="na">convert</span><span class="p">(</span><span class="n">metadata</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parsedValue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parsedValue</span><span class="p">.</span><span class="na">intValue</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">warning</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Invalid percertage value for &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;, it should be between 0 and 100&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">getMetadataValue</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getServiceInfo</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">MetadataMap</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMetadata</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="n">T</span><span class="w"> </span><span class="n">parsedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converters</span><span class="p">.</span><span class="na">convert</span><span class="p">(</span><span class="n">metadata</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="w"> </span><span class="n">clazz</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parsedValue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">parsedValue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getNumDecimals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getGeoServer</span><span class="p">().</span><span class="na">getSettings</span><span class="p">().</span><span class="na">getNumDecimals</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getNameSpacePrefix</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nsUri</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Catalog</span><span class="w"> </span><span class="n">catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCatalog</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">NamespaceInfo</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catalog</span><span class="p">.</span><span class="na">getNamespaceByURI</span><span class="p">(</span><span class="n">nsUri</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ns</span><span class="p">.</span><span class="na">getPrefix</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getMaxBuffer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMaxBuffer</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getMaxRequestMemory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMaxRequestMemory</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getMaxRenderingTime</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMaxRenderingTime</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getMaxRenderingErrors</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMaxRenderingErrors</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns the maximum number of requested dimension values, picking from the appropriate</span>
<span class="cm">     * service configuration</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getMaxRequestedDimensionValues</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMaxRequestedDimensionValues</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getKmlReflectorMode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">KML_REFLECTOR_MODE</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">KML_REFLECTOR_MODE_DEFAULT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getKmlSuperoverlayMode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">KML_SUPEROVERLAY_MODE</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">KML_SUPEROVERLAY_MODE_DEFAULT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">getKmlKmAttr</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">kmAttr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">Converters</span><span class="p">.</span><span class="na">convert</span><span class="p">(</span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">KML_KMLATTR</span><span class="p">),</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">kmAttr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">KML_KMLATTR_DEFAULT</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">kmAttr</span><span class="p">.</span><span class="na">booleanValue</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">getKmlPlacemark</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">kmAttr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">Converters</span><span class="p">.</span><span class="na">convert</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">KML_KMLPLACEMARK</span><span class="p">),</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">kmAttr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">KML_KMLPLACEMARK_DEFAULT</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">kmAttr</span><span class="p">.</span><span class="na">booleanValue</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getKmScore</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getMetadataPercentage</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getMetadata</span><span class="p">(),</span><span class="w"> </span><span class="n">KML_KMSCORE</span><span class="p">,</span><span class="w"> </span><span class="n">KML_KMSCORE_DEFAULT</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Returns all allowed map output formats. */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">GetMapOutputFormat</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllowedMapFormats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GetMapOutputFormat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">GetMapOutputFormat</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findMapProducers</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isAllowedGetMapFormat</span><span class="p">(</span><span class="n">producer</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">producer</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Returns all map output formats. */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">GetMapOutputFormat</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAvailableMapFormats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findMapProducers</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Grabs the list of allowed MIME-Types for the GetMap operation from the set of {@link</span>
<span class="cm">     * GetMapOutputFormat}s registered in the application context.</span>
<span class="cm">     *</span>
<span class="cm">     * @see GetMapOutputFormat#getContentType()</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAvailableMapFormatNames</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">GetMapOutputFormat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">producers</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findMapProducers</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">formats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">GetMapOutputFormat</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">producers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">formats</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">producer</span><span class="p">.</span><span class="na">getOutputFormatNames</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">formats</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** @return all allowed GetMap format names */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllowedMapFormatNames</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">GetMapOutputFormat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">producers</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findMapProducers</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">formats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">GetMapOutputFormat</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">producers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isAllowedGetMapFormat</span><span class="p">(</span><span class="n">producer</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="c1">// skip this producer, its mime type is not allowed</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">formats</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">producer</span><span class="p">.</span><span class="na">getOutputFormatNames</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">formats</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Checks is a getMap mime type is allowed */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAllowedGetMapFormat</span><span class="p">(</span><span class="n">GetMapOutputFormat</span><span class="w"> </span><span class="n">format</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">isGetMapMimeTypeCheckingEnabled</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mimeTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getGetMapMimeTypes</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mimeTypes</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="na">getMimeType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Checks is a getFeatureInfo mime type is allowed */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAllowedGetFeatureInfoFormat</span><span class="p">(</span><span class="n">GetFeatureInfoOutputFormat</span><span class="w"> </span><span class="n">format</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">isGetFeatureInfoMimeTypeCheckingEnabled</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mimeTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getGetFeatureInfoMimeTypes</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mimeTypes</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="na">getContentType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** create a {@link ServiceException} for an unallowed GetFeatureInfo format */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ServiceException</span><span class="w"> </span><span class="nf">unallowedGetFeatureInfoFormatException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">requestFormat</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ServiceException</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="s">&quot;Getting feature info using &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">requestFormat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is not allowed&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="s">&quot;ForbiddenFormat&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">setCode</span><span class="p">(</span><span class="s">&quot;ForbiddenFormat&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** create a {@link ServiceException} for an unallowed GetMap format */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ServiceException</span><span class="w"> </span><span class="nf">unallowedGetMapFormatException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">requestFormat</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ServiceException</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="s">&quot;Creating maps using &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">requestFormat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is not allowed&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="s">&quot;ForbiddenFormat&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">setCode</span><span class="p">(</span><span class="s">&quot;ForbiddenFormat&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAvailableLegendGraphicsFormats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GetLegendGraphicOutputFormat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">formats</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findLegendGraphicFormats</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mimeTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">GetLegendGraphicOutputFormat</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">formats</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">mimeTypes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="na">getContentType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mimeTypes</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Returns all {@link ExtendedCapabilitiesProvider} extensions. */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ExtendedCapabilitiesProvider</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAvailableExtendedCapabilitiesProviders</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findExtendedCapabilitiesProviders</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="nd">@SuppressFBWarnings</span><span class="p">(</span><span class="s">&quot;LI_LAZY_INIT_STATIC&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// method is not called by multiple threads</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setApplicationContext</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// get the default dimension value selector factory, picking the one with</span><span class="w"></span>
<span class="w">        </span><span class="c1">// the highest priority (this allows for plugin overrides)</span><span class="w"></span>
<span class="w">        </span><span class="n">defaultDimensionValueFactory</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">GeoServerExtensions</span><span class="p">.</span><span class="na">extensions</span><span class="p">(</span><span class="n">DimensionDefaultValueSelectionStrategyFactory</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// enable/disable map wrapping</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ENABLE_MAP_WRAPPING</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">wrapping</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">GeoServerExtensions</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&quot;ENABLE_MAP_WRAPPING&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// default to true, but allow switching off</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wrapping</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">ENABLE_MAP_WRAPPING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="n">ENABLE_MAP_WRAPPING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">wrapping</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// enable/disable advanced reprojection handling</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ENABLE_ADVANCED_PROJECTION</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">projection</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">GeoServerExtensions</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="s">&quot;ENABLE_ADVANCED_PROJECTION&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// default to true, but allow switching off</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">projection</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">ENABLE_ADVANCED_PROJECTION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="n">ENABLE_ADVANCED_PROJECTION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">projection</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * @return a {@link GetFeatureInfoOutputFormat} that can handle the requested mime type or</span>
<span class="cm">     *     {@code null} if none if found</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">GetFeatureInfoOutputFormat</span><span class="w"> </span><span class="nf">getFeatureInfoOutputFormat</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">requestFormat</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GetFeatureInfoOutputFormat</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outputFormats</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findFeatureInfoFormats</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">GetFeatureInfoOutputFormat</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">outputFormats</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="na">canProduce</span><span class="p">(</span><span class="n">requestFormat</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">format</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** @return a list of all getFeatureInfo content types */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAvailableFeatureInfoFormats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mimeTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">GetFeatureInfoOutputFormat</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findFeatureInfoFormats</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">mimeTypes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="na">getContentType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mimeTypes</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** @return a list of all allowed getFeature info content types */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllowedFeatureInfoFormats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mimeTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">GetFeatureInfoOutputFormat</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findFeatureInfoFormats</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isAllowedGetFeatureInfoFormat</span><span class="p">(</span><span class="n">format</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="c1">// skip this format</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">mimeTypes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="na">getContentType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mimeTypes</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** @return a list of allowed remote SLD Urls for AuthorizationHeader forwarding. */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllowedURLsForAuthForwarding</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">getAllowedURLsForAuthForwarding</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * @param mimeType the mime type to look a GetMapOutputFormat for</span>
<span class="cm">     * @return the GetMapOutputFormat that can handle {@code mimeType}, or {@code null} if none is</span>
<span class="cm">     *     found</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">GetMapOutputFormat</span><span class="w"> </span><span class="nf">getMapOutputFormat</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">mimeType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">GetMapOutputFormat</span><span class="w"> </span><span class="n">outputFormat</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findMapProducer</span><span class="p">(</span><span class="n">mimeType</span><span class="p">,</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">outputFormat</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * @param outputFormat desired output format mime type</span>
<span class="cm">     * @return the GetLegendGraphicOutputFormat that can handle {@code mimeType}, or {@code null} if</span>
<span class="cm">     *     none is found</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">GetLegendGraphicOutputFormat</span><span class="w"> </span><span class="nf">getLegendGraphicOutputFormat</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">outputFormat</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">GetLegendGraphicOutputFormat</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findLegendGraphicFormat</span><span class="p">(</span><span class="n">outputFormat</span><span class="p">,</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">format</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns a version object for the specified version string.</span>
<span class="cm">     * &lt;p&gt;</span>
<span class="cm">     * Calls through to {@link #version(String, boolean)} with exact set to &lt;code&gt;false&lt;/false&gt;.</span>
<span class="cm">     * &lt;/p&gt;</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="nf">version</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">version</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">version</span><span class="p">(</span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns a version object for the specified version string optionally returning null when the</span>
<span class="cm">     * version string does not match one of the available WMS versions.</span>
<span class="cm">     *</span>
<span class="cm">     * @param version The version string.</span>
<span class="cm">     * @param exact If set to false, a version object will always be returned. If set to true only a</span>
<span class="cm">     *     version matching on of the available wms versions will be returned.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="nf">version</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exact</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">version</span><span class="p">.</span><span class="na">trim</span><span class="p">().</span><span class="na">length</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VERSION_1_1_1</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">version</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">VERSION_1_1_1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VERSION_1_3_0</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">version</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">VERSION_1_3_0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">exact</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Version</span><span class="p">(</span><span class="n">version</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Transforms a crs identifier to its internal representation based on the specified WMS</span>
<span class="cm">     * version.</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;p&gt;In version 1.3 of WMS geographic coordinate systems are to be ordered y/x or</span>
<span class="cm">     * latitude/longitude. The only possible way to represent this internally is to use the explicit</span>
<span class="cm">     * epsg namespace &quot;urn:x-ogc:def:crs:EPSG:&quot;. This method essentially replaces the traditional</span>
<span class="cm">     * &quot;EPSG:&quot; namespace with the explicit.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">toInternalSRS</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">srs</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="n">version</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VERSION_1_3_0</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">version</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">srs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">srs</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">().</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&quot;EPSG:&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">srs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srs</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">().</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;EPSG:&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;urn:ogc:def:crs:EPSG:&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">srs</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Returns true if the layer can be queried */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isQueryable</span><span class="p">(</span><span class="n">LayerInfo</span><span class="w"> </span><span class="n">layer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="na">getResource</span><span class="p">()</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">WMSLayerInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSLayerInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WMSLayerInfo</span><span class="p">)</span><span class="w"> </span><span class="n">layer</span><span class="p">.</span><span class="na">getResource</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">Layer</span><span class="w"> </span><span class="n">wl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">getWMSLayer</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">.</span><span class="na">isQueryable</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">WMSCapabilities</span><span class="w"> </span><span class="n">caps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">getStore</span><span class="p">().</span><span class="na">getWebMapServer</span><span class="p">(</span><span class="kc">null</span><span class="p">).</span><span class="na">getCapabilities</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">OperationType</span><span class="w"> </span><span class="n">featureInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">caps</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getGetFeatureInfo</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">featureInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">                        </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">featureInfo</span><span class="p">.</span><span class="na">getFormats</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;application/vnd.ogc.gml&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="na">getResource</span><span class="p">()</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">WMTSLayerInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">layer</span><span class="p">.</span><span class="na">isQueryable</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">Level</span><span class="p">.</span><span class="na">INFO</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Failed to determine if the layer is queryable, assuming it&#39;s not&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Returns true if the layer is opaque */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isOpaque</span><span class="p">(</span><span class="n">LayerInfo</span><span class="w"> </span><span class="n">layer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">layer</span><span class="p">.</span><span class="na">isOpaque</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="nf">getCascadedHopCount</span><span class="p">(</span><span class="n">LayerInfo</span><span class="w"> </span><span class="n">layer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="na">getResource</span><span class="p">()</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">WMSLayerInfo</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">WMSLayerInfo</span><span class="w"> </span><span class="n">wmsLayerInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WMSLayerInfo</span><span class="p">)</span><span class="w"> </span><span class="n">layer</span><span class="p">.</span><span class="na">getResource</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Layer</span><span class="w"> </span><span class="n">wmsLayer</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">cascaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">wmsLayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wmsLayerInfo</span><span class="p">.</span><span class="na">getWMSLayer</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">cascaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wmsLayer</span><span class="p">.</span><span class="na">getCascaded</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">Level</span><span class="p">.</span><span class="na">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unable to determina WMSLayer cascaded hop count&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cascaded</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isQueryable</span><span class="p">(</span><span class="n">LayerGroupInfo</span><span class="w"> </span><span class="n">layerGroup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layerGroup</span><span class="p">.</span><span class="na">isQueryDisabled</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">queryable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PublishedInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">layers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getLayersForQueryableChecks</span><span class="p">(</span><span class="n">layerGroup</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">PublishedInfo</span><span class="w"> </span><span class="n">published</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">layers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">published</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">LayerInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">queryable</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">isQueryable</span><span class="p">((</span><span class="n">LayerInfo</span><span class="p">)</span><span class="w"> </span><span class="n">published</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">published</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">LayerGroupInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">queryable</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">isQueryable</span><span class="p">((</span><span class="n">LayerGroupInfo</span><span class="p">)</span><span class="w"> </span><span class="n">published</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">queryable</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * For queryability purposes, a group is queryable if any layer inside of it, advertised or not,</span>
<span class="cm">     * is queriable (because the non advertised layer is still available in GetFeatureInfo). So,</span>
<span class="cm">     * just for this use case, we are going to unwrap {@link</span>
<span class="cm">     * org.geoserver.catalog.impl.AdvertisedCatalog.AdvertisedLayerGroup} and get the original list</span>
<span class="cm">     * of layers. The security wrappers are below it by construction, so this won&#39;t case, per se,</span>
<span class="cm">     * security issues.</span>
<span class="cm">     *</span>
<span class="cm">     * @param layerGroup the group whose query-ability needs to be checked</span>
<span class="cm">     * @return a list of {@link PublishedInfo} contained in the layer (queryable or not)</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PublishedInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getLayersForQueryableChecks</span><span class="p">(</span><span class="n">LayerGroupInfo</span><span class="w"> </span><span class="n">layerGroup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// direct wrapper?</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layerGroup</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">AdvertisedCatalog</span><span class="p">.</span><span class="na">AdvertisedLayerGroup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">AdvertisedCatalog</span><span class="p">.</span><span class="na">AdvertisedLayerGroup</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="n">AdvertisedCatalog</span><span class="p">.</span><span class="na">AdvertisedLayerGroup</span><span class="p">)</span><span class="w"> </span><span class="n">layerGroup</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">layerGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrapper</span><span class="p">.</span><span class="na">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layerGroup</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Wrapper</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// hidden inside some other wrapper?</span><span class="w"></span>
<span class="w">            </span><span class="n">Wrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Wrapper</span><span class="p">)</span><span class="w"> </span><span class="n">layerGroup</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wrapper</span><span class="p">.</span><span class="na">isWrapperFor</span><span class="p">(</span><span class="n">AdvertisedCatalog</span><span class="p">.</span><span class="na">AdvertisedLayerGroup</span><span class="p">.</span><span class="na">class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">wrapper</span><span class="p">.</span><span class="na">unwrap</span><span class="p">(</span><span class="n">AdvertisedCatalog</span><span class="p">.</span><span class="na">AdvertisedLayerGroup</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">AdvertisedCatalog</span><span class="p">.</span><span class="na">AdvertisedLayerGroup</span><span class="w"> </span><span class="n">alg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="n">AdvertisedCatalog</span><span class="p">.</span><span class="na">AdvertisedLayerGroup</span><span class="p">)</span><span class="w"> </span><span class="n">layerGroup</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">layerGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alg</span><span class="p">.</span><span class="na">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// get the full list of layers and groups</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LayerGroupHelper</span><span class="p">(</span><span class="n">layerGroup</span><span class="p">).</span><span class="na">allPublished</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns the read parameters for the specified layer, merging some well known request</span>
<span class="cm">     * parameters into the read parameters if possible</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">GeneralParameterValue</span><span class="o">[]</span><span class="w"> </span><span class="nf">getWMSReadParameters</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">GetMapRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">MapLayerInfo</span><span class="w"> </span><span class="n">mapLayerInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Filter</span><span class="w"> </span><span class="n">layerFilter</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">SortBy</span><span class="o">[]</span><span class="w"> </span><span class="n">sortBy</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">times</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">elevations</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">GridCoverage2DReader</span><span class="w"> </span><span class="n">reader</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">readGeom</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// setup the scene</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">ParameterValueGroup</span><span class="w"> </span><span class="n">readParametersDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="na">getFormat</span><span class="p">().</span><span class="na">getReadParameters</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">CoverageInfo</span><span class="w"> </span><span class="n">coverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapLayerInfo</span><span class="p">.</span><span class="na">getCoverage</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">MetadataMap</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">GeneralParameterValue</span><span class="o">[]</span><span class="w"> </span><span class="n">readParameters</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">CoverageUtils</span><span class="p">.</span><span class="na">getParameters</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">readParametersDescriptor</span><span class="p">,</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">getParameters</span><span class="p">(),</span><span class="w"> </span><span class="n">readGeom</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ReaderDimensionsAccessor</span><span class="w"> </span><span class="n">dimensions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReaderDimensionsAccessor</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// pass down time</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">timeInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// add the descriptors for custom dimensions</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GeneralParameterDescriptor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parameterDescriptors</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">readParametersDescriptor</span><span class="p">.</span><span class="na">getDescriptor</span><span class="p">().</span><span class="na">descriptors</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">ParameterDescriptor</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">dynamicParameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="na">getDynamicParameters</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">parameterDescriptors</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">dynamicParameters</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">timeInfo</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// handle &quot;default&quot;</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fixedTimes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">times</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fixedTimes</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fixedTimes</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">Object</span><span class="w"> </span><span class="n">defaultTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDefaultTime</span><span class="p">(</span><span class="n">coverage</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">fixedTimes</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">defaultTime</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">addWarning</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">DimensionWarning</span><span class="p">.</span><span class="na">defaultValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">mapLayerInfo</span><span class="p">.</span><span class="na">getResource</span><span class="p">(),</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">defaultTime</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="c1">// nearest time support</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeInfo</span><span class="p">.</span><span class="na">isNearestMatchEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">fixedTimes</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                            </span><span class="n">getNearestTimeMatch</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="n">timeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">fixedTimes</span><span class="p">,</span><span class="w"> </span><span class="n">getMaxRenderingTime</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="c1">// pass down the parameters</span><span class="w"></span>
<span class="w">            </span><span class="n">readParameters</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">CoverageUtils</span><span class="p">.</span><span class="na">mergeParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">parameterDescriptors</span><span class="p">,</span><span class="w"> </span><span class="n">readParameters</span><span class="p">,</span><span class="w"> </span><span class="n">fixedTimes</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TIME&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Time&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// pass down elevation</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">elevationInfo</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">metadata</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elevationInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">elevationInfo</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// handle &quot;default&quot;</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fixedElevations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">elevations</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fixedElevations</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fixedElevations</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">Object</span><span class="w"> </span><span class="n">defaultElevation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDefaultElevation</span><span class="p">(</span><span class="n">coverage</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">fixedElevations</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">defaultElevation</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">addWarning</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">DimensionWarning</span><span class="p">.</span><span class="na">defaultValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">mapLayerInfo</span><span class="p">.</span><span class="na">getResource</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">defaultElevation</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">readParameters</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">CoverageUtils</span><span class="p">.</span><span class="na">mergeParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">parameterDescriptors</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">readParameters</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">fixedElevations</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="s">&quot;ELEVATION&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="s">&quot;Elevation&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layerFilter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">readParameters</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// test for default [empty is replaced with INCLUDE filter] ]filter</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">readParameters</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                </span><span class="n">GeneralParameterValue</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readParameters</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">GeneralParameterDescriptor</span><span class="w"> </span><span class="n">pd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="p">.</span><span class="na">getDescriptor</span><span class="p">();</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">getCode</span><span class="p">().</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;FILTER&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">final</span><span class="w"> </span><span class="n">ParameterValue</span><span class="w"> </span><span class="n">pv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ParameterValue</span><span class="p">)</span><span class="w"> </span><span class="n">pd</span><span class="p">.</span><span class="na">createValue</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// if something different from the default INCLUDE filter is specified</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">layerFilter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Filter</span><span class="p">.</span><span class="na">INCLUDE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// override the default filter</span><span class="w"></span>
<span class="w">                        </span><span class="n">pv</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="n">layerFilter</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="n">readParameters</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pv</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sortBy</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">readParameters</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// test for default sortBy</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">readParameters</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                </span><span class="n">GeneralParameterValue</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readParameters</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">GeneralParameterDescriptor</span><span class="w"> </span><span class="n">pd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="p">.</span><span class="na">getDescriptor</span><span class="p">();</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">getCode</span><span class="p">().</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;SORTING&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">final</span><span class="w"> </span><span class="n">ParameterValue</span><span class="w"> </span><span class="n">pv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ParameterValue</span><span class="p">)</span><span class="w"> </span><span class="n">pd</span><span class="p">.</span><span class="na">createValue</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ParameterDescriptor</span><span class="w"></span>
<span class="w">                            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">equals</span><span class="p">(((</span><span class="n">ParameterDescriptor</span><span class="p">)</span><span class="w"> </span><span class="n">pd</span><span class="p">).</span><span class="na">getValueClass</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// convert down to string</span><span class="w"></span>
<span class="w">                        </span><span class="n">String</span><span class="w"> </span><span class="n">sortBySpec</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                </span><span class="n">Arrays</span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="n">sortBy</span><span class="p">)</span><span class="w"></span>
<span class="w">                                        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">sortSpecification</span><span class="p">)</span><span class="w"></span>
<span class="w">                                        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">                        </span><span class="n">pv</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="n">sortBySpec</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">pv</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="n">sortBy</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="n">readParameters</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pv</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// custom dimensions</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">customDomains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">dimensions</span><span class="p">.</span><span class="na">getCustomDomains</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">customDomains</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getCustomDimension</span><span class="p">(</span><span class="n">domain</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">maxValues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMaxRequestedDimensionValues</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maxValues</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">maxValues</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="s">&quot;More than &quot;</span><span class="w"></span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">maxValues</span><span class="w"></span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; dimension values specified in the request, bailing out.&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">ServiceException</span><span class="p">.</span><span class="na">INVALID_PARAMETER_VALUE</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="s">&quot;DIM_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">domain</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="n">readParameters</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="n">CoverageUtils</span><span class="p">.</span><span class="na">mergeParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">parameterDescriptors</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">readParameters</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">dimensions</span><span class="p">.</span><span class="na">convertDimensionValue</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">),</span><span class="w"></span>
<span class="w">                                </span><span class="n">domain</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">customDomains</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">domain</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// see if we have any custom domain for which we have to set the default value</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">customDomains</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dimensionName</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">customDomains</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">customInfo</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="n">metadata</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">CUSTOM_DIMENSION_PREFIX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">customInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">customInfo</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">Object</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                            </span><span class="n">dimensions</span><span class="p">.</span><span class="na">convertDimensionValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getDefaultCustomDimensionValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                                            </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"> </span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">));</span><span class="w"></span>
<span class="w">                    </span><span class="n">addWarning</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">DimensionWarning</span><span class="p">.</span><span class="na">defaultValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">mapLayerInfo</span><span class="p">.</span><span class="na">getResource</span><span class="p">(),</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">));</span><span class="w"></span>
<span class="w">                    </span><span class="n">readParameters</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                            </span><span class="n">CoverageUtils</span><span class="p">.</span><span class="na">mergeParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">parameterDescriptors</span><span class="p">,</span><span class="w"> </span><span class="n">readParameters</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">readParameters</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">sortSpecification</span><span class="p">(</span><span class="n">SortBy</span><span class="w"> </span><span class="n">sb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sb</span><span class="p">.</span><span class="na">getPropertyName</span><span class="p">().</span><span class="na">getPropertyName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sb</span><span class="p">.</span><span class="na">getSortOrder</span><span class="p">().</span><span class="na">name</span><span class="p">().</span><span class="na">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">RenderedImageMapResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAvailableMapResponses</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">WMSExtensions</span><span class="p">.</span><span class="na">findMapResponses</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Query and returns the times for the given layer, in the given time range */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryCoverageTimes</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">CoverageInfo</span><span class="w"> </span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="n">DateRange</span><span class="w"> </span><span class="n">queryRange</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxAnimationSteps</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// grab the time metadata</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">time</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Layer &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not have time support enabled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">GridCoverage2DReader</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GridCoverage2DReader</span><span class="p">)</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">getGridCoverageReader</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Unable to acquire a reader for this coverage &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">(),</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reader</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Unable to acquire a reader for this coverage &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">ReaderDimensionsAccessor</span><span class="w"> </span><span class="n">dimensions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReaderDimensionsAccessor</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="na">getTimeDomain</span><span class="p">(</span><span class="n">queryRange</span><span class="p">,</span><span class="w"> </span><span class="n">maxAnimationSteps</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Query and returns the requested times for the given layer */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryCoverageNearestMatchTimes</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">CoverageInfo</span><span class="w"> </span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queryRanges</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span><span class="w"> </span><span class="n">foundDates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">time</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Coverage &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not have time support enabled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dates</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">getNearestTimeMatch</span><span class="p">(</span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">queryRanges</span><span class="p">,</span><span class="w"> </span><span class="n">getMaxRenderingTime</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">dates</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Date</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">d</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">Date</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w"></span>
<span class="w">                            </span><span class="n">foundDates</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">date</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">foundDates</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getNearestTimeMatch</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">ResourceInfo</span><span class="w"> </span><span class="n">coverage</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">dimension</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queryRanges</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">maxRenderingTime</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">NearestMatchFinder</span><span class="w"> </span><span class="n">finder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NearestMatchFinder</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="n">dimension</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">finder</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">finder</span><span class="p">.</span><span class="na">getMatches</span><span class="p">(</span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">queryRanges</span><span class="p">,</span><span class="w"> </span><span class="n">maxRenderingTime</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Query and returns the times for the given layer, in the given time range */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryFeatureTypeTimes</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">DateRange</span><span class="w"> </span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxItems</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">queryFeatureTypeDimension</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="n">maxItems</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns the list of time values for the specified typeInfo based on the dimension</span>
<span class="cm">     * representation: all values for {@link DimensionPresentation#LIST}, otherwise min and max</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getFeatureTypeTimes</span><span class="p">(</span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// grab the time metadata</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">time</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Layer &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not have time support enabled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">FeatureCollection</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDimensionCollection</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="na">getPresentation</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DimensionPresentation</span><span class="p">.</span><span class="na">LIST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">UniqueVisitor</span><span class="w"> </span><span class="n">visitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UniqueVisitor</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">collection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">visitor</span><span class="p">.</span><span class="na">getUnique</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// we might get null values out of the visitor, strip them</span><span class="w"></span>
<span class="w">                </span><span class="n">values</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">values</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">MinVisitor</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinVisitor</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">collection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">CalcResult</span><span class="w"> </span><span class="n">minResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="na">getResult</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="c1">// check calcresult first to avoid potential IllegalStateException if no features are in</span><span class="w"></span>
<span class="w">            </span><span class="c1">// collection</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">minResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CalcResult</span><span class="p">.</span><span class="na">NULL_RESULT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">((</span><span class="n">Date</span><span class="p">)</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="na">getMin</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">MaxVisitor</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">MaxVisitor</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">time</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">                                        </span><span class="o">?</span><span class="w"> </span><span class="n">time</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">()</span><span class="w"></span>
<span class="w">                                        </span><span class="p">:</span><span class="w"> </span><span class="n">time</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">collection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">((</span><span class="n">Date</span><span class="p">)</span><span class="w"> </span><span class="n">max</span><span class="p">.</span><span class="na">getMax</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Query and returns the elevations for the given layer, in the given time range */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryCoverageElevations</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">CoverageInfo</span><span class="w"> </span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="n">NumberRange</span><span class="w"> </span><span class="n">queryRange</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxAnimationSteps</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// grab the metadata</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">elevation</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">coverage</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elevation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">elevation</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Layer &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not have elevation support enabled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">GridCoverage2DReader</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GridCoverage2DReader</span><span class="p">)</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">getGridCoverageReader</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Unable to acquire a reader for this coverage &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">(),</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reader</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Unable to acquire a reader for this coverage &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coverage</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">ReaderDimensionsAccessor</span><span class="w"> </span><span class="n">dimensions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReaderDimensionsAccessor</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="na">getElevationDomain</span><span class="p">(</span><span class="n">queryRange</span><span class="p">,</span><span class="w"> </span><span class="n">maxAnimationSteps</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns the list of elevation values for the specified typeInfo based on the dimension</span>
<span class="cm">     * representation: all values for {@link DimensionPresentation#LIST}, otherwise min and max</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getFeatureTypeElevations</span><span class="p">(</span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// grab the time metadata</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">elevation</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elevation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">elevation</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Layer &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not have elevation support enabled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">FeatureCollection</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDimensionCollection</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">elevation</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elevation</span><span class="p">.</span><span class="na">getPresentation</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DimensionPresentation</span><span class="p">.</span><span class="na">LIST</span><span class="w"></span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">elevation</span><span class="p">.</span><span class="na">getPresentation</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DimensionPresentation</span><span class="p">.</span><span class="na">DISCRETE_INTERVAL</span><span class="w"></span>
<span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">elevation</span><span class="p">.</span><span class="na">getResolution</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">UniqueVisitor</span><span class="w"> </span><span class="n">visitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UniqueVisitor</span><span class="p">(</span><span class="n">elevation</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">collection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">visitor</span><span class="p">.</span><span class="na">getUnique</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(((</span><span class="n">Number</span><span class="p">)</span><span class="w"> </span><span class="n">value</span><span class="p">).</span><span class="na">doubleValue</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">MinVisitor</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinVisitor</span><span class="p">(</span><span class="n">elevation</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">collection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// check calcresult first to avoid potential IllegalStateException if no features are in</span><span class="w"></span>
<span class="w">            </span><span class="c1">// collection</span><span class="w"></span>
<span class="w">            </span><span class="n">CalcResult</span><span class="w"> </span><span class="n">calcResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="na">getResult</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calcResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CalcResult</span><span class="p">.</span><span class="na">NULL_RESULT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(((</span><span class="n">Number</span><span class="p">)</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="na">getMin</span><span class="p">()).</span><span class="na">doubleValue</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">MaxVisitor</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">MaxVisitor</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">elevation</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">                                        </span><span class="o">?</span><span class="w"> </span><span class="n">elevation</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">()</span><span class="w"></span>
<span class="w">                                        </span><span class="p">:</span><span class="w"> </span><span class="n">elevation</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">collection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(((</span><span class="n">Number</span><span class="p">)</span><span class="w"> </span><span class="n">max</span><span class="p">.</span><span class="na">getMax</span><span class="p">()).</span><span class="na">doubleValue</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Query and returns the times for the given layer, in the given time range */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryFeatureTypeElevations</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">NumberRange</span><span class="w"> </span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxItems</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">queryFeatureTypeDimension</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="n">maxItems</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Query and returns the dimension values for the given layer, in the given range */</span><span class="w"></span>
<span class="w">    </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryFeatureTypeDimension</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxItems</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// grab the metadata</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">di</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">dimensionName</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">di</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">di</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Layer &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not have &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">dimensionName</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; support enabled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// filter by date range</span><span class="w"></span>
<span class="w">        </span><span class="n">FeatureSource</span><span class="w"> </span><span class="n">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFeatureSource</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// build query to grab the time values</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Query</span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="na">getSchema</span><span class="p">().</span><span class="na">getName</span><span class="p">().</span><span class="na">getLocalPart</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">query</span><span class="p">.</span><span class="na">setPropertyNames</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">PropertyName</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ff</span><span class="p">.</span><span class="na">property</span><span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">PropertyIsBetween</span><span class="w"> </span><span class="n">rangeFilter</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">ff</span><span class="p">.</span><span class="na">between</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">attribute</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">ff</span><span class="p">.</span><span class="na">literal</span><span class="p">(</span><span class="n">range</span><span class="p">.</span><span class="na">getMinValue</span><span class="p">()),</span><span class="w"></span>
<span class="w">                        </span><span class="n">ff</span><span class="p">.</span><span class="na">literal</span><span class="p">(</span><span class="n">range</span><span class="p">.</span><span class="na">getMaxValue</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">query</span><span class="p">.</span><span class="na">setFilter</span><span class="p">(</span><span class="n">rangeFilter</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">query</span><span class="p">.</span><span class="na">setMaxFeatures</span><span class="p">(</span><span class="n">maxItems</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">FeatureCollection</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="na">getFeatures</span><span class="p">(</span><span class="n">query</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// collect all unique values (can&#39;t do ranges now, we don&#39;t have a multi-attribute unique</span><span class="w"></span>
<span class="w">        </span><span class="c1">// visitor)</span><span class="w"></span>
<span class="w">        </span><span class="n">UniqueVisitor</span><span class="w"> </span><span class="n">visitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UniqueVisitor</span><span class="p">(</span><span class="n">attribute</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">collection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Comparable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uniques</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">visitor</span><span class="p">.</span><span class="na">getUnique</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">uniques</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Returns the default value for time dimension. */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getDefaultTime</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="w"> </span><span class="n">resourceInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// check the time metadata</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">time</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Layer &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resourceInfo</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not have time support enabled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionDefaultValueSelectionStrategy</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">getDefaultValueStrategy</span><span class="p">(</span><span class="n">resourceInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">strategy</span><span class="p">.</span><span class="na">getDefaultValue</span><span class="p">(</span><span class="n">resourceInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Returns the default value for elevation dimension. */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getDefaultElevation</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="w"> </span><span class="n">resourceInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">elevation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDimensionInfo</span><span class="p">(</span><span class="n">resourceInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionDefaultValueSelectionStrategy</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">getDefaultValueStrategy</span><span class="p">(</span><span class="n">resourceInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">,</span><span class="w"> </span><span class="n">elevation</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">strategy</span><span class="p">.</span><span class="na">getDefaultValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">resourceInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">,</span><span class="w"> </span><span class="n">elevation</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Looks up the elevation configuration, throws an exception if not found */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="nf">getDimensionInfo</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="w"> </span><span class="n">resourceInfo</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">dimensionName</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Layer &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">resourceInfo</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not have &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">dimensionName</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; support enabled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns the default value for the given custom dimension.</span>
<span class="cm">     *</span>
<span class="cm">     * @param &lt;T&gt;</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">getDefaultCustomDimensionValue</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="w"> </span><span class="n">resourceInfo</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">customDim</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">resourceInfo</span><span class="w"></span>
<span class="w">                        </span><span class="p">.</span><span class="na">getMetadata</span><span class="p">()</span><span class="w"></span>
<span class="w">                        </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">CUSTOM_DIMENSION_PREFIX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">customDim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">customDim</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Layer &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">resourceInfo</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not have support enabled for dimension &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionDefaultValueSelectionStrategy</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">getDefaultValueStrategy</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">resourceInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">CUSTOM_DIMENSION_PREFIX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">customDim</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// custom dimensions have no range support</span><span class="w"></span>
<span class="w">        </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">T</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">strategy</span><span class="p">.</span><span class="na">getDefaultValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">resourceInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">CUSTOM_DIMENSION_PREFIX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">customDim</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">clz</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">DimensionDefaultValueSelectionStrategy</span><span class="w"> </span><span class="nf">getDefaultValueStrategy</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">ResourceInfo</span><span class="w"> </span><span class="n">resource</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">dimensionInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">defaultDimensionValueFactory</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">defaultDimensionValueFactory</span><span class="p">.</span><span class="na">getStrategy</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"> </span><span class="n">dimensionInfo</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns the collection of all values of the dimension attribute, eventually sorted if the</span>
<span class="cm">     * native capabilities allow for it</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="n">FeatureCollection</span><span class="w"> </span><span class="nf">getDimensionCollection</span><span class="p">(</span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">dimension</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">FeatureSource</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFeatureSource</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// build query to grab the dimension values</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">dimQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Query</span><span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="na">getSchema</span><span class="p">().</span><span class="na">getName</span><span class="p">().</span><span class="na">getLocalPart</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propertyNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">propertyNames</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">dimension</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dimension</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dimension</span><span class="p">.</span><span class="na">getPresentation</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DimensionPresentation</span><span class="p">.</span><span class="na">LIST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">propertyNames</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">dimension</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">dimQuery</span><span class="p">.</span><span class="na">setPropertyNames</span><span class="p">(</span><span class="n">propertyNames</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="na">getFeatures</span><span class="p">(</span><span class="n">dimQuery</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/** Returns the feature source for the given feature type */</span><span class="w"></span>
<span class="w">    </span><span class="n">FeatureSource</span><span class="w"> </span><span class="nf">getFeatureSource</span><span class="p">(</span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// grab the feature source</span><span class="w"></span>
<span class="w">        </span><span class="n">FeatureSource</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">getFeatureSource</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">GeoTools</span><span class="p">.</span><span class="na">getDefaultHints</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceException</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Could not get the feauture source to list time info for layer &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">prefixedName</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">source</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Builds a filter for the current time and elevation, should the layer support them. Only one</span>
<span class="cm">     * among time and elevation can be multi-valued</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Filter</span><span class="w"> </span><span class="nf">getTimeElevationToFilter</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">times</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">elevations</span><span class="p">,</span><span class="w"> </span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">timeInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">elevationInfo</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">typeInfo</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">DimensionFilterBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DimensionFilterBuilder</span><span class="p">(</span><span class="n">ff</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// handle time support</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">timeInfo</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">defaultedTimes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">times</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">times</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">datetime</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// this is &quot;default&quot;</span><span class="w"></span>
<span class="w">                    </span><span class="n">datetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDefaultTime</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">addWarning</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">DimensionWarning</span><span class="p">.</span><span class="na">defaultValue</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">TIME</span><span class="p">,</span><span class="w"> </span><span class="n">datetime</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">defaultedTimes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">datetime</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeInfo</span><span class="p">.</span><span class="na">isNearestMatchEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nearestMatchedTimes</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="n">getNearestTimeMatch</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">timeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">defaultedTimes</span><span class="p">,</span><span class="w"> </span><span class="n">getMaxRenderingTime</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">builder</span><span class="p">.</span><span class="na">appendFilters</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">timeInfo</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(),</span><span class="w"> </span><span class="n">timeInfo</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">(),</span><span class="w"> </span><span class="n">nearestMatchedTimes</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">builder</span><span class="p">.</span><span class="na">appendFilters</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">timeInfo</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(),</span><span class="w"> </span><span class="n">timeInfo</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">(),</span><span class="w"> </span><span class="n">defaultedTimes</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// handle elevation support</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elevationInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">elevationInfo</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">elevations</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">defaultedElevations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">elevations</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">elevation</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">elevations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elevation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// this is &quot;default&quot;</span><span class="w"></span>
<span class="w">                    </span><span class="n">elevation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDefaultElevation</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">addWarning</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">DimensionWarning</span><span class="p">.</span><span class="na">defaultValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="p">.</span><span class="na">ELEVATION</span><span class="p">,</span><span class="w"> </span><span class="n">elevation</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">defaultedElevations</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">elevation</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="na">appendFilters</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">elevationInfo</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="n">elevationInfo</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="n">defaultedElevations</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Filter</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">getFilter</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Builds the custom dimensions filter in base to type info and KVP.</span>
<span class="cm">     *</span>
<span class="cm">     * @param rawKVP Request KVP map</span>
<span class="cm">     * @param typeInfo Feature type info instance</span>
<span class="cm">     * @return builded filter</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Filter</span><span class="w"> </span><span class="nf">getDimensionsToFilter</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rawKVP</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">CustomDimensionFilterConverter</span><span class="p">.</span><span class="na">DefaultValueStrategyFactory</span><span class="w"> </span><span class="n">defaultValueStrategyFactory</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">resource</span><span class="p">,</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"> </span><span class="n">dimensionInfo</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"></span>
<span class="w">                        </span><span class="n">getDefaultValueStrategy</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span><span class="w"> </span><span class="n">dimensionName</span><span class="p">,</span><span class="w"> </span><span class="n">dimensionInfo</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">CustomDimensionFilterConverter</span><span class="w"> </span><span class="n">converter</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">CustomDimensionFilterConverter</span><span class="p">(</span><span class="n">defaultValueStrategyFactory</span><span class="p">,</span><span class="w"> </span><span class="n">ff</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">converter</span><span class="p">.</span><span class="na">getDimensionsToFilter</span><span class="p">(</span><span class="n">rawKVP</span><span class="p">,</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns the max rendering time taking into account the server limits and the request options</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getMaxRenderingTime</span><span class="p">(</span><span class="n">GetMapRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">localMaxRenderingTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">timeoutOption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getFormatOptions</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;timeout&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeoutOption</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">localMaxRenderingTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">timeoutOption</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NumberFormatException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">RenderedImageMapOutputFormat</span><span class="p">.</span><span class="na">LOGGER</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">Level</span><span class="p">.</span><span class="na">WARNING</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="s">&quot;Could not parse format_option \&quot;timeout\&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">timeoutOption</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">maxRenderingTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMaxRenderingTime</span><span class="p">(</span><span class="n">localMaxRenderingTime</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">maxRenderingTime</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Timeout on the smallest nonzero value of the WMS timeout and the timeout format option If</span>
<span class="cm">     * both are zero then there is no timeout</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getMaxRenderingTime</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">localMaxRenderingTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">maxRenderingTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMaxRenderingTime</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maxRenderingTime</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">maxRenderingTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localMaxRenderingTime</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">localMaxRenderingTime</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">maxRenderingTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">maxRenderingTime</span><span class="p">,</span><span class="w"> </span><span class="n">localMaxRenderingTime</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">maxRenderingTime</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Converts a coordinate expressed on the device space back to real world coordinates. Stolen</span>
<span class="cm">     * from LiteRenderer but without the need of a Graphics object</span>
<span class="cm">     *</span>
<span class="cm">     * @param x horizontal coordinate on device space</span>
<span class="cm">     * @param y vertical coordinate on device space</span>
<span class="cm">     * @param map The map extent</span>
<span class="cm">     * @param width image width</span>
<span class="cm">     * @param height image height</span>
<span class="cm">     * @return The correspondent real world coordinate</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Coordinate</span><span class="w"> </span><span class="nf">pixelToWorld</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">ReferencedEnvelope</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// set up the affine transform and calculate scale values</span><span class="w"></span>
<span class="w">        </span><span class="n">AffineTransform</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">worldToScreenTransform</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Point2D</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">at</span><span class="p">.</span><span class="na">inverseTransform</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="k">new</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">awt</span><span class="p">.</span><span class="na">geom</span><span class="p">.</span><span class="na">Point2D</span><span class="p">.</span><span class="na">Double</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">),</span><span class="w"></span>
<span class="w">                            </span><span class="k">new</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">awt</span><span class="p">.</span><span class="na">geom</span><span class="p">.</span><span class="na">Point2D</span><span class="p">.</span><span class="na">Double</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NoninvertibleTransformException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Coordinate</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Coordinate</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getX</span><span class="p">(),</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getY</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Sets up the affine transform. Stolen from liteRenderer code.</span>
<span class="cm">     *</span>
<span class="cm">     * @param mapExtent the map extent</span>
<span class="cm">     * @param width the screen size</span>
<span class="cm">     * @return a transform that maps from real world coordinates to the screen</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AffineTransform</span><span class="w"> </span><span class="nf">worldToScreenTransform</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">ReferencedEnvelope</span><span class="w"> </span><span class="n">mapExtent</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="c1">// the transformation depends on an x/y ordering, if we have a lat/lon crs swap it</span><span class="w"></span>
<span class="w">        </span><span class="n">CoordinateReferenceSystem</span><span class="w"> </span><span class="n">crs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapExtent</span><span class="p">.</span><span class="na">getCoordinateReferenceSystem</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CRS</span><span class="p">.</span><span class="na">getAxisOrder</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AxisOrder</span><span class="p">.</span><span class="na">NORTH_EAST</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">swap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">mapExtent</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">ReferencedEnvelope</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">mapExtent</span><span class="p">.</span><span class="na">getMinY</span><span class="p">(),</span><span class="w"></span>
<span class="w">                            </span><span class="n">mapExtent</span><span class="p">.</span><span class="na">getMaxY</span><span class="p">(),</span><span class="w"></span>
<span class="w">                            </span><span class="n">mapExtent</span><span class="p">.</span><span class="na">getMinX</span><span class="p">(),</span><span class="w"></span>
<span class="w">                            </span><span class="n">mapExtent</span><span class="p">.</span><span class="na">getMaxX</span><span class="p">(),</span><span class="w"></span>
<span class="w">                            </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">scaleX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">mapExtent</span><span class="p">.</span><span class="na">getWidth</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">scaleY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">mapExtent</span><span class="p">.</span><span class="na">getHeight</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">mapExtent</span><span class="p">.</span><span class="na">getMinX</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scaleX</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mapExtent</span><span class="p">.</span><span class="na">getMinY</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scaleY</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">height</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">AffineTransform</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AffineTransform</span><span class="p">(</span><span class="n">scaleX</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0d</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0d</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">scaleY</span><span class="p">,</span><span class="w"> </span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// if we swapped concatenate a transform that swaps back</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">swap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">at</span><span class="p">.</span><span class="na">concatenate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AffineTransform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">at</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">WMS</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">GeoServerExtensions</span><span class="p">.</span><span class="na">bean</span><span class="p">(</span><span class="n">WMS</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Checks if the layer can be drawn, that is, if it&#39;s raster, or vector with a geometry</span>
<span class="cm">     * attribute</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isWmsExposable</span><span class="p">(</span><span class="n">LayerInfo</span><span class="w"> </span><span class="n">lyr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lyr</span><span class="p">.</span><span class="na">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PublishedType</span><span class="p">.</span><span class="na">RASTER</span><span class="w"></span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">lyr</span><span class="p">.</span><span class="na">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PublishedType</span><span class="p">.</span><span class="na">WMS</span><span class="w"></span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">lyr</span><span class="p">.</span><span class="na">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PublishedType</span><span class="p">.</span><span class="na">WMTS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lyr</span><span class="p">.</span><span class="na">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PublishedType</span><span class="p">.</span><span class="na">VECTOR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">ResourceInfo</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lyr</span><span class="p">.</span><span class="na">getResource</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">AttributeTypeInfo</span><span class="w"> </span><span class="n">att</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">((</span><span class="n">FeatureTypeInfo</span><span class="p">)</span><span class="w"> </span><span class="n">resource</span><span class="p">).</span><span class="na">attributes</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">att</span><span class="p">.</span><span class="na">getBinding</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">                            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Geometry</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">isAssignableFrom</span><span class="p">(</span><span class="n">att</span><span class="p">.</span><span class="na">getBinding</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">Level</span><span class="p">.</span><span class="na">SEVERE</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="s">&quot;An error occurred trying to determine if&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; the layer is geometryless&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returns available values for a custom dimension.</span>
<span class="cm">     *</span>
<span class="cm">     * @param typeInfo feature type info that holds the custom dimension.</span>
<span class="cm">     * @param dimensionInfo Custom dimension name.</span>
<span class="cm">     * @return values list.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getDimensionValues</span><span class="p">(</span><span class="n">FeatureTypeInfo</span><span class="w"> </span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">DimensionInfo</span><span class="w"> </span><span class="n">dimensionInfo</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">FeatureCollection</span><span class="w"> </span><span class="n">fcollection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDimensionCollection</span><span class="p">(</span><span class="n">typeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">dimensionInfo</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dimensionInfo</span><span class="p">.</span><span class="na">getPresentation</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DimensionPresentation</span><span class="p">.</span><span class="na">LIST</span><span class="w"></span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">dimensionInfo</span><span class="p">.</span><span class="na">getPresentation</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DimensionPresentation</span><span class="p">.</span><span class="na">DISCRETE_INTERVAL</span><span class="w"></span>
<span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dimensionInfo</span><span class="p">.</span><span class="na">getResolution</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">UniqueVisitor</span><span class="w"> </span><span class="n">uniqueVisitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UniqueVisitor</span><span class="p">(</span><span class="n">dimensionInfo</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">fcollection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">uniqueVisitor</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uniqueValues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uniqueVisitor</span><span class="p">.</span><span class="na">getUnique</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">uniqueValues</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">MinVisitor</span><span class="w"> </span><span class="n">minVisitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinVisitor</span><span class="p">(</span><span class="n">dimensionInfo</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">fcollection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">minVisitor</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">CalcResult</span><span class="w"> </span><span class="n">minResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minVisitor</span><span class="p">.</span><span class="na">getResult</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">minResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CalcResult</span><span class="p">.</span><span class="na">NULL_RESULT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">minResult</span><span class="p">.</span><span class="na">getValue</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">MaxVisitor</span><span class="w"> </span><span class="n">maxVisitor</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">MaxVisitor</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">dimensionInfo</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">                                        </span><span class="o">?</span><span class="w"> </span><span class="n">dimensionInfo</span><span class="p">.</span><span class="na">getEndAttribute</span><span class="p">()</span><span class="w"></span>
<span class="w">                                        </span><span class="p">:</span><span class="w"> </span><span class="n">dimensionInfo</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">fcollection</span><span class="p">.</span><span class="na">accepts</span><span class="p">(</span><span class="n">maxVisitor</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">maxVisitor</span><span class="p">.</span><span class="na">getMax</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDefaultGroupStyleEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getServiceInfo</span><span class="p">().</span><span class="na">isDefaultGroupStyleEnabled</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</body>
</html>
