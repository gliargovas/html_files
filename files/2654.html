<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">org.multibit.hd.hardware.keepkey.utils</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.base.Optional</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.base.Preconditions</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.collect.ImmutableList</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.collect.Lists</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.protobuf.ByteString</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.protobuf.InvalidProtocolBufferException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.protobuf.Message</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.keepkey.protobuf.KeepKeyMessage</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.keepkey.protobuf.KeepKeyType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">edu.umd.cs.findbugs.annotations.SuppressFBWarnings</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.lang3.builder.ToStringBuilder</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.bitcoinj.core.Address</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.bitcoinj.core.Transaction</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.bitcoinj.core.TransactionInput</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.bitcoinj.core.TransactionOutput</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.bitcoinj.crypto.ChildNumber</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.bitcoinj.params.MainNetParams</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.bitcoinj.wallet.KeyChain</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.multibit.hd.hardware.core.events.MessageEvent</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.multibit.hd.hardware.core.events.MessageEventType</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.multibit.hd.hardware.core.messages.HardwareWalletMessage</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.multibit.hd.hardware.core.messages.TxRequest</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.Logger</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStream</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.OutputStream</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.ByteBuffer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Arrays</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Utility class to provide the following to applications:&lt;/p&gt;</span>
<span class="cm"> * &lt;ul&gt;</span>
<span class="cm"> * &lt;li&gt;Various KeepKeyMessage related operations&lt;/li&gt;</span>
<span class="cm"> * &lt;/ul&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @since 0.0.1</span>
<span class="cm"> *  </span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KeepKeyMessageUtils</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">KeepKeyMessageUtils</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Utilities should not have public constructors</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="nf">KeepKeyMessageUtils</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * @param type   The message type</span>
<span class="cm">   * @param buffer The buffer containing the protobuf message</span>
<span class="cm">   *</span>
<span class="cm">   * @return The low level message event containing the data if it could be parsed and adapted</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">MessageEvent</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">MessageType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Parsing &#39;{}&#39; ({} bytes):&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">logPacket</span><span class="p">(</span><span class="s">&quot;&lt;&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">HardwareWalletMessage</span><span class="w"> </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">MessageEventType</span><span class="w"> </span><span class="n">messageEventType</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_Initialize</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Initialize</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">INITALISE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_Ping</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Ping</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">PING</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_Success</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Success</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptSuccess</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Success</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_Failure</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Failure</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">FAILURE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptFailure</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Failure</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_ChangePin</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">ChangePin</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">CHANGE_PIN</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_WipeDevice</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">WipeDevice</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">WIPE_DEVICE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_FirmwareErase</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">FirmwareErase</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">FIRMWARE_ERASE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_FirmwareUpload</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">FirmwareUpload</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">FIRMWARE_UPLOAD</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_GetEntropy</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">GetEntropy</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">GET_ENTROPY</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_Entropy</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Entropy</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">ENTROPY</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_GetPublicKey</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">GetPublicKey</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">GET_PUBLIC_KEY</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_PublicKey</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">PublicKey</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">PUBLIC_KEY</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptPublicKey</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">PublicKey</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_LoadDevice</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">LoadDevice</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">LOAD_DEVICE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_ResetDevice</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">ResetDevice</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">RESET_DEVICE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_SignTx</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">SignTx</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">SIGN_TX</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_SimpleSignTx</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">SimpleSignTx</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">SIMPLE_SIGN_TX</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_Features</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Features</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">FEATURES</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptFeatures</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Features</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_PinMatrixRequest</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">PinMatrixRequest</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">PIN_MATRIX_REQUEST</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptPinMatrixRequest</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">PinMatrixRequest</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_PinMatrixAck</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">PinMatrixAck</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">PIN_MATRIX_ACK</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_Cancel</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Cancel</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">CANCEL</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_TxRequest</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">TxRequest</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">TX_REQUEST</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptTxRequest</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">TxRequest</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_TxAck</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">TxAck</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">TX_ACK</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_CipherKeyValue</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">CipherKeyValue</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">CIPHER_KEY_VALUE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_CipheredKeyValue</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">CipheredKeyValue</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">CIPHERED_KEY_VALUE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptCipheredKeyValue</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">CipheredKeyValue</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_ClearSession</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">ClearSession</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">CLEAR_SESSION</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_ApplySettings</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">ApplySettings</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">APPLY_SETTINGS</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_ButtonRequest</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">ButtonRequest</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">BUTTON_REQUEST</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptButtonRequest</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">ButtonRequest</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_ButtonAck</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">ButtonAck</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">BUTTON_ACK</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_GetAddress</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">GetAddress</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">GET_ADDRESS</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_Address</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Address</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">ADDRESS</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptAddress</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">Address</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_EntropyRequest</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">EntropyRequest</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">ENTROPY_REQUEST</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_EntropyAck</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">EntropyAck</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">ENTROPY_ACK</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_SignMessage</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">SignMessage</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">SIGN_MESSAGE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_VerifyMessage</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">VerifyMessage</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">VERIFY_MESSAGE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_MessageSignature</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">MessageSignature</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">MESSAGE_SIGNATURE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptMessageSignature</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">MessageSignature</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_EncryptMessage</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">EncryptMessage</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">ENCRYPT_MESSAGE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_EncryptedMessage</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">EncryptedMessage</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">ENCRYPTED_MESSAGE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_DecryptMessage</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">DecryptMessage</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">DECRYPT_MESSAGE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_DecryptedMessage</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">DecryptedMessage</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">DECRYPTED_MESSAGE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_PassphraseRequest</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">PassphraseRequest</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">PASSPHRASE_REQUEST</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_PassphraseAck</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">PassphraseAck</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">PASSPHRASE_ACK</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_EstimateTxSize</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">EstimateTxSize</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">ESTIMATE_TX_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_TxSize</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">TxSize</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">TX_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_RecoveryDevice</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">RecoveryDevice</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">RECOVER_DEVICE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_WordRequest</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">WordRequest</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">WORD_REQUEST</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_WordAck</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">WordAck</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">WORD_ACK</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_SignIdentity</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">SignIdentity</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">SIGN_IDENTITY</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_SignedIdentity</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">SignedIdentity</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">SIGNED_IDENTITY</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageAdapter</span><span class="p">.</span><span class="na">adaptSignedIdentity</span><span class="p">((</span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">SignedIdentity</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_GetFeatures</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">GetFeatures</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">GET_FEATURES</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_DebugLinkDecision</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">DebugLinkDecision</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">DEBUG_LINK_DECISION</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_DebugLinkGetState</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">DebugLinkGetState</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">DEBUG_LINK_GET_STATE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_DebugLinkState</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">DebugLinkState</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">DEBUG_LINK_STATE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_DebugLinkStop</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">DebugLinkStop</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">DEBUG_LINK_STOP</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MessageType_DebugLinkLog</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">DebugLinkLog</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">messageEventType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageEventType</span><span class="p">.</span><span class="na">DEBUG_LINK_LOG</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Unknown message type: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">type</span><span class="p">.</span><span class="na">name</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Must be OK to be here</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hardwareWalletMessage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Could not adapt message to Core.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;&lt; Message:\n{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ToStringBuilder</span><span class="p">.</span><span class="na">reflectionToString</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KeepKeyMessageToStringStyle</span><span class="p">()));</span><span class="w"></span>

<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;&lt; HardwareMessage:\n{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ToStringBuilder</span><span class="p">.</span><span class="na">reflectionToString</span><span class="p">(</span><span class="n">hardwareWalletMessage</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KeepKeyMessageToStringStyle</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Wrap the type and message into an event</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MessageEvent</span><span class="p">(</span><span class="n">messageEventType</span><span class="p">,</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">fromNullable</span><span class="p">(</span><span class="n">hardwareWalletMessage</span><span class="p">),</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">message</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;KEEP_KEY&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InvalidProtocolBufferException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Could not parse message&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Must have failed to be here</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * @param prefix The logging prefix (usually &quot;&gt;&quot; for write and &quot;&lt;&quot; for read)</span>
<span class="cm">   * @param count  The packet count</span>
<span class="cm">   * @param buffer The buffer containing the packet to log</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="nd">@SuppressFBWarnings</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;SBSC_USE_STRINGBUFFER_CONCATENATION&quot;</span><span class="p">},</span><span class="w"> </span><span class="n">justification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only occurs at trace&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logPacket</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Only do work if required</span><span class="w"></span>
<span class="w">    </span><span class="c1">// There is a security issue to revealing this information for certain packets</span><span class="w"></span>
<span class="w">    </span><span class="c1">// so be cautious in raising it in Production</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">isTraceEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; Packet [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]:&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * &lt;p&gt;Write a KeepKey protocol buffer message to an OutputStream&lt;/p&gt;</span>
<span class="cm">   *</span>
<span class="cm">   * @param message The protocol buffer message to read</span>
<span class="cm">   * @param out     The data output stream (must be open)</span>
<span class="cm">   *</span>
<span class="cm">   * @throws java.io.IOException If the device disconnects during IO</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="nd">@SuppressFBWarnings</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;SBSC_USE_STRINGBUFFER_CONCATENATION&quot;</span><span class="p">},</span><span class="w"> </span><span class="n">justification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Only occurs at trace&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeAsHIDPackets</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">OutputStream</span><span class="w"> </span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="c1">// The message presented as a collection of HID packets</span><span class="w"></span>
<span class="w">    </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">messageBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">formatAsHIDPackets</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">position</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">63</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Writing {} packets&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">packets</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">rewind</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// HID requires 64 byte packets with 63 bytes of payload</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">packets</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">64</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">buffer</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">63</span><span class="p">;</span><span class="w"> </span><span class="c1">// Length</span><span class="w"></span>
<span class="w">      </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span><span class="p">);</span><span class="w"> </span><span class="c1">// Payload</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">isTraceEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Describe the packet</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&gt; Packet [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]: &quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Flush to ensure bytes are available immediately</span><span class="w"></span>
<span class="w">      </span><span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * &lt;p&gt;Format a KeepKey protobuf message as a byte buffer filled with HID packets&lt;/p&gt;</span>
<span class="cm">   *</span>
<span class="cm">   * @param message The KeepKey protobuf message</span>
<span class="cm">   *</span>
<span class="cm">   * @return A byte buffer containing a set of HID packets</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="nf">formatAsHIDPackets</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">msgSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getSerializedSize</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">msgName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getSimpleName</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">msgId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">MessageType</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="s">&quot;MessageType_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msgName</span><span class="p">).</span><span class="na">getNumber</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// There is a security risk to raising this logging level beyond trace</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;&gt; Message: {}, ({} bytes)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ToStringBuilder</span><span class="p">.</span><span class="na">reflectionToString</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KeepKeyMessageToStringStyle</span><span class="p">()),</span><span class="w"> </span><span class="n">msgSize</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Create the header</span><span class="w"></span>
<span class="w">    </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">messageBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">allocate</span><span class="p">(</span><span class="mi">32768</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Marker bytes</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">((</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="sc">&#39;#&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">((</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="sc">&#39;#&#39;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Header code</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">((</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">msgId</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">((</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">msgId</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Message size</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">((</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">msgSize</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">((</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">msgSize</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">((</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">msgSize</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">((</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">msgSize</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Message payload</span><span class="w"></span>
<span class="w">    </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Packet padding</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">position</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">((</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">messageBuffer</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * &lt;p&gt;Parse the contents of the input stream into a KeepKey protobuf message&lt;/p&gt;</span>
<span class="cm">   *</span>
<span class="cm">   * @param in The input stream containing KeepKey HID packets</span>
<span class="cm">   *</span>
<span class="cm">   * @return The adapted Core message</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">MessageEvent</span><span class="w"> </span><span class="nf">parseAsHIDPackets</span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">messageBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">allocate</span><span class="p">(</span><span class="mi">32768</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">MessageType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">msgSize</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">received</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Keep reading until synchronized on &quot;##&quot;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">64</span><span class="o">]</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">received</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">received</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;Read buffer is closed&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// There is a security risk to raising this logging level beyond trace</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;&lt; {} bytes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">received</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">KeepKeyMessageUtils</span><span class="p">.</span><span class="na">logPacket</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">received</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Synchronize the buffer on start of new message (&#39;?&#39; is ASCII 63)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="sc">&#39;?&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="sc">&#39;#&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="sc">&#39;#&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Reject packet</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Evaluate the header information (short, int)</span><span class="w"></span>
<span class="w">      </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessage</span><span class="p">.</span><span class="na">MessageType</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="n">buffer</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">msgSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">buffer</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">buffer</span><span class="o">[</span><span class="mi">6</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">buffer</span><span class="o">[</span><span class="mi">7</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="mi">8</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Treat remainder of packet as the protobuf message payload</span><span class="w"></span>
<span class="w">      </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// There is a security risk to raising this logging level beyond trace</span><span class="w"></span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;&lt; Type: &#39;{}&#39; Message size: &#39;{}&#39; bytes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">.</span><span class="na">name</span><span class="p">(),</span><span class="w"> </span><span class="n">msgSize</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">position</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">msgSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">64</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">received</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">packet</span><span class="o">++</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// There is a security risk to raising this logging level beyond trace</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&quot;&lt; (cont) {} bytes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">received</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">KeepKeyMessageUtils</span><span class="p">.</span><span class="na">logPacket</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="sc">&#39;?&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;&lt; Malformed packet length. Expected: &#39;3f&#39; Actual: &#39;{}&#39;. Ignoring.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Append the packet payload to the message buffer</span><span class="w"></span>
<span class="w">      </span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Packet complete&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Parse the message</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KeepKeyMessageUtils</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">copyOfRange</span><span class="p">(</span><span class="n">messageBuffer</span><span class="p">.</span><span class="na">array</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">msgSize</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * @param requestedTx The requested tx</span>
<span class="cm">   *</span>
<span class="cm">   * @return A KeepKey transaction type containing an overall description of the current transaction</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TransactionType</span><span class="w"> </span><span class="nf">buildTxMetaResponse</span><span class="p">(</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestedTx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inputCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestedTx</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getInputs</span><span class="p">().</span><span class="na">size</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TxOutputBinType and TxOutputType counts are the same so ignore hash flag</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">outputCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestedTx</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getOutputs</span><span class="p">().</span><span class="na">size</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Provide details about the requested transaction</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TransactionType</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setVersion</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">requestedTx</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getVersion</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setLockTime</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">requestedTx</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getLockTime</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setInputsCnt</span><span class="p">(</span><span class="n">inputCount</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setOutputsCnt</span><span class="p">(</span><span class="n">outputCount</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * @param txRequest               The KeepKey request</span>
<span class="cm">   * @param requestedTx             The requested tx (either current or a previous one providing inputs)</span>
<span class="cm">   * @param binOutputType           True if the requested tx is a parent (the receiving address map does not apply)</span>
<span class="cm">   * @param receivingAddressPathMap A map of paths for rapid address lookup (called AddressN in KeepKey protobuf)</span>
<span class="cm">   *</span>
<span class="cm">   * @return A KeepKey transaction type containing a description of an input</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TransactionType</span><span class="w"> </span><span class="nf">buildTxInputResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">TxRequest</span><span class="w"> </span><span class="n">txRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestedTx</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">binOutputType</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">ImmutableList</span><span class="o">&lt;</span><span class="n">ChildNumber</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">receivingAddressPathMap</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">txRequest</span><span class="p">.</span><span class="na">getTxRequestDetailsType</span><span class="p">().</span><span class="na">getRequestIndex</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">requestIndex</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Request index is not present for TxInput&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Get the transaction input indicated by the request index</span><span class="w"></span>
<span class="w">    </span><span class="n">TransactionInput</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestedTx</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getInput</span><span class="p">(</span><span class="n">requestIndex</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addressN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">binOutputType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// We are the current transaction so look up the path of the receiving address</span><span class="w"></span>
<span class="w">      </span><span class="n">ImmutableList</span><span class="o">&lt;</span><span class="n">ChildNumber</span><span class="o">&gt;</span><span class="w"> </span><span class="n">receivingAddressPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receivingAddressPathMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">requestIndex</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">Preconditions</span><span class="p">.</span><span class="na">checkNotNull</span><span class="p">(</span><span class="n">receivingAddressPath</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The receiving address path has no entry for index &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">requestIndex</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;. Signing will fail.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">addressN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyMessageUtils</span><span class="p">.</span><span class="na">buildAddressN</span><span class="p">(</span><span class="n">receivingAddressPath</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Must be OK to be here</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Build a TxInputType message</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">prevIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">getOutpoint</span><span class="p">().</span><span class="na">getIndex</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">prevHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">getOutpoint</span><span class="p">().</span><span class="na">getHash</span><span class="p">().</span><span class="na">getBytes</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// No multisig support in MBHD yet</span><span class="w"></span>
<span class="w">    </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">InputScriptType</span><span class="w"> </span><span class="n">inputScriptType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">InputScriptType</span><span class="p">.</span><span class="na">SPENDADDRESS</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TxInputType</span><span class="w"> </span><span class="n">txInputType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TxInputType</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">addAllAddressN</span><span class="p">(</span><span class="n">addressN</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setSequence</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">getSequenceNumber</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setScriptSig</span><span class="p">(</span><span class="n">ByteString</span><span class="p">.</span><span class="na">copyFrom</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="na">getScriptSig</span><span class="p">().</span><span class="na">getProgram</span><span class="p">()))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setScriptType</span><span class="p">(</span><span class="n">inputScriptType</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setPrevIndex</span><span class="p">(</span><span class="n">prevIndex</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">setPrevHash</span><span class="p">(</span><span class="n">ByteString</span><span class="p">.</span><span class="na">copyFrom</span><span class="p">(</span><span class="n">prevHash</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TransactionType</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">addInputs</span><span class="p">(</span><span class="n">txInputType</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * @param txRequest            The KeepKey request</span>
<span class="cm">   * @param requestedTx          The requested tx (either current or a previous one providing inputs)</span>
<span class="cm">   * @param changeAddressPathMap A map of paths for rapid address lookup (called AddressN in KeepKey protobuf)</span>
<span class="cm">   *</span>
<span class="cm">   * @return A KeepKey transaction type containing a description of an output</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TransactionType</span><span class="w"> </span><span class="nf">buildTxOutputResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">TxRequest</span><span class="w"> </span><span class="n">txRequest</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestedTx</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">binOutputType</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="n">ImmutableList</span><span class="o">&lt;</span><span class="n">ChildNumber</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">changeAddressPathMap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">Preconditions</span><span class="p">.</span><span class="na">checkNotNull</span><span class="p">(</span><span class="n">changeAddressPathMap</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&#39;changeAddressPathMap&#39; must be present&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">txRequest</span><span class="p">.</span><span class="na">getTxRequestDetailsType</span><span class="p">().</span><span class="na">getRequestIndex</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">requestIndex</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Request index is not present for TxOutput&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Get the transaction output indicated by the request index</span><span class="w"></span>
<span class="w">    </span><span class="n">TransactionOutput</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestedTx</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getOutput</span><span class="p">(</span><span class="n">requestIndex</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">binOutputType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Build a TxOutputBinType representing a previous transaction</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Require the output script program</span><span class="w"></span>
<span class="w">      </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">scriptPubKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="na">getScriptPubKey</span><span class="p">().</span><span class="na">getProgram</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TxOutputBinType</span><span class="w"> </span><span class="n">txOutputBinType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TxOutputBinType</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">setAmount</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">value</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">setScriptPubkey</span><span class="p">(</span><span class="n">ByteString</span><span class="p">.</span><span class="na">copyFrom</span><span class="p">(</span><span class="n">scriptPubKey</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TransactionType</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">addBinOutputs</span><span class="p">(</span><span class="n">txOutputBinType</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Build a TxOutputType representing the current transaction</span><span class="w"></span>

<span class="w">    </span><span class="c1">// P2PKH are the most common addresses so try that first</span><span class="w"></span>
<span class="w">    </span><span class="n">Address</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="na">getAddressFromP2PKHScript</span><span class="p">(</span><span class="n">MainNetParams</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Fall back to P2SH</span><span class="w"></span>
<span class="w">      </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="na">getAddressFromP2SH</span><span class="p">(</span><span class="n">MainNetParams</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;TxOutput &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">requestIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; does not resolve to P2PKH or P2SH.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Is it pay-to-script-hash (P2SH) or pay-to-address (P2PKH)?</span><span class="w"></span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">OutputScriptType</span><span class="w"> </span><span class="n">outputScriptType</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="na">isP2SHAddress</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">outputScriptType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">OutputScriptType</span><span class="p">.</span><span class="na">PAYTOSCRIPTHASH</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">outputScriptType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">OutputScriptType</span><span class="p">.</span><span class="na">PAYTOADDRESS</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TxOutputType</span><span class="w"> </span><span class="n">txOutputType</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Check for change addresses</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">changeAddressPathMap</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">address</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="n">Iterable</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addressN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buildAddressN</span><span class="p">(</span><span class="n">changeAddressPathMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">address</span><span class="p">));</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Known change address so it won&#39;t trigger a sign confirmation</span><span class="w"></span>
<span class="w">      </span><span class="n">txOutputType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TxOutputType</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">addAllAddressN</span><span class="p">(</span><span class="n">addressN</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">setAmount</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">value</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">setScriptType</span><span class="p">(</span><span class="n">outputScriptType</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Unknown address so can expect a sign confirmation</span><span class="w"></span>
<span class="w">      </span><span class="n">txOutputType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TxOutputType</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">setAddress</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">address</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">setAmount</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">value</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">setScriptType</span><span class="p">(</span><span class="n">outputScriptType</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KeepKeyType</span><span class="p">.</span><span class="na">TransactionType</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">addOutputs</span><span class="p">(</span><span class="n">txOutputType</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>


<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * &lt;p&gt;Build an AddressN chain code structure&lt;/p&gt;</span>
<span class="cm">   *</span>
<span class="cm">   * @param account    The plain account number (0 gives maximum compatibility)</span>
<span class="cm">   * @param keyPurpose The key purpose (RECEIVE_FUNDS,CHANGE,REFUND,AUTHENTICATION etc)</span>
<span class="cm">   * @param index      The plain index of the required address</span>
<span class="cm">   *</span>
<span class="cm">   * @return The list representing the chain code (only a simple chain is currently supported)</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">buildAddressN</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">account</span><span class="p">,</span><span class="w"> </span><span class="n">KeyChain</span><span class="p">.</span><span class="na">KeyPurpose</span><span class="w"> </span><span class="n">keyPurpose</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">keyPurposeAddressN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">keyPurpose</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">RECEIVE_FUNDS</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">REFUND</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">keyPurposeAddressN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">CHANGE</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">AUTHENTICATION</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">keyPurposeAddressN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="mi">44</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ChildNumber</span><span class="p">.</span><span class="na">HARDENED_BIT</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">ChildNumber</span><span class="p">.</span><span class="na">HARDENED_BIT</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">account</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ChildNumber</span><span class="p">.</span><span class="na">HARDENED_BIT</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">keyPurposeAddressN</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">index</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * &lt;p&gt;Build an AddressN chain code structure&lt;/p&gt;</span>
<span class="cm">   *</span>
<span class="cm">   * @param receivingAddressPath The Bitcoinj receiving address path</span>
<span class="cm">   *</span>
<span class="cm">   * @return The list representing the chain code (only a simple chain is currently supported)</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">buildAddressN</span><span class="p">(</span><span class="n">ImmutableList</span><span class="o">&lt;</span><span class="n">ChildNumber</span><span class="o">&gt;</span><span class="w"> </span><span class="n">receivingAddressPath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addressN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ChildNumber</span><span class="w"> </span><span class="n">childNumber</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">receivingAddressPath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">addressN</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">childNumber</span><span class="p">.</span><span class="na">getI</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">addressN</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</body>
</html>
